{
  int port=getFreePort();
  DispatchQueue queue=Dispatch.createQueue();
  ServerInvokerImpl server=new ServerInvokerImpl("tcp://localhost:" + port,queue);
  server.start();
  ClientInvokerImpl client=new ClientInvokerImpl(queue);
  client.start();
  try {
    server.registerService("service-id",new ServerInvoker.ServiceFactory(){
      public Object get(){
        return new HelloImpl();
      }
      public void unget(){
      }
    }
,HelloImpl.class.getClassLoader());
    InvocationHandler handler=client.getProxy("tcp://localhost:" + port,"service-id",HelloImpl.class.getClassLoader());
    Hello hello=(Hello)Proxy.newProxyInstance(HelloImpl.class.getClassLoader(),new Class[]{Hello.class},handler);
    assertEquals("Hello Fabric!",hello.hello("Fabric"));
  }
  finally {
    server.stop();
    client.stop();
  }
}
