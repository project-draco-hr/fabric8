{
  System.out.println(executeCommand("fabric:create -n"));
  System.out.println(executeCommand("fabric:profile-list"));
  ServiceProxy<FabricService> fabricProxy=ServiceProxy.createServiceProxy(bundleContext,FabricService.class);
  try {
    FabricService fabricService=fabricProxy.getService();
    AdminService adminService=ServiceLocator.awaitService(bundleContext,AdminService.class);
    String version=System.getProperty("fabric.version");
    System.out.println(executeCommand("admin:create --featureURL mvn:io.fabric8/fabric8-karaf/" + version + "/xml/features --feature fabric-git --feature fabric-agent --feature fabric-boot-commands child1"));
    System.out.println(executeCommand("admin:create --featureURL mvn:io.fabric8/fabric8-karaf/" + version + "/xml/features --feature fabric-git --feature fabric-agent --feature fabric-boot-commands child2"));
    try {
      System.out.println(executeCommand("admin:start child1"));
      System.out.println(executeCommand("admin:start child2"));
      Provision.instanceStarted(bundleContext,Arrays.asList("child1","child2"),PROVISION_TIMEOUT);
      System.out.println(executeCommand("admin:list"));
      String joinCommand="fabric:join -f --zookeeper-password " + fabricService.getZookeeperPassword() + " "+ fabricService.getZookeeperUrl();
      String response="";
      for (int i=0; i < 10 && !response.contains("true"); i++) {
        response=executeCommand("ssh -l admin -P admin -p " + adminService.getInstance("child1").getSshPort() + " localhost "+ WAIT_FOR_JOIN_SERVICE);
        Thread.sleep(1000);
      }
      response="";
      for (int i=0; i < 10 && !response.contains("true"); i++) {
        response=executeCommand("ssh -l admin -P admin -p " + adminService.getInstance("child2").getSshPort() + " localhost "+ WAIT_FOR_JOIN_SERVICE);
        Thread.sleep(1000);
      }
      System.out.println(executeCommand("ssh -l admin -P admin -p " + adminService.getInstance("child1").getSshPort() + " localhost "+ joinCommand));
      System.out.println(executeCommand("ssh -l admin -P admin -p " + adminService.getInstance("child2").getSshPort() + " localhost "+ joinCommand));
      Provision.containersExist(bundleContext,Arrays.asList("child1","child2"),PROVISION_TIMEOUT);
      Container child1=ContainerProxy.wrap(fabricService.getContainer("child1"),fabricProxy);
      Container child2=ContainerProxy.wrap(fabricService.getContainer("child2"),fabricProxy);
      Provision.containersStatus(Arrays.asList(child1,child2),"success",PROVISION_TIMEOUT);
      addToEnsemble(fabricService,child1,child2);
      System.out.println(tryCommand("fabric:container-list"));
      removeFromEnsemble(fabricService,child1,child2);
      System.out.println(tryCommand("fabric:container-list"));
    }
  finally {
      System.out.println(executeCommand("admin:stop child1"));
      System.out.println(executeCommand("admin:stop child2"));
    }
  }
  finally {
    fabricProxy.close();
  }
}
