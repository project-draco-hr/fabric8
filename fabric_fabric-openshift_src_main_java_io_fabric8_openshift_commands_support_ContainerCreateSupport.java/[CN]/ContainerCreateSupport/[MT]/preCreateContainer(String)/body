{
  FabricValidations.validateContainerName(name);
  if (!isEnsembleServer) {
    ServiceReference sr=getBundleContext().getServiceReference(ZooKeeperClusterService.class.getName());
    ZooKeeperClusterService zkcs=sr != null ? getService(ZooKeeperClusterService.class,sr) : null;
    if (zkcs == null) {
      throw new IllegalStateException("Unable to find ZooKeeperClusterService service");
    }
    if (zkcs.getEnsembleContainers().isEmpty()) {
      if (!isEnsembleServer) {
        throw new IllegalStateException("The use of the --ensemble-server option is mandatory when creating an initial container");
      }
      return;
    }
    if (doesContainerExist(fabricService,name)) {
      throw new IllegalArgumentException("A container with name " + name + " already exists.");
    }
    ProfileService profileService=fabricService.adapt(ProfileService.class);
    Version version=versionId != null ? profileService.getRequiredVersion(versionId) : fabricService.getRequiredDefaultVersion();
    List<Profile> profiles=version.getProfiles();
    Set<String> names=getProfileNames();
    for (    String profile : names) {
      Profile prof=getProfile(profiles,profile,version);
      if (prof == null) {
        throw new IllegalArgumentException("Profile " + profile + " with version "+ version.getId()+ " does not exist.");
      }
      if (prof.isAbstract()) {
        throw new IllegalArgumentException("Profile " + profile + " with version "+ version.getId()+ " is abstract and can not be associated to containers.");
      }
    }
  }
  if (!isEnsembleServer && fabricService.getZookeeperUrl() == null) {
    throw new IllegalArgumentException("Either start a zookeeper ensemble or use --ensemble-server.");
  }
}
