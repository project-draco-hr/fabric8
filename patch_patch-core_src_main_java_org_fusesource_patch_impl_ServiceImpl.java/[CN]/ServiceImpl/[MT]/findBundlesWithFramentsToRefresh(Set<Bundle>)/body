{
  for (  Bundle b : toRefresh) {
    if (b.getState() != Bundle.UNINSTALLED) {
      String hostHeader=(String)b.getHeaders().get(Constants.FRAGMENT_HOST);
      if (hostHeader != null) {
        Clause[] clauses=Parser.parseHeader(hostHeader);
        if (clauses != null && clauses.length > 0) {
          Clause path=clauses[0];
          for (          Bundle hostBundle : bundleContext.getBundles()) {
            if (hostBundle.getSymbolicName().equals(path.getName())) {
              String ver=path.getAttribute(Constants.BUNDLE_VERSION_ATTRIBUTE);
              if (ver != null) {
                VersionRange v=VersionRange.parseVersionRange(ver);
                if (v.contains(hostBundle.getVersion())) {
                  toRefresh.add(hostBundle);
                }
              }
 else {
                toRefresh.add(hostBundle);
              }
            }
          }
        }
      }
    }
  }
}
