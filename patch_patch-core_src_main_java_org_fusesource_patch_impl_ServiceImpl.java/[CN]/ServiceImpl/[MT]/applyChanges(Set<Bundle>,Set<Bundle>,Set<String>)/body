{
  for (  Bundle bundle : toDelete) {
    bundle.uninstall();
    toRefresh.add(bundle);
  }
  for (  String url : toInstall) {
    Bundle bundle=bundleContext.installBundle(url);
    toRefresh.add(bundle);
  }
  findBundlesWithOptionalPackagesToRefresh(toRefresh);
  findBundlesWithFramentsToRefresh(toRefresh);
  if (!toRefresh.isEmpty()) {
    final CountDownLatch l=new CountDownLatch(1);
    FrameworkListener listener=new FrameworkListener(){
      @Override public void frameworkEvent(      FrameworkEvent event){
        l.countDown();
      }
    }
;
    FrameworkWiring wiring=(FrameworkWiring)bundleContext.getBundle(0).adapt(FrameworkWiring.class);
    wiring.refreshBundles((Collection<Bundle>)toRefresh,new FrameworkListener[]{listener});
    try {
      l.await();
    }
 catch (    InterruptedException e) {
      throw new PatchException("Bundle refresh interrupted",e);
    }
  }
}
