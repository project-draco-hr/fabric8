{
  Pair<T,ServiceRegistration> pair=services.get(pid);
  if (pair != null) {
    try {
      T t=doUpdate(pair.getFirst(),properties);
      pair.setFirst(t);
      pair.getSecond().setProperties(properties);
    }
 catch (    Throwable throwable) {
      internalDelete(pid);
      LOGGER.warn("Error updating service for ManagedServiceFactory " + getName(),throwable);
    }
  }
 else {
    if (destroyed.get()) {
      return;
    }
    try {
      T t=doCreate(properties);
      try {
        if (destroyed.get()) {
          throw new IllegalStateException("ManagedServiceFactory has been destroyed");
        }
        ServiceRegistration registration=context.registerService(getExposedClasses(t),t,properties);
        services.put(pid,new Pair<T,ServiceRegistration>(t,registration));
      }
 catch (      Throwable throwable1) {
        try {
          doDestroy(t);
        }
 catch (        Throwable throwable2) {
        }
        throw throwable1;
      }
    }
 catch (    Throwable throwable) {
      if (!destroyed.get()) {
        LOGGER.warn("Error creating service for ManagedServiceFactory " + getName(),throwable);
      }
    }
  }
}
