{
  current_batch--;
  println("Messages left in batch : %s, left overall : %s",current_batch,count - current_count);
  if (current_batch > 0 && !(current_count >= count)) {
    message.onPut(new Runnable(){
      public void run(){
        sendMessage(session,sender,current_count + 1);
      }
    }
);
  }
 else {
    current_batch=batch_size;
    message.onAck(new Runnable(){
      public void run(){
        sendMessage(session,sender,current_count + 1);
      }
    }
);
  }
  if (current_count >= count) {
    message.onAck(new Runnable(){
      public void run(){
        sender.detach();
      }
    }
);
  }
}
