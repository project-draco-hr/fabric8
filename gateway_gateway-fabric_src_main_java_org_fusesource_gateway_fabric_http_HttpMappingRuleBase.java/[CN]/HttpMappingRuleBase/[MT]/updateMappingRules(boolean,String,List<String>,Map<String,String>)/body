{
  SimplePathTemplate pathTemplate=getUriTemplate();
  if (pathTemplate != null) {
    boolean versionSpecificUri=pathTemplate.getParameterNames().contains("version");
    String versionId=defaultParams.get("version");
    if (!remove && versionId != null && !versionSpecificUri && gatewayVersion != null) {
      if (!gatewayVersion.equals(versionId)) {
        remove=true;
      }
    }
    Map<String,String> params=new HashMap<String,String>();
    if (defaultParams != null) {
      params.putAll(defaultParams);
    }
    params.put("servicePath",path);
    for (    String service : services) {
      HttpMappingRuleConfiguration.populateUrlParams(params,service);
      String fullPath=pathTemplate.bindByNameNonStrict(params);
      if (remove) {
        MappedServices rule=mappingRules.get(fullPath);
        if (rule != null) {
          Set<String> serviceUrls=rule.getServiceUrls();
          serviceUrls.remove(service);
          if (serviceUrls.isEmpty()) {
            mappingRules.remove(fullPath);
          }
        }
      }
 else {
        MappedServices mappedServices=new MappedServices(service);
        MappedServices oldRule=mappingRules.put(fullPath,mappedServices);
        if (oldRule != null) {
          mappedServices.getServiceUrls().addAll(oldRule.getServiceUrls());
        }
      }
    }
  }
}
