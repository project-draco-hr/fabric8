{
  assertValid();
  try {
    stopBundles();
    BootstrapConfiguration bootConfig=bootstrapConfiguration.get();
    String connectionUrl=bootConfig.getConnectionUrl(options);
    registrationHandler.get().setRegistrationCallback(new DataStoreBootstrapTemplate(bootConfig,connectionUrl,options));
    bootConfig.createOrUpdateDataStoreConfig(options);
    bootConfig.createZooKeeeperServerConfig(options);
    bootConfig.createZooKeeeperClientConfig(connectionUrl,options);
    startBundles(options);
    if (options.isWaitForProvision() && options.isAgentEnabled()) {
      String karafName=bootConfig.getProperty(SystemProperties.KARAF_NAME);
      waitForSuccessfulDeploymentOf(karafName,options.getProvisionTimeout());
    }
  }
 catch (  RuntimeException rte) {
    throw rte;
  }
catch (  Exception ex) {
    throw new FabricException("Unable to create zookeeper server configuration",ex);
  }
}
