{
  List<String> currentCache=new ArrayList<String>();
  currentCache.addAll(contextPathsCache);
  try {
    ServiceList serviceList=client.getServices();
    for (    Service service1 : serviceList.getItems()) {
      Map<String,String> selector=getSelector(service1);
      if (selectorMatch(selector)) {
        String contextPath=KubernetesHelper.getName(service1);
        if (apiManager != null) {
          String apiManagerServiceInfo[]=apiManager.getService().getApiManagerServiceInfo(contextPath);
          if (apiManagerServiceInfo == null) {
            if (LOG.isDebugEnabled())             LOG.debug("Service is not registered in the API Manager, and is therefore not yet available");
            break;
          }
        }
        ServiceDTO dto=new ServiceDTO();
        dto.setId(KubernetesHelper.getName(service1));
        dto.setContainer(selector.get("container"));
        dto.setVersion(selector.get("version"));
        Map<String,String> params=new HashMap<String,String>();
        params.put("id",paramValue(dto.getId()));
        params.put("container",paramValue(dto.getContainer()));
        params.put("version",paramValue(dto.getVersion()));
        String service="http://localhost:" + getPort(service1) + "/"+ KubernetesHelper.getName(service1);
        List<String> services=Arrays.asList(service);
        if (!contextPathsCache.contains(contextPath)) {
          LOG.info("Adding " + service);
          contextPathsCache.add(contextPath);
        }
        mappingRuleConfiguration.updateMappingRules(false,contextPath,services,params,dto);
        currentCache.remove(contextPath);
      }
    }
    for (    String contextPath : currentCache) {
      mappingRuleConfiguration.updateMappingRules(true,contextPath,null,null,null);
      LOG.info("Removing " + contextPath);
      contextPathsCache.remove(contextPath);
    }
  }
 catch (  Throwable e) {
    e.printStackTrace();
  }
}
