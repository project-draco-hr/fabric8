{
  List<String> currentCache=new ArrayList<String>();
  currentCache.addAll(contextPathsCache);
  try {
    ServiceList serviceList=client.getServices();
    for (    Service service1 : serviceList.getItems()) {
      ServiceSpec spec=service1.getSpec();
      if (spec != null && selectorMatch(spec.getSelector())) {
        String contextPath=getId(service1);
        ServiceDTO dto=new ServiceDTO();
        dto.setId(getId(service1));
        dto.setContainer(spec.getSelector().get("container"));
        dto.setVersion(spec.getSelector().get("version"));
        Map<String,String> params=new HashMap<String,String>();
        params.put("id",paramValue(dto.getId()));
        params.put("container",paramValue(dto.getContainer()));
        params.put("version",paramValue(dto.getVersion()));
        String service="http://localhost:" + spec.getPort() + "/"+ getId(service1);
        List<String> services=Arrays.asList(service);
        if (!contextPathsCache.contains(contextPath)) {
          LOG.info("Adding " + service);
          contextPathsCache.add(contextPath);
        }
        mappingRuleConfiguration.updateMappingRules(false,contextPath,services,params,dto);
        currentCache.remove(contextPath);
      }
    }
    for (    String contextPath : currentCache) {
      mappingRuleConfiguration.updateMappingRules(true,contextPath,null,null,null);
      LOG.info("Removing " + contextPath);
      contextPathsCache.remove(contextPath);
    }
  }
 catch (  Throwable e) {
    e.printStackTrace();
  }
}
