{
  String oldName=runtimeProperties.getProperty(SystemProperties.KARAF_NAME);
  if (containerName == null) {
    containerName=oldName;
  }
  if (resolver != null) {
    runtimeProperties.setProperty(ZkDefs.LOCAL_RESOLVER_PROPERTY,resolver);
  }
  if (manualIp != null) {
    runtimeProperties.setProperty(ZkDefs.MANUAL_IP,manualIp);
  }
  if (bindAddress != null) {
    runtimeProperties.setProperty(ZkDefs.BIND_ADDRESS,bindAddress);
  }
  zookeeperPassword=zookeeperPassword != null ? zookeeperPassword : ShellUtils.retrieveFabricZookeeperPassword(session);
  if (zookeeperPassword == null) {
    zookeeperPassword=promptForZookeeperPassword();
  }
  if (zookeeperPassword == null || zookeeperPassword.isEmpty()) {
    System.out.println("No password specified. Cannot join fabric ensemble.");
    return null;
  }
  ShellUtils.storeZookeeperPassword(session,zookeeperPassword);
  log.debug("Encoding ZooKeeper password.");
  String encodedPassword=PasswordEncoder.encode(zookeeperPassword);
  runtimeProperties.setProperty(ZkDefs.MINIMUM_PORT,String.valueOf(minimumPort));
  runtimeProperties.setProperty(ZkDefs.MAXIMUM_PORT,String.valueOf(maximumPort));
  if (!containerName.equals(oldName)) {
    if (force || permissionToRenameContainer()) {
      if (!registerContainer(containerName,zookeeperPassword,profile,force)) {
        System.err.println("A container with the name: " + containerName + " is already member of the cluster. You can specify a different name as an argument.");
        return null;
      }
      runtimeProperties.setProperty(SystemProperties.KARAF_NAME,containerName);
      runtimeProperties.setProperty("zookeeper.password",encodedPassword);
      runtimeProperties.setProperty("zookeeper.url",zookeeperUrl);
      String karafEtc=runtimeProperties.getProperty(SystemProperties.KARAF_ETC);
      File file=new File(karafEtc,"system.properties");
      Properties props=new Properties(file);
      props.put(SystemProperties.KARAF_NAME,containerName);
      props.put("zookeeper.url",zookeeperUrl);
      props.put("zookeeper.password",encodedPassword);
      props.save();
      if (!nonManaged) {
        installBundles();
      }
      System.setProperty("karaf.restart","true");
      System.setProperty("karaf.restart.clean","false");
      bundleContext.getBundle(0).stop();
      return null;
    }
 else {
      return null;
    }
  }
 else {
    if (!registerContainer(containerName,zookeeperPassword,profile,force)) {
      System.err.println("A container with the name: " + containerName + " is already member of the cluster. You can specify a different name as an argument.");
      return null;
    }
    Configuration config=configurationAdmin.getConfiguration(Constants.ZOOKEEPER_CLIENT_PID);
    Hashtable<String,Object> properties=new Hashtable<String,Object>();
    properties.put("zookeeper.url",zookeeperUrl);
    properties.put("zookeeper.password",PasswordEncoder.encode(encodedPassword));
    config.setBundleLocation(null);
    config.update(properties);
    if (!nonManaged) {
      installBundles();
    }
    return null;
  }
}
