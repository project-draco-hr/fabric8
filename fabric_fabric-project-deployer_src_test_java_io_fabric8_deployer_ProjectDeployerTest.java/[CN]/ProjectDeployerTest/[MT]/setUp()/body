{
  URL.setURLStreamHandlerFactory(new CustomBundleURLStreamHandlerFactory());
  basedir=System.getProperty("basedir",".");
  String karafRoot=basedir + "/target/karaf";
  System.setProperty("karaf.root",karafRoot);
  System.setProperty("karaf.data",karafRoot + "/data");
  sfb=new ZKServerFactoryBean();
  delete(sfb.getDataDir());
  delete(sfb.getDataLogDir());
  sfb.setPort(9123);
  sfb.afterPropertiesSet();
  int zkPort=sfb.getClientPortAddress().getPort();
  LOG.info("Connecting to ZK on port: " + zkPort);
  CuratorFrameworkFactory.Builder builder=CuratorFrameworkFactory.builder().connectString("localhost:" + zkPort).retryPolicy(new RetryOneTime(1000)).connectionTimeoutMs(360000);
  curator=builder.build();
  curator.start();
  curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
  File root=new File(basedir + "/target/git").getCanonicalFile();
  delete(root);
  new File(root,"remote").mkdirs();
  remote=Git.init().setDirectory(new File(root,"remote")).call();
  remote.commit().setMessage("First Commit").setCommitter("fabric","user@fabric").call();
  String remoteUrl="file://" + new File(root,"remote").getCanonicalPath();
  new File(root,"local").mkdirs();
  git=Git.init().setDirectory(new File(root,"local")).call();
  git.commit().setMessage("First Commit").setCommitter("fabric","user@fabric").call();
  StoredConfig config=git.getRepository().getConfig();
  config.setString("remote","origin","url",remoteUrl);
  config.setString("remote","origin","fetch","+refs/heads/*:refs/remotes/origin/*");
  config.save();
  DefaultRuntimeProperties runtimeProperties=new DefaultRuntimeProperties();
  runtimeProperties.setProperty(SystemProperties.KARAF_DATA,"target/data");
  runtimeProperties.setProperty(SystemProperties.KARAF_NAME,"root");
  FabricGitServiceImpl gitService=new FabricGitServiceImpl();
  gitService.bindRuntimeProperties(runtimeProperties);
  gitService.activate();
  gitService.setGitForTesting(git);
  DataStoreTemplateRegistry registrationHandler=new DataStoreTemplateRegistry();
  registrationHandler.activateComponent();
  dataStore=new CachingGitDataStore();
  dataStore.bindCurator(curator);
  dataStore.bindGitService(gitService);
  dataStore.bindRegistrationHandler(registrationHandler);
  dataStore.bindRuntimeProperties(runtimeProperties);
  dataStore.bindConfigurer(new Configurer(){
    @Override public <T>void configure(    Map<String,?> configuration,    T target) throws Exception {
    }
  }
);
  Map<String,String> datastoreProperties=new HashMap<String,String>();
  datastoreProperties.put(GitDataStore.GIT_REMOTE_URL,remoteUrl);
  dataStore.activate(datastoreProperties);
  fabricService=new FabricServiceImpl();
  fabricService.bindDataStore(dataStore);
  fabricService.bindRuntimeProperties(runtimeProperties);
  fabricService.bindPlaceholderResolver(new DummyPlaceholerResolver("port"));
  fabricService.bindPlaceholderResolver(new DummyPlaceholerResolver("zk"));
  fabricService.bindPlaceholderResolver(new ProfilePropertyPointerResolver());
  fabricService.bindPlaceholderResolver(new ChecksumPlaceholderResolver());
  fabricService.bindPlaceholderResolver(new VersionPropertyPointerResolver());
  fabricService.activateComponent();
  projectDeployer=new ProjectDeployerImpl();
  projectDeployer.bindFabricService(fabricService);
  projectDeployer.bindMBeanServer(ManagementFactory.getPlatformMBeanServer());
  String defaultVersion=dataStore.getDefaultVersion();
  assertEquals("defaultVersion","1.0",defaultVersion);
  String importPath=basedir + "/../fabric8-karaf/src/main/resources/distro/fabric/import";
  assertFolderExists(importPath);
  dataStore.importFromFileSystem(importPath);
  assertHasVersion(defaultVersion);
}
