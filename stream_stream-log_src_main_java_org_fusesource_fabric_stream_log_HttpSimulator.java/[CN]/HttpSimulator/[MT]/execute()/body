{
  Thread.currentThread().setPriority(Thread.MAX_PRIORITY);
  ArrayList<ProducerContext> contexts=new ArrayList<ProducerContext>(producers);
  CountDownLatch started=new CountDownLatch(producers);
  for (int i=0; i < producers; i++) {
    ProducerContext ctx=new ProducerContext(i,started);
    contexts.add(ctx);
    ctx.start();
  }
  started.await();
  System.out.println(format("Warming up for %,d seconds before sampling",warmupTime));
  sleep(warmupTime * 1000);
  for (int i=0; i < producers; i++) {
    contexts.get(i).counter.set(0);
  }
  while (!done.get()) {
    System.out.println(format("Sampling for %,d seconds...",sampleTime));
    sleep(sampleTime * 1000);
    DescriptiveStatistics samples=new DescriptiveStatistics();
    samples.setWindowSize(producers);
    for (int i=0; i < producers; i++) {
      ProducerContext producer=contexts.get(i);
      samples.addValue(producer.counter.getAndSet(0));
      producer.changeRate();
    }
    System.out.println(Arrays.toString(samples.getValues()));
    double scale=1.0 / sampleTime;
    System.out.println(format("avg producer rate=%,.2f events/sec, sd=%,.2f, total messages produced in the last sample: %.0f",samples.getMean() * scale,samples.getStandardDeviation() * scale,samples.getSum()));
  }
}
