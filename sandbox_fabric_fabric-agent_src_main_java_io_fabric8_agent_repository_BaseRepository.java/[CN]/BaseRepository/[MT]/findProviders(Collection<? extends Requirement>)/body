{
  Map<Requirement,Collection<Capability>> result=new HashMap<Requirement,Collection<Capability>>();
  for (  Requirement requirement : requirements) {
    CapabilitySet set=capSets.get(requirement.getNamespace());
    if (set != null) {
      SimpleFilter sf;
      if (requirement instanceof RequirementImpl) {
        sf=((RequirementImpl)requirement).getFilter();
      }
 else {
        String filter=requirement.getDirectives().get(Constants.FILTER_DIRECTIVE);
        sf=(filter != null) ? SimpleFilter.parse(filter) : new SimpleFilter(null,null,SimpleFilter.MATCH_ALL);
      }
      result.put(requirement,set.match(sf,true));
    }
 else {
      result.put(requirement,Collections.<Capability>emptyList());
    }
  }
  return result;
}
