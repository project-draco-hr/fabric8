{
  final int max=1000000;
  final AtomicLong i=new AtomicLong(0);
  final CountDownLatch latch=new CountDownLatch(1);
  Executors.newSingleThreadExecutor().execute(new Runnable(){
    public void run(){
      while (i.incrementAndGet() < max) {
        Transfer in=new Transfer();
        in.setDeliveryTag(new Buffer(("" + i.get()).getBytes()));
        in.setDeliveryID(i.get() + 1);
        in.setHandle(0L);
        in.setMessageFormat(0L);
        try {
          Transfer out=writeRead(in);
          in.toString().equals(out.toString());
        }
 catch (        Exception e) {
          latch.countDown();
          e.printStackTrace();
          return;
        }
      }
      latch.countDown();
    }
  }
);
  int last=0;
  while (latch.await(5,TimeUnit.SECONDS) == false) {
    int sample=i.intValue() - last;
    last=last + sample;
    System.out.println("msgs/s : " + (sample / 5));
  }
  Assert.assertTrue(i.get() == max);
}
