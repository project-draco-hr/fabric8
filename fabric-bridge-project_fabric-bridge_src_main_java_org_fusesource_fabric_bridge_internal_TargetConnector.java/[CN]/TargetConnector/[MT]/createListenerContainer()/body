{
  final DispatchPolicy dispatchPolicy=inboundDestinations.getDispatchPolicy();
  if (LOG.isDebugEnabled()) {
    LOG.debug("Using delivery policy: " + dispatchPolicy);
  }
  final AbstractDeliveryHandler deliveryHandler=createDeliveryHandler(dispatchPolicy);
  if (dispatchPolicy.getBatchSize() <= 0 || dispatchPolicy.getBatchTimeout() <= 0) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Creating default message listener container");
    }
    listenerContainer=new DefaultMessageListenerContainer();
    configureListenerContainer((DefaultMessageListenerContainer)listenerContainer,dispatchPolicy,remoteBrokerConfig == null,(remoteBrokerConfig == null ? localBrokerConfig.getDestinationResolver() : remoteBrokerConfig.getDestinationResolver()));
    listenerContainer.setMessageListener(deliveryHandler);
  }
 else {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Creating batch message listener container");
    }
    listenerContainer=new BatchMessageListenerContainer();
    configureListenerContainer((BatchMessageListenerContainer)listenerContainer,dispatchPolicy,remoteBrokerConfig == null,(remoteBrokerConfig == null ? localBrokerConfig.getDestinationResolver() : remoteBrokerConfig.getDestinationResolver()));
    ((BatchMessageListenerContainer)listenerContainer).setBatchMessageListener(deliveryHandler);
  }
  listenerContainer.setConnectionFactory(remoteConnectionFactory);
  listenerContainer.setDestinationName(inboundDestinations.getStagingQueueName());
  listenerContainer.setMessageSelector(dispatchPolicy.getMessageSelector());
  listenerContainer.setClientId((remoteBrokerConfig != null) ? remoteBrokerConfig.getClientId() : localBrokerConfig.getClientId());
  listenerContainer.afterPropertiesSet();
}
