{
  Long ver=Long.parseLong(map.getMetadata().getResourceVersion());
  String pid=map.getMetadata().getLabels().get(pidLabel);
  String[] p=parsePid(pid);
  try {
    final Configuration config=getConfiguration(configAdmin.get(),pid,p[0],p[1]);
    final Map<String,String> configMapData=map.getData();
    if (configMapData == null) {
      LOGGER.debug("Ignoring configuration pid={}, (empty)",config.getPid());
      return;
    }
    final Dictionary<String,Object> props=config.getProperties();
    final Hashtable<String,Object> configAdminOldCfg=props != null ? new Hashtable<String,Object>() : null;
    Hashtable<String,Object> configAdminCfg=new Hashtable<>();
    String pidCfg=configMapData.get(FABRIC8_CONFIG_PID_CFG);
    if (pidCfg == null) {
      pidCfg=pid + ".cfg";
    }
    String cfgString=configMapData.get(pidCfg);
    if (Utils.isNotNullOrEmpty(cfgString)) {
      java.util.Properties cfg=new java.util.Properties();
      cfg.load(new StringReader(cfgString));
      for (      Map.Entry<Object,Object> entry : cfg.entrySet()) {
        configAdminCfg.put((String)entry.getKey(),entry.getValue());
      }
    }
 else {
      for (      Map.Entry<String,String> entry : map.getData().entrySet()) {
        configAdminCfg.put(entry.getKey(),entry.getValue());
      }
    }
    String meta=configMapData.get(FABRIC8_CONFIG_META);
    if (meta == null) {
      meta=configMeta;
    }
    String merge=configMapData.get(FABRIC8_CONFIG_MERGE);
    if (merge == null) {
      merge=configMerge;
    }
    if (configAdminOldCfg != null) {
      Long oldVer=(Long)props.get(FABRIC8_K8S_META_RESOURCE_VERSION);
      if (oldVer != null && oldVer.equals(ver)) {
        LOGGER.debug("Ignoring configuration pid={}, resourceVersion={} (no changes)",config.getPid(),oldVer);
        return;
      }
      for (Enumeration<String> e=props.keys(); e.hasMoreElements(); ) {
        String key=e.nextElement();
        Object val=props.get(key);
        configAdminOldCfg.put(key,val);
      }
    }
    cleanDictionaryMeta(configAdminOldCfg);
    cleanDictionaryMeta(configAdminCfg);
    if (!configAdminCfg.equals(configAdminOldCfg)) {
      LOGGER.debug("Updating configuration pid={}",config.getPid());
      if ("true".equals(meta)) {
        configAdminCfg.put(FABRIC8_PID,pid);
        configAdminCfg.put(FABRIC8_K8S_META_RESOURCE_VERSION,ver);
        configAdminCfg.put(FABRIC8_K8S_META_NAME,map.getMetadata().getName());
        configAdminCfg.put(FABRIC8_K8S_META_NAMESPACE,map.getMetadata().getNamespace());
      }
      if ("true".equals(merge) && configAdminOldCfg != null) {
        configAdminOldCfg.putAll(configAdminCfg);
        configAdminCfg=configAdminOldCfg;
      }
      config.update(configAdminCfg);
    }
 else {
      LOGGER.debug("Ignoring configuration pid={} (no changes)",config.getPid());
    }
  }
 catch (  Exception e) {
    LOGGER.warn("",e);
  }
}
