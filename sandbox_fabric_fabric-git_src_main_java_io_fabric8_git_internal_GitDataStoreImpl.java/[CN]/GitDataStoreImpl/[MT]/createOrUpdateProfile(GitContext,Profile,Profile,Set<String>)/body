{
  assertWriteLock();
  String versionId=profile.getVersion();
  String profileId=profile.getId();
  if (!profiles.contains(profileId)) {
    for (    String parentId : profile.getParentIds()) {
      Profile parent=getProfileFromCache(profile.getVersion(),parentId);
      IllegalStateAssertion.assertNotNull(parent,"Parent profile does not exist: " + parentId);
    }
    if (lastProfile == null) {
      LOGGER.debug("Create {}",Profiles.getProfileInfo(profile));
    }
 else {
      LOGGER.debug("Update {}",profile);
      LOGGER.debug("Update {}",Profiles.getProfileDifference(lastProfile,profile));
    }
    if (lastProfile == null) {
      createProfileDirectoryAfterCheckout(context,versionId,profileId);
    }
    Map<String,byte[]> fileConfigurations=profile.getFileConfigurations();
    setFileConfigurations(context,versionId,profileId,fileConfigurations);
    if (context.getCommitMessage().length() == 0) {
      context.commitMessage("WARNING - Profile with no content: " + versionId + "/"+ profileId);
    }
    profiles.add(profileId);
  }
  return profileId;
}
