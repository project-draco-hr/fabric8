{
  try {
    IZKClient client;
    Properties properties;
    String karafName=System.getProperty("karaf.name");
    Bundle bundleFabricConfigAdmin=installOrStopBundle("org.fusesource.fabric.fabric-configadmin","mvn:org.fusesource.fabric/fabric-configadmin/" + FabricConstants.FABRIC_VERSION);
    Bundle bundleFabricZooKeeper=installOrStopBundle("org.fusesource.fabric.fabric-zookeeper","mvn:org.fusesource.fabric/fabric-zookeeper/" + FabricConstants.FABRIC_VERSION);
    String connectionUrl=getLocalHostAddress() + ":" + Integer.toString(port);
    String mavenProxyUrl="http://" + getLocalHostAddress() + ":"+ 8040;
    Configuration config=configurationAdmin.createFactoryConfiguration("org.fusesource.fabric.zookeeper.server");
    properties=new Properties();
    properties.put("tickTime","2000");
    properties.put("initLimit","10");
    properties.put("syncLimit","5");
    properties.put("dataDir","data/zookeeper/0000");
    properties.put("clientPort",Integer.toString(port));
    properties.put("fabric.zookeeper.pid","org.fusesource.fabric.zookeeper.server-0000");
    config.setBundleLocation(null);
    config.update(properties);
    config=configurationAdmin.getConfiguration("org.fusesource.fabric.zookeeper");
    properties=new Properties();
    properties.put("zookeeper.url",connectionUrl);
    properties.put("fabric.zookeeper.pid","org.fusesource.fabric.zookeeper");
    config.setBundleLocation(null);
    config.update(properties);
    bundleFabricZooKeeper.start();
    ServiceTracker tracker=new ServiceTracker(bundleContext,IZKClient.class.getName(),null);
    tracker.open();
    client=(IZKClient)tracker.waitForService(5000);
    if (client == null) {
      throw new IllegalStateException("Timeout waiting for ZooKeeper client to be registered");
    }
    tracker.close();
    String autoImportFrom=System.getProperty(PROFILES_AUTOIMPORT_PATH);
    if (autoImportFrom != null) {
      ZookeeperImportUtils.importFromFileSystem(client,autoImportFrom,"/",null,null,false,false,false);
    }
    String defaultProfile=ZkPath.CONFIG_VERSIONS_PROFILE.getPath(version,"default");
    setConfigProperty(client,defaultProfile + "/org.fusesource.fabric.zookeeper.properties","zookeeper.url","${zk:" + karafName + "/ip}:"+ Integer.toString(port));
    String profileNode=ZkPath.CONFIG_VERSIONS_PROFILE.getPath(version,"zk-server-0000") + "/org.fusesource.fabric.zookeeper.server-0000.properties";
    Properties p=new Properties();
    p.put("tickTime","2000");
    p.put("initLimit","10");
    p.put("syncLimit","5");
    p.put("dataDir","data/zookeeper/0000");
    ZooKeeperUtils.set(client,profileNode,toString(p));
    ZooKeeperUtils.set(client,ZkPath.CONFIG_VERSIONS_PROFILE.getPath(version,"zk-server-0000-1"),"zk-server-0000");
    profileNode=ZkPath.CONFIG_VERSIONS_PROFILE.getPath(version,"zk-server-0000-1") + "/org.fusesource.fabric.zookeeper.server-0000.properties";
    p=new Properties();
    p.put("clientPort","2181");
    ZooKeeperUtils.set(client,profileNode,toString(p));
    ZooKeeperUtils.set(client,"/fabric/configs/versions/" + version + "/general/zookeeper-cluster","0000");
    ZooKeeperUtils.set(client,"/fabric/configs/versions/" + version + "/general/zookeeper-cluster/0000",karafName);
    p=getProperties(client,defaultProfile + "/org.fusesource.fabric.agent.properties",new Properties());
    p.put("org.ops4j.pax.url.mvn.defaultRepositories","file:${karaf.home}/${karaf.default.repository}@snapshots");
    p.put("org.ops4j.pax.url.mvn.repositories","http://repo1.maven.org/maven2,http://repo.fusesource.com/nexus/content/repositories/releases,http://scala-tools.org/repo-releases");
    p.put("repository.fabric","mvn:org.fusesource.fabric/fuse-fabric/" + FabricConstants.FABRIC_VERSION + "/xml/features");
    p.put("feature.karaf","karaf");
    p.put("feature.fabric-agent","fabric-agent");
    p.put("feature.fabric-core","fabric-core");
    p.put("feature.fabric-jaas","fabric-jaas");
    ZooKeeperUtils.set(client,defaultProfile + "/org.fusesource.fabric.agent.properties",toString(p));
    String fabricProfile=ZkPath.CONFIG_VERSIONS_PROFILE.getPath(version,"fabric");
    ZooKeeperUtils.createDefault(client,fabricProfile,"default");
    p=getProperties(client,fabricProfile + "/org.fusesource.fabric.agent.properties",new Properties());
    p.put("feature.fabric-commands","fabric-commands");
    ZooKeeperUtils.set(client,fabricProfile + "/org.fusesource.fabric.agent.properties",toString(p));
    ZooKeeperUtils.createDefault(client,ZkPath.CONFIG_CONTAINER.getPath(karafName),version);
    ZooKeeperUtils.createDefault(client,ZkPath.CONFIG_VERSIONS_CONTAINER.getPath(version,karafName),"fabric zk-server-0000-1");
    ZooKeeperUtils.createDefault(client,defaultProfile + "/org.fusesource.fabric.jaas/encryption.enabled","${zk:/fabric/authentication/encryption.enabled}");
    ZooKeeperUtils.createDefault(client,"/fabric/authentication/encryption.enabled","true");
    ZooKeeperUtils.createDefault(client,"/fabric/authentication/domain","karaf");
    ZooKeeperUtils.createDefault(client,"/fabric/authentication/users","admin={CRYPT}21232f297a57a5a743894a0e4a801fc3{CRYPT},admin\nsystem={CRYPT}1d0258c2440a8d19e716292b231e3190{CRYPT},admin");
    ZooKeeperUtils.createDefault(client,ZkPath.CONFIGS_MAVEN_REPO.getPath(),mavenProxyUrl);
    bundleFabricConfigAdmin.start();
  }
 catch (  Exception e) {
    throw new FabricException("Unable to create zookeeper server configuration",e);
  }
}
