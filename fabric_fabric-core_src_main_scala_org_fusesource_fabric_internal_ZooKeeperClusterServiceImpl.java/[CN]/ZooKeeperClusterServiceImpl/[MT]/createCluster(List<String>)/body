{
  try {
    if (agents == null || agents.size() == 2) {
      throw new IllegalArgumentException("One or at least 3 agents must be used to create a zookeeper cluster");
    }
    Configuration config=configurationAdmin.getConfiguration("org.fusesource.fabric.zookeeper",null);
    String zooKeeperUrl=config != null && config.getProperties() != null ? (String)config.getProperties().get("zookeeper.url") : null;
    if (zooKeeperUrl == null) {
      if (agents.size() != 1 || !agents.get(0).equals(System.getProperty("karaf.name"))) {
        throw new FabricException("The first zookeeper cluster must be configured on this agent only.");
      }
      createLocalServer();
      return;
    }
    String url=getSubstitutedData("/fabric/configs/versions/" + version + "/profiles/default/org.fusesource.fabric.zookeeper.properties#zookeeper.url");
    if (!url.equals(zooKeeperUrl)) {
      throw new IllegalStateException("The zookeeper configuration is not properly backed in the zookeeper tree.");
    }
    for (    String agent : agents) {
      if (zooKeeper.exists("/fabric/registry/agents/alive/" + agent) == null) {
        throw new FabricException("The agent " + agent + " is not alive");
      }
    }
    Map<String,List<Integer>> usedPorts=new HashMap<String,List<Integer>>();
    String oldClusterId=ZooKeeperUtils.get(zooKeeper,"/fabric/configs/versions/" + version + "/general/zookeeper-cluster");
    if (oldClusterId != null) {
      Properties p=toProperties(zooKeeper.getStringData("/fabric/configs/versions/" + version + "/profiles/zk-server-"+ oldClusterId+ "/org.fusesource.fabric.zookeeper.server-"+ oldClusterId+ ".properties"));
      for (      Object n : p.keySet()) {
        String node=(String)n;
        if (node.startsWith("server.")) {
          String data=getSubstitutedData("/fabric/configs/versions/" + version + "/profiles/zk-server-"+ oldClusterId+ "/org.fusesource.fabric.zookeeper.server-"+ oldClusterId+ ".properties#"+ node);
          addUsedPorts(usedPorts,data);
        }
      }
      String datas=getSubstitutedData("/fabric/configs/versions/" + version + "/profiles/default/org.fusesource.fabric.zookeeper.properties#zookeeper.url");
      for (      String data : datas.split(",")) {
        addUsedPorts(usedPorts,data);
      }
    }
    String newClusterId;
    if (oldClusterId == null) {
      newClusterId="0000";
    }
 else {
      newClusterId=new DecimalFormat("0000").format(Integer.parseInt(oldClusterId) + 1);
    }
    String profileNode="/fabric/configs/versions/" + version + "/profiles/zk-server-"+ newClusterId+ "/org.fusesource.fabric.zookeeper.server-"+ newClusterId+ ".properties";
    Properties profileNodeProperties=new Properties();
    profileNodeProperties.put("tickTime","2000");
    profileNodeProperties.put("initLimit","10");
    profileNodeProperties.put("syncLimit","5");
    profileNodeProperties.put("dataDir","data/zookeeper/" + newClusterId);
    int index=1;
    String connectionUrl="";
    String realConnectionUrl="";
    String agentList="";
    for (    String agent : agents) {
      String ip=zooKeeper.getStringData("/fabric/registry/agents/config/" + agent + "/ip");
      String profNode="/fabric/configs/versions/" + version + "/profiles/zk-server-"+ newClusterId+ "-"+ Integer.toString(index);
      String pidNode=profNode + "/org.fusesource.fabric.zookeeper.server-" + newClusterId+ ".profile";
      Properties pidNodeProperties=new Properties();
      ZooKeeperUtils.add(zooKeeper,profNode,"zk-server-" + newClusterId);
      String port1=Integer.toString(findPort(usedPorts,ip,2181));
      if (agents.size() > 1) {
        String port2=Integer.toString(findPort(usedPorts,ip,2888));
        String port3=Integer.toString(findPort(usedPorts,ip,3888));
        profileNodeProperties.put("server." + Integer.toString(index),"${zk:" + agent + "/ip}:"+ port2+ ":"+ port3);
        pidNodeProperties.put("server.id",Integer.toString(index));
      }
      pidNodeProperties.put("clientPort",port1);
      ZooKeeperUtils.set(zooKeeper,pidNode,toString(pidNodeProperties));
      ZooKeeperUtils.add(zooKeeper,"/fabric/configs/versions/" + version + "/agents/"+ agent,"zk-server-" + newClusterId + "-"+ Integer.toString(index));
      if (connectionUrl.length() > 0) {
        connectionUrl+=",";
        realConnectionUrl+=",";
      }
      connectionUrl+="${zk:" + agent + "/ip}:"+ port1;
      realConnectionUrl+=ip + ":" + port1;
      if (agentList.length() > 0) {
        agentList+=",";
      }
      agentList+=agent;
      index++;
    }
    ZooKeeperUtils.set(zooKeeper,profileNode,toString(profileNodeProperties));
    if (oldClusterId != null) {
      ZKClient src=new ZKClient(zooKeeperUrl,Timespan.ONE_MINUTE,null);
      ZKClient dst=new ZKClient(realConnectionUrl,Timespan.ONE_MINUTE,null);
      try {
        src.start();
        dst.start();
        src.waitForStart(new Timespan(5,Timespan.TimeUnit.SECOND));
        dst.waitForStart(new Timespan(5,Timespan.TimeUnit.SECOND));
        ZooKeeperUtils.copy(src,dst,"/fabric/configs");
        ZooKeeperUtils.set(dst,"/fabric/configs/versions/" + version + "/general/zookeeper-cluster",newClusterId);
        ZooKeeperUtils.set(dst,"/fabric/configs/versions/" + version + "/general/zookeeper-cluster/"+ newClusterId,agentList);
        for (        String agent : dst.getChildren("/fabric/configs/versions/" + version + "/agents")) {
          ZooKeeperUtils.remove(dst,"/fabric/configs/versions/" + version + "/agents/"+ agent,"zk-server-" + oldClusterId + "-.*");
        }
        setConfigProperty(dst,"/fabric/configs/versions/" + version + "/profiles/default/org.fusesource.fabric.zookeeper.properties","zookeeper.url",connectionUrl);
        setConfigProperty(src,"/fabric/configs/versions/" + version + "/profiles/default/org.fusesource.fabric.zookeeper.properties","zookeeper.url",connectionUrl);
      }
  finally {
        src.destroy();
        dst.destroy();
      }
    }
  }
 catch (  Exception e) {
    throw new FabricException("Unable to create zookeeper quorum: " + e.getMessage(),e);
  }
}
