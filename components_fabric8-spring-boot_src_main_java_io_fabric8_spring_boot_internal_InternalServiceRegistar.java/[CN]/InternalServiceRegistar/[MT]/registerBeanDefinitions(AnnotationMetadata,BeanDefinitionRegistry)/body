{
  Map<String,String> env=System.getenv();
  for (  Map.Entry<String,String> entry : env.entrySet()) {
    String key=entry.getKey();
    Matcher matcher=SERVICE_HOST_PATTERN.matcher(key);
    if (matcher.matches()) {
      String service=matcher.group(SERVICE);
      if (areEnvVariablesAvailable(service,env)) {
        RootBeanDefinition beanDefinition=new RootBeanDefinition(Service.class);
        String serviceHost=env.get(service + HOST_SUFFIX);
        String port=env.get(service + PORT_SUFFIX);
        String protocol=env.get(service + PORT_SUFFIX + "_"+ port+ PROTO_SUFFIX);
        Service s=new ServiceBuilder().withNewMetadata().withName(service).endMetadata().withNewSpec().withPortalIP(serviceHost).addNewPort().withNewTargetPort(port).withProtocol(protocol).endPort().endSpec().build();
        beanDefinition.addQualifier(new AutowireCandidateQualifier(ServiceName.class,service));
        beanDefinition.getPropertyValues().addPropertyValue("metadata",s.getMetadata());
        beanDefinition.getPropertyValues().addPropertyValue("spec",s.getSpec());
        beanDefinition.getPropertyValues().addPropertyValue("kind","Service");
        registry.registerBeanDefinition(service + "-service-bean",beanDefinition);
      }
    }
  }
}
