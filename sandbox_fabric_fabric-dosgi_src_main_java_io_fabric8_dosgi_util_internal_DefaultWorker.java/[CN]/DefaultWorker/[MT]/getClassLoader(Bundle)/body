{
  ClassLoader cl=get(b);
  if (cl != null)   return cl;
  String activator=(String)b.getHeaders().get(Constants.BUNDLE_ACTIVATOR);
  if (activator != null) {
    try {
      Class<?> clazz=b.loadClass(activator);
      Bundle activatorBundle=FrameworkUtil.getBundle(clazz);
      if (activatorBundle == b) {
        cl=clazz.getClassLoader();
      }
    }
 catch (    ClassNotFoundException e) {
    }
  }
  if (cl == null) {
    cl=AccessController.doPrivileged(new PrivilegedAction<ClassLoader>(){
      public ClassLoader run(){
        return new BundleToClassLoaderAdapter(b);
      }
    }
);
  }
  if (cl != null) {
    setupListener(b);
    cl=put(b,cl);
  }
  return cl;
}
