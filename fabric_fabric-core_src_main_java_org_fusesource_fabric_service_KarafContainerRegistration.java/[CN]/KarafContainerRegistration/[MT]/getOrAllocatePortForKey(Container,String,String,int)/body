{
  Configuration config=configurationAdmin.getConfiguration(pid);
  Set<Integer> unavailable=fabricService.getPortService().findUsedPortByHost(container);
  int port=fabricService.getPortService().lookupPort(container,pid,key);
  if (port > 0) {
    return port;
  }
 else   if (config.getProperties() != null && config.getProperties().get(key) != null) {
    try {
      port=Integer.parseInt((String)config.getProperties().get(key));
    }
 catch (    NumberFormatException ex) {
      port=defaultValue;
    }
  }
 else {
    port=defaultValue;
  }
  while (unavailable.contains(port)) {
    port++;
  }
  return port;
}
