{
  PooledConnectionFactory connectionFactory=new PooledConnectionFactory(brokerUrl);
  JmsTemplate jmsTemplate=new JmsTemplate(connectionFactory);
  jmsTemplate.setReceiveTimeout(TEST_TIMEOUT * 1000L);
  int nMessages=0;
  for (int i=0; i < numMessages; i++) {
    Message message=jmsTemplate.receive(destinationName);
    if (message == null) {
      break;
    }
    if (matcher != null && !matcher.matches(message)) {
      fail("Unexpected message " + message);
    }
    nMessages++;
  }
  connectionFactory.stop();
  assertEquals("Number of received messages on " + destinationName + " do not match",numMessages,nMessages);
}
