{
  ProfileService profileService=fabricService.adapt(ProfileService.class);
  Map<String,Map<String,String>> answer=new HashMap<String,Map<String,String>>();
  Version version=null;
  if (versionId == null) {
    version=fabricService.getDefaultVersion();
  }
 else {
    version=profileService.getRequiredVersion(versionId);
  }
  String prefix=pid + "-";
  String postfix=".properties";
  if (profileIds != null) {
    for (    String profileId : profileIds) {
      Profile profile=version.getRequiredProfile(profileId);
      Profile overlay=profileService.getOverlayProfile(profile);
      Set<String> configurationFileNames=overlay.getConfigurationFileNames();
      for (      String fileName : configurationFileNames) {
        if (fileName.startsWith(prefix) && fileName.endsWith(postfix)) {
          String name=fileName.substring(prefix.length(),fileName.length() - postfix.length());
          Map<String,String> overlayConfig=answer.get(name);
          if (overlayConfig == null) {
            overlayConfig=new HashMap<String,String>();
            answer.put(name,overlayConfig);
          }
          String filePid=fileName.substring(0,fileName.length() - postfix.length());
          Map<String,String> profileConfig=overlay.getConfiguration(filePid);
          if (profileConfig != null) {
            overlayConfig.putAll(profileConfig);
          }
        }
      }
    }
  }
  return answer;
}
