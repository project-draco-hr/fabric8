{
  List<Agent> agents=new JmxTemplate().execute(parent,new JmxTemplate.JmxConnectorCallback<List<Agent>>(){
    @Override public List<Agent> doWithJmxConnector(    JMXConnector connector) throws Exception {
      List<Agent> agents=new ArrayList<Agent>();
      MBeanServerConnection connection=connector.getMBeanServerConnection();
      for (      String domain : connection.getDomains()) {
        if ("osgi.core".equals(domain)) {
          agents.add(new OSGiAgentImpl(parent,parent.getId(),service));
        }
 else         if ("org.apache.camel".equals(domain)) {
          Set<ObjectName> names=connection.queryNames(new ObjectName("org.apache.camel:type=context,*"),null);
          for (          ObjectName name : names) {
            agents.add(new CamelAgentImpl(parent,name.getKeyProperty("context"),service));
          }
        }
 else         if ("org.apache.servicemix.nmr".equals(domain)) {
        }
 else         if ("org.apache.activemq".equals(domain)) {
        }
      }
      return agents;
    }
  }
);
  return agents.toArray(new Agent[agents.size()]);
}
