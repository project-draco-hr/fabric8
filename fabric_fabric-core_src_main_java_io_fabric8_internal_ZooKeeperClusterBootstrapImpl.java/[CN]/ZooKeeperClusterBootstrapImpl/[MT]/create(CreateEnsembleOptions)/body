{
  assertValid();
  try {
    ServiceLocator.awaitService(bundleContext,BootstrapComplete.class);
    LOGGER.info("Create fabric with: {}",options);
    stopBundles();
    DataStoreRegistrationHandler regHandler=registrationHandler.get();
    BootstrapConfiguration bootConfig=bootstrapConfiguration.get();
    BundleContext syscontext=bundleContext.getBundle(0).getBundleContext();
    if (options.isClean()) {
      bootConfig=cleanInternal(syscontext,bootConfig,regHandler);
    }
    BootstrapCreateHandler createHandler=new BootstrapCreateHandler(bootConfig,regHandler);
    createHandler.bootstrapFabric(name,home,options);
    startBundles(options);
    long startTime=System.currentTimeMillis();
    createHandler.waitForContainerAlive(name,syscontext,options.getBootstrapTimeout());
    if (options.isWaitForProvision() && options.isAgentEnabled()) {
      long currentTime=System.currentTimeMillis();
      createHandler.waitForSuccessfulDeploymentOf(name,syscontext,options.getBootstrapTimeout() - (currentTime - startTime));
    }
  }
 catch (  RuntimeException rte) {
    throw rte;
  }
catch (  Exception ex) {
    throw new FabricException("Unable to create zookeeper server configuration",ex);
  }
}
