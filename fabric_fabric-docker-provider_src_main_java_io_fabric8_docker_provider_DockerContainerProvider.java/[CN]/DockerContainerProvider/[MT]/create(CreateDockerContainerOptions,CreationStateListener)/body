{
  assertValid();
  ContainerConfig containerConfig=options.createContainerConfig();
  Set<String> profiles=options.getProfiles();
  String versionId=options.getVersion();
  FabricService service=fabricService.get();
  Map<String,String> configOverlay=new HashMap<String,String>();
  if (profiles != null && versionId != null) {
    Version version=service.getVersion(versionId);
    if (version != null) {
      for (      String profileId : profiles) {
        Profile profile=version.getProfile(profileId);
        if (profile != null) {
          Profile overlay=profile.getOverlay();
          Map<String,String> dockerConfig=overlay.getConfiguration(DockerConstants.DOCKER_PROVIDER_PID);
          if (dockerConfig != null) {
            configOverlay.putAll(dockerConfig);
          }
        }
      }
    }
  }
  String image=containerConfig.getImage();
  if (Strings.isEmpty(image)) {
    image=configOverlay.get(DockerConstants.PROPERTIES.IMAGE);
    if (Strings.isEmpty(image)) {
      image=DockerConstants.DEFAULT_IMAGE;
    }
    containerConfig.setImage(image);
  }
  String[] cmd=containerConfig.getCmd();
  if (cmd == null || cmd.length == 0) {
    String value=configOverlay.get(DockerConstants.PROPERTIES.CMD);
    if (Strings.isEmpty(value)) {
      cmd=null;
    }
 else {
      cmd=new String[]{value};
    }
    containerConfig.setCmd(cmd);
  }
  String zookeeperUrl=service.getZookeeperUrl();
  String zookeeperPassword=service.getZookeeperPassword();
  if (!options.isEnsembleServer()) {
    List<String> env=containerConfig.getEnv();
    if (env == null) {
      env=new ArrayList<String>();
    }
    env.addAll(Arrays.asList("FABRIC8_ZOOKEEPER_URL",zookeeperUrl,"FABRIC8_ZOOKEEPER_PASSWORD",zookeeperPassword));
    containerConfig.setEnv(env);
  }
  LOG.info("Creating container: " + containerConfig + " on docker "+ getDockerAddress());
  ContainerCreateStatus status=docker.containerCreate(containerConfig);
  LOG.info("Got status: " + status);
  CreateDockerContainerMetadata metadata=CreateDockerContainerMetadata.newInstance(containerConfig,status);
  metadata.setCreateOptions(options);
  startDockerContainer(status.getId());
  return metadata;
}
