{
  assertValid();
  ContainerConfig containerConfig=options.createContainerConfig();
  Set<String> profiles=options.getProfiles();
  String versionId=options.getVersion();
  FabricService service=fabricService.get();
  Map<String,String> configOverlay=new HashMap<String,String>();
  Map<String,String> envVarsOverlay=new HashMap<String,String>();
  if (profiles != null && versionId != null) {
    Version version=service.getVersion(versionId);
    if (version != null) {
      for (      String profileId : profiles) {
        Profile profile=version.getProfile(profileId);
        if (profile != null) {
          Profile overlay=profile.getOverlay();
          Map<String,String> dockerConfig=overlay.getConfiguration(DockerConstants.DOCKER_PROVIDER_PID);
          if (dockerConfig != null) {
            configOverlay.putAll(dockerConfig);
          }
          Map<String,String> envVars=overlay.getConfiguration(DockerConstants.ENVIRONMENT_VARIABLES_PID);
          if (envVars != null) {
            envVarsOverlay.putAll(envVars);
          }
        }
      }
    }
  }
  String image=containerConfig.getImage();
  if (Strings.isEmpty(image)) {
    image=configOverlay.get(DockerConstants.PROPERTIES.IMAGE);
    if (Strings.isEmpty(image)) {
      image=DockerConstants.DEFAULT_IMAGE;
    }
    containerConfig.setImage(image);
  }
  String[] cmd=containerConfig.getCmd();
  if (cmd == null || cmd.length == 0) {
    String value=configOverlay.get(DockerConstants.PROPERTIES.CMD);
    if (Strings.isEmpty(value)) {
      cmd=null;
    }
 else {
      cmd=new String[]{value};
    }
    containerConfig.setCmd(cmd);
  }
  String zookeeperUrl=service.getZookeeperUrl();
  String zookeeperPassword=service.getZookeeperPassword();
  String localIp=service.getCurrentContainer().getLocalIp();
  if (!Strings.isEmpty(localIp)) {
    int idx=zookeeperUrl.lastIndexOf(':');
    if (idx > 0) {
      localIp+=zookeeperUrl.substring(idx);
    }
    zookeeperUrl=localIp;
  }
  envVarsOverlay.put(DockerConstants.ENV_VARS.KARAF_NAME,options.getName());
  if (!options.isEnsembleServer()) {
    if (envVarsOverlay.get(DockerConstants.ENV_VARS.ZOOKEEPER_URL) == null) {
      envVarsOverlay.put(DockerConstants.ENV_VARS.ZOOKEEPER_URL,zookeeperUrl);
    }
    if (envVarsOverlay.get(DockerConstants.ENV_VARS.ZOOKEEPER_PASSWORD) == null) {
      envVarsOverlay.put(DockerConstants.ENV_VARS.ZOOKEEPER_PASSWORD,zookeeperPassword);
    }
  }
  List<String> env=containerConfig.getEnv();
  if (env == null) {
    env=new ArrayList<String>();
  }
  Set<Map.Entry<String,String>> entries=envVarsOverlay.entrySet();
  for (  Map.Entry<String,String> entry : entries) {
    String key=entry.getKey();
    String value=entry.getValue();
    if (key != null && value != null) {
      env.add(key + "=" + value);
    }
  }
  containerConfig.setEnv(env);
  LOG.info("Creating container: " + containerConfig + " on docker "+ getDockerAddress()+ " with env vars: "+ envVarsOverlay);
  ContainerCreateStatus status=docker.containerCreate(containerConfig);
  LOG.info("Got status: " + status);
  CreateDockerContainerMetadata metadata=CreateDockerContainerMetadata.newInstance(containerConfig,status);
  metadata.setCreateOptions(options);
  startDockerContainer(status.getId());
  return metadata;
}
