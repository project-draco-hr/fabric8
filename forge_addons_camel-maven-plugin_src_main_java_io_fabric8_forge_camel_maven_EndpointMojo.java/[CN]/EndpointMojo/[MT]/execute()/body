{
  CamelCatalog catalog=new DefaultCamelCatalog();
  catalog.setSuggestionStrategy(new LuceneSuggestionStrategy());
  List<CamelEndpointDetails> endpoints=new ArrayList<>();
  Set<File> javaFiles=new LinkedHashSet<File>();
  Set<File> xmlFiles=new LinkedHashSet<File>();
  if (includeJava) {
    for (    String dir : project.getCompileSourceRoots()) {
      findJavaFiles(new File(dir),javaFiles);
    }
    if (includeTest) {
      for (      String dir : project.getTestCompileSourceRoots()) {
        findJavaFiles(new File(dir),javaFiles);
      }
    }
  }
  if (includeXml) {
    for (    Resource dir : project.getResources()) {
      findXmlFiles(new File(dir.getDirectory()),xmlFiles);
    }
    if (includeTest) {
      for (      Resource dir : project.getTestResources()) {
        findXmlFiles(new File(dir.getDirectory()),xmlFiles);
      }
    }
  }
  for (  File file : javaFiles) {
    if (matchFile(file)) {
      try {
        String fqn=file.getPath();
        String baseDir=".";
        JavaType out=Roaster.parse(file);
        if (out != null && out instanceof JavaClassSource) {
          JavaClassSource clazz=(JavaClassSource)out;
          RouteBuilderParser.parseRouteBuilder(clazz,baseDir,fqn,endpoints);
        }
      }
 catch (      Exception e) {
        getLog().warn("Error parsing java file " + file + " code due "+ e.getMessage(),e);
      }
    }
  }
  for (  File file : xmlFiles) {
    if (matchFile(file)) {
      try {
        String fqn=file.getPath();
        String baseDir=".";
        InputStream is=new FileInputStream(file);
        XmlRouteParser.parseXmlRoute(is,baseDir,fqn,endpoints);
        is.close();
      }
 catch (      Exception e) {
        getLog().warn("Error parsing xml file " + file + " code due "+ e.getMessage(),e);
      }
    }
  }
  int errors=0;
  for (  CamelEndpointDetails detail : endpoints) {
    EndpointValidationResult result=catalog.validateEndpointProperties(detail.getEndpointUri());
    if (!result.isSuccess()) {
      errors++;
      StringBuilder sb=new StringBuilder();
      sb.append("Endpoint validation error in file: ").append(asRelativeFile(detail.getFileName()));
      if (detail.getLineNumber() != null) {
        sb.append(" at line: ").append(detail.getLineNumber());
      }
      sb.append("\n\n");
      String out=result.summaryErrorMessage(false);
      sb.append(out);
      sb.append("\n\n");
      getLog().warn(sb.toString());
    }
  }
  String summary;
  if (errors == 0) {
    int ok=endpoints.size() - errors;
    summary=String.format("Endpoint validation success: (%s = passed, %s = invalid)",ok,errors);
  }
 else {
    int ok=endpoints.size() - errors;
    summary=String.format("Endpoint validation error: (%s = passed, %s = invalid)",ok,errors);
  }
  if (failOnError && errors > 0) {
    throw new MojoExecutionException(summary);
  }
  if (errors > 0) {
    getLog().warn(summary);
  }
 else {
    getLog().info(summary);
  }
}
