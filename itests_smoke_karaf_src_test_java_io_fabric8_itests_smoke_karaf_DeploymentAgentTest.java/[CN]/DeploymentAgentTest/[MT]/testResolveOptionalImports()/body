{
  CommandSupport.executeCommand("fabric:create --force --clean -n");
  CommandSupport.executeCommand("fabric:profile-create --parents default test-profile");
  CommandSupport.executeCommand("fabric:profile-edit --pid io.fabric8.agent/resolve.optional.imports=true test-profile");
  CommandSupport.executeCommand("fabric:profile-edit --features spring-struts test-profile");
  ModuleContext moduleContext=RuntimeLocator.getRequiredRuntime().getModuleContext();
  ServiceProxy<FabricService> fabricProxy=ServiceProxy.createServiceProxy(moduleContext,FabricService.class);
  try {
    FabricService fabricService=fabricProxy.getService();
    Set<Container> containers=ContainerBuilder.create().withName("smoke.cntB").withProfiles("test-profile").assertProvisioningResult().build(fabricService);
    try {
      String command="fabric:container-connect -u admin -p admin " + containers.iterator().next().getId() + " osgi:list -s | grep org.apache.servicemix.bundles.struts";
      String result=CommandSupport.executeCommand(command);
      assertTrue("Result contains struts, but was: " + result,result.contains("org.apache.servicemix.bundles.struts"));
    }
  finally {
      ContainerBuilder.stop(fabricService,containers);
    }
  }
  finally {
    fabricProxy.close();
  }
}
