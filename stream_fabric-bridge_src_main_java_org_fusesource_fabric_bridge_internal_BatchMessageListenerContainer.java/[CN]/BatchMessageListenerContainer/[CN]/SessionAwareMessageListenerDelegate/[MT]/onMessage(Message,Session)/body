{
  final long startTimeMillis=System.currentTimeMillis();
  final List<Message> messages=new LinkedList<Message>();
  messages.add(firstMessage);
  final MessageConsumer consumer=currentConsumer.get();
  currentConsumer.remove();
  int msgsReceived=1;
  while (msgsReceived < batchSize && (System.currentTimeMillis() - startTimeMillis) < batchTimeout) {
    final Message message=receiveMessage(consumer);
    if (message != null) {
      messages.add(message);
      msgsReceived++;
    }
  }
  @SuppressWarnings("unchecked") SessionAwareBatchMessageListener<Message> lsnr=(SessionAwareBatchMessageListener<Message>)batchMessageListener;
  if (logger.isDebugEnabled()) {
    logger.debug("Received [" + msgsReceived + "] messages in a batch from consumer ["+ consumer+ "] of "+ (session.getTransacted() ? "transactional " : "")+ "session ["+ session+ "]");
  }
  lsnr.onMessages(messages,session);
}
