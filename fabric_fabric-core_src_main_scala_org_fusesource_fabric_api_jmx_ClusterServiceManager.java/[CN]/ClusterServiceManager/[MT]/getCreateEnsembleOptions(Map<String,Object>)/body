{
  String username=(String)options.remove("username");
  String password=(String)options.remove("password");
  String role=(String)options.remove("role");
  if (username == null || password == null || role == null) {
    throw new FabricException("Must specify an administrator username, password and administrative role when creating a fabric");
  }
  CreateEnsembleOptions.Builder builder=CreateEnsembleOptions.builder();
  for (  String key : options.keySet()) {
    BeanUtils.setValue(builder,key,options.get(key));
  }
  org.apache.felix.utils.properties.Properties userProps=null;
  try {
    userProps=new org.apache.felix.utils.properties.Properties(new File(System.getProperty("karaf.home") + "/etc/users.properties"));
  }
 catch (  IOException e) {
    userProps=new org.apache.felix.utils.properties.Properties();
  }
  if (userProps.get(username) == null) {
    userProps.put(username,password + "," + role);
  }
  return builder.users(userProps).withUser(username,password,role).build();
}
