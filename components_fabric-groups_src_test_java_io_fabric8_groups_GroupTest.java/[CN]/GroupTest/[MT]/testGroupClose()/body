{
  int port=AvailablePortFinder.getNextAvailable(3030);
  NIOServerCnxnFactory cnxnFactory=startZooKeeper(port);
  CuratorFramework curator=CuratorFrameworkFactory.builder().connectString("localhost:" + port).retryPolicy(new RetryNTimes(10,100)).build();
  curator.start();
  curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
  String groupNode="/singletons/test" + System.currentTimeMillis();
  curator.create().creatingParentsIfNeeded().forPath(groupNode);
  for (int i=0; i < 10; i++) {
    Group<NodeState> group=new ZooKeeperGroup<NodeState>(curator,groupNode,NodeState.class);
    group.add(listener);
    group.update(new NodeState("foo"));
    group.start();
    group.close();
    List<String> entries=curator.getChildren().forPath(groupNode);
    assertTrue(entries.isEmpty());
  }
  curator.close();
  cnxnFactory.shutdown();
  cnxnFactory.join();
}
