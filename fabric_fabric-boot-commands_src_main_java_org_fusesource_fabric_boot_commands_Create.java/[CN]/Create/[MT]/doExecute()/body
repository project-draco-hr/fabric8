{
  if (containers == null || containers.isEmpty()) {
    containers=Arrays.asList(System.getProperty(SystemProperties.KARAF_NAME));
  }
  if (clean) {
    service.clean();
  }
  if (!noImport && importDir != null) {
    System.setProperty(SystemProperties.PROFILES_AUTOIMPORT_PATH,importDir);
  }
  if (globalResolver != null) {
    System.setProperty(ZkDefs.GLOBAL_RESOLVER_PROPERTY,globalResolver);
  }
  if (resolver != null) {
    System.setProperty(ZkDefs.LOCAL_RESOLVER_PROPERTY,resolver);
  }
  if (manualIp != null) {
    System.setProperty(ZkDefs.MANUAL_IP,manualIp);
  }
  if (profile != null) {
    System.setProperty(SystemProperties.PROFILE,profile);
  }
  if (nonManaged) {
    System.setProperty(SystemProperties.AGENT_AUTOSTART,"false");
  }
 else {
    System.setProperty(SystemProperties.AGENT_AUTOSTART,"true");
  }
  System.setProperty(ZkDefs.MINIMUM_PORT,String.valueOf(minimumPort));
  System.setProperty(ZkDefs.MAXIMUM_PORT,String.valueOf(maximumPort));
  newUser=newUser != null ? newUser : ShellUtils.retrieveFabricUser(session);
  newUserPassword=newUserPassword != null ? newUserPassword : ShellUtils.retrieveFabricUserPassword(session);
  Properties userProps=new Properties(new File(System.getProperty("karaf.home") + "/etc/users.properties"));
  if (userProps.isEmpty()) {
    String[] credentials=promptForNewUser(newUser,newUserPassword);
    newUser=credentials[0];
    newUserPassword=credentials[1];
  }
 else   if (newUser == null || newUserPassword == null) {
    newUser=(String)userProps.keySet().iterator().next();
    newUserPassword=(String)userProps.get(newUser);
    if (newUserPassword.contains(ROLE_DELIMITER)) {
      newUserPassword=newUserPassword.substring(0,newUserPassword.indexOf(ROLE_DELIMITER));
    }
  }
  if (newUser == null) {
    System.out.println("No user specified. Cannot create a new fabric ensemble.");
    return null;
  }
  StringBuilder sb=new StringBuilder();
  if (session != null) {
    ShellUtils.storeFabricCredentials(session,newUser,newUserPassword);
  }
  if (zookeeperPassword == null) {
    zookeeperPassword=System.getProperty(SystemProperties.ZOOKEEPER_PASSWORD);
  }
  if (zookeeperPassword == null && !generateZookeeperPassword) {
    zookeeperPassword=newUserPassword;
  }
  CreateEnsembleOptions options=CreateEnsembleOptions.build().zookeeperPassword(zookeeperPassword).user(newUser,newUserPassword + ROLE_DELIMITER + newUserRole);
  options.getUsers().putAll(userProps);
  if (containers != null && !containers.isEmpty()) {
    service.createCluster(containers,options);
  }
  ShellUtils.storeZookeeperPassword(session,options.getZookeeperPassword());
  if (zookeeperPassword == null && !generateZookeeperPassword) {
    sb.append("Zookeeper password: (reusing users ").append(newUser).append(" password:").append(options.getZookeeperPassword()).append(")\n");
    sb.append("(You can use the --zookeeper-password / --generate-zookeeper-password option to specify one.)\n");
  }
 else   if (generateZookeeperPassword) {
    sb.append("Generated zookeeper password:").append(options.getZookeeperPassword());
  }
 else {
    sb.append("Using specified zookeeper password:").append(options.getZookeeperPassword());
  }
  System.out.println(sb.toString());
  return null;
}
