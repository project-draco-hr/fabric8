{
  String parentName=FabricServiceImpl.getParentFromURI(agentUri);
  final Agent parent=service.getAgent(parentName);
  AgentTemplate agentTemplate=service.getAgentTemplate(parent);
  String ui=agentUri.getUserInfo();
  String[] uip=ui != null ? ui.split(":") : null;
  if (uip != null) {
    agentTemplate.setLogin(uip[0]);
    agentTemplate.setPassword(uip[1]);
  }
  agentTemplate.execute(new AgentTemplate.AdminServiceCallback<Object>(){
    public Object doWithAdminService(    AdminServiceMBean adminService) throws Exception {
      String javaOpts=zooKeeperUrl != null ? "-Dzookeeper.url=\"" + zooKeeperUrl + "\" -Xmx512M -server" : "";
      if (debugAgent) {
        javaOpts+=DEBUG_AGNET;
      }
      if (isClusterServer) {
        javaOpts+=CLUSTER_SERVER_AGENT;
      }
      String features="fabric-agent";
      String featuresUrls="mvn:org.fusesource.fabric/fuse-fabric/1.1-SNAPSHOT/xml/features";
      for (int i=1; i <= number; i++) {
        String agentName=name;
        if (number > 1) {
          agentName+=i;
        }
        adminService.createInstance(agentName,0,0,0,null,javaOpts,features,featuresUrls);
        adminService.startInstance(agentName,null);
      }
      return null;
    }
  }
);
}
