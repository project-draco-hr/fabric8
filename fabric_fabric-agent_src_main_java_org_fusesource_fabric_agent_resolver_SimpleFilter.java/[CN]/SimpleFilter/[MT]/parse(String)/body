{
  int idx=skipWhitespace(filter,0);
  if ((filter == null) || (filter.length() == 0) || (idx >= filter.length())) {
    throw new IllegalArgumentException("Null or empty filter.");
  }
 else   if (filter.charAt(idx) != '(') {
    throw new IllegalArgumentException("Missing opening parenthesis: " + filter);
  }
  SimpleFilter sf=null;
  List stack=new ArrayList();
  boolean isEscaped=false;
  while (idx < filter.length()) {
    if (sf != null) {
      throw new IllegalArgumentException("Only one top-level operation allowed: " + filter);
    }
    if (!isEscaped && (filter.charAt(idx) == '(')) {
      idx=skipWhitespace(filter,idx + 1);
      if (filter.charAt(idx) == '&') {
        int peek=skipWhitespace(filter,idx + 1);
        if (filter.charAt(peek) == '(') {
          idx=peek - 1;
          stack.add(0,new SimpleFilter(null,new ArrayList(),SimpleFilter.AND));
        }
 else {
          stack.add(0,new Integer(idx));
        }
      }
 else       if (filter.charAt(idx) == '|') {
        int peek=skipWhitespace(filter,idx + 1);
        if (filter.charAt(peek) == '(') {
          idx=peek - 1;
          stack.add(0,new SimpleFilter(null,new ArrayList(),SimpleFilter.OR));
        }
 else {
          stack.add(0,new Integer(idx));
        }
      }
 else       if (filter.charAt(idx) == '!') {
        int peek=skipWhitespace(filter,idx + 1);
        if (filter.charAt(peek) == '(') {
          idx=peek - 1;
          stack.add(0,new SimpleFilter(null,new ArrayList(),SimpleFilter.NOT));
        }
 else {
          stack.add(0,new Integer(idx));
        }
      }
 else {
        stack.add(0,new Integer(idx));
      }
    }
 else     if (!isEscaped && (filter.charAt(idx) == ')')) {
      Object top=stack.remove(0);
      if (top instanceof SimpleFilter) {
        if (!stack.isEmpty() && (stack.get(0) instanceof SimpleFilter)) {
          ((List)((SimpleFilter)stack.get(0)).m_value).add(top);
        }
 else {
          sf=(SimpleFilter)top;
        }
      }
 else       if (!stack.isEmpty() && (stack.get(0) instanceof SimpleFilter)) {
        ((List)((SimpleFilter)stack.get(0)).m_value).add(SimpleFilter.subfilter(filter,((Integer)top).intValue(),idx));
      }
 else {
        sf=SimpleFilter.subfilter(filter,((Integer)top).intValue(),idx);
      }
    }
 else     if (!isEscaped && (filter.charAt(idx) == '\\')) {
      isEscaped=true;
    }
 else {
      isEscaped=false;
    }
    idx=skipWhitespace(filter,idx + 1);
  }
  if (sf == null) {
    throw new IllegalArgumentException("Missing closing parenthesis: " + filter);
  }
  return sf;
}
