{
  FabricService fabric=getFabricService();
  Version version=getOrCreateVersion(requirements);
  Profile profile=getOrCreateProfile(version,requirements);
  ProjectRequirements oldRequirements=writeRequirementsJson(requirements,profile);
  updateProfileConfiguration(version,profile,requirements,oldRequirements);
  Profile overlay=profile.getOverlay();
  Container container=null;
  try {
    container=fabric.getCurrentContainer();
  }
 catch (  Exception e) {
  }
  DownloadManager downloadManager=null;
  if (container != null) {
    downloadManager=DownloadManagers.createDownloadManager(fabric,executorService);
  }
 else {
    downloadManager=DownloadManagers.createDownloadManager(fabric,overlay,executorService);
  }
  Map<String,Parser> profileArtifacts=AgentUtils.getProfileArtifacts(fabric,downloadManager,overlay);
  Integer minimumInstances=requirements.getMinimumInstances();
  if (minimumInstances != null) {
    FabricRequirements fabricRequirements=fabric.getRequirements();
    ProfileRequirements profileRequirements=fabricRequirements.getOrCreateProfileRequirement(profile.getId());
    profileRequirements.setMinimumInstances(minimumInstances);
    fabric.setRequirements(fabricRequirements);
  }
  return resolveProfileDeployments(requirements,profile,profileArtifacts);
}
