{
  ActiveMQService activeMQService=new ActiveMQService(brokerUrl);
  System.out.println("Using destination: " + destination + ", on broker: "+ brokerUrl);
  try {
    if ("producer".equals(action)) {
      activeMQService.start();
      ProducerThread producerThread=new ProducerThread(activeMQService,destination);
      producerThread.setMessageCount(count);
      producerThread.run();
      System.out.println("Produced: " + producerThread.getSentCount());
    }
 else     if ("consumer".equals(action)) {
      activeMQService.start();
      ConsumerThread consumerThread=new ConsumerThread(activeMQService,destination);
      consumerThread.setMessageCount(count);
      System.out.println("Waiting for: " + count + " messages");
      consumerThread.run();
      System.out.println("Consumed: " + consumerThread.getReceived() + " messages");
    }
 else {
      displayHelpAndExit(1);
    }
  }
 catch (  JMSException error) {
    System.err.println("Execution failed with: " + error);
    error.printStackTrace(System.err);
    System.exit(2);
  }
 finally {
    activeMQService.stop();
  }
}
