{
  Session session=event.getSession();
  final Logger log=session.getLogger();
  String namespace=session.getNamespace();
  System.setProperty(Constants.KUBERNETES_NAMESPACE,namespace);
  log.status("Creating kubernetes resources inside namespace: " + namespace);
  log.info("if you use OpenShift then type this switch namespaces:     osc namespace " + namespace);
  log.info("if you use kubernetes then type this to switch namespaces: kubectl namespace " + namespace);
  client.setNamespace(namespace);
  controller.setNamespace(namespace);
  controller.setThrowExceptionOnError(true);
  controller.setRecreateMode(true);
  controller.setIgnoreRunningOAuthClients(true);
  Namespace namespaceDetails=session.getNamespaceDetails();
  controller.applyNamespace(namespaceDetails);
  shutdownHook=new ShutdownHook(client,session);
  Runtime.getRuntime().addShutdownHook(shutdownHook);
  try {
    URL configUrl=configuration.getConfigUrl();
    List<String> dependencies=!configuration.getDependencies().isEmpty() ? configuration.getDependencies() : Util.getMavenDependencies(session);
    List<KubernetesList> kubeConfigs=new LinkedList<>();
    for (    String dependency : dependencies) {
      log.info("Found dependency: " + dependency);
      loadDependency(log,kubeConfigs,dependency);
    }
    if (configUrl != null) {
      log.status("Applying kubernetes configuration from: " + configUrl);
      Object dto=loadJson(readAsString(configUrl));
      if (dto instanceof Template) {
        Template template=(Template)dto;
        KubernetesHelper.setNamespace(template,namespace);
        String parameterNamePrefix="";
        overrideTemplateParameters(template,configuration.getProperties(),parameterNamePrefix);
        log.status("Applying template in namespace " + namespace);
        dto=controller.processTemplate(template,configUrl.toString());
        if (dto == null) {
          throw new IllegalArgumentException("Failed to process Template!");
        }
      }
      KubernetesList kubeList=KubernetesHelper.asKubernetesList(dto);
      List<HasMetadata> items=kubeList.getItems();
      kubeConfigs.add(kubeList);
    }
    if (applyConfiguration(client,controller,configuration,session,kubeConfigs)) {
      displaySessionStatus(client,session);
    }
 else {
      throw new IllegalStateException("Failed to apply kubernetes configuration.");
    }
  }
 catch (  Exception e) {
    try {
      cleanupSession(client,session);
    }
 catch (    MultiException me) {
      throw e;
    }
 finally {
      if (shutdownHook != null) {
        Runtime.getRuntime().removeShutdownHook(shutdownHook);
      }
    }
    throw new RuntimeException(e);
  }
}
