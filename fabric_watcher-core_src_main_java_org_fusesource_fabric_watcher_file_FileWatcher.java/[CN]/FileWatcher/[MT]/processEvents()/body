{
  while (true) {
    WatchKey key;
    try {
      key=watcher.take();
    }
 catch (    InterruptedException e) {
      return;
    }
    Path dir=keys.get(key);
    if (dir == null) {
      LOGGER.warn("Could not find key for " + key);
      continue;
    }
    for (    WatchEvent<?> event : key.pollEvents()) {
      WatchEvent.Kind kind=event.kind();
      WatchEvent<Path> ev=(WatchEvent<Path>)event;
      Path name=ev.context();
      Path child=dir.resolve(name);
      LOGGER.debug("Processing event {} on path {}",kind,child);
      if (kind == OVERFLOW) {
        continue;
      }
      try {
        if (kind == ENTRY_CREATE) {
          if (Files.isDirectory(child,NOFOLLOW_LINKS)) {
            Files.walkFileTree(child,new FilteringFileVisitor());
          }
 else           if (Files.isRegularFile(child,NOFOLLOW_LINKS)) {
            scan(child);
          }
        }
 else         if (kind == ENTRY_MODIFY) {
          if (Files.isRegularFile(child,NOFOLLOW_LINKS)) {
            scan(child);
          }
        }
 else         if (kind == ENTRY_DELETE) {
          unscan(child);
        }
      }
 catch (      IOException x) {
        x.printStackTrace();
      }
    }
    boolean valid=key.reset();
    if (!valid) {
      LOGGER.debug("Removing key " + key + " and dir "+ dir+ " from keys");
      keys.remove(key);
      if (keys.isEmpty()) {
        break;
      }
    }
  }
}
