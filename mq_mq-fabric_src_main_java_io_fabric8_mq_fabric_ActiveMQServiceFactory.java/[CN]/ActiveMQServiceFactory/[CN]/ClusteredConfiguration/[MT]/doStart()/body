{
  FabricService fs=fabricService.getService();
  if (fs != null) {
    Container container=fs.getCurrentContainer();
    if (!properties.containsKey("container.id")) {
      properties.setProperty("container.id",container.getId());
    }
    if (!properties.containsKey("container.ip")) {
      properties.setProperty("container.ip",container.getIp());
    }
    if (!properties.containsKey("zookeeper.url")) {
      properties.setProperty("zookeeper.url",fs.getZookeeperUrl());
    }
    if (!properties.containsKey("zookeeper.password")) {
      properties.setProperty("zookeeper.password",fs.getZookeeperPassword());
    }
  }
  info("booting up a broker from: " + config);
  server=createBroker(config,properties);
  for (  TransportConnector t : server.getBroker().getTransportConnectors()) {
    String portKey=t.getName() + "-port";
    if (properties.containsKey(portKey)) {
      URI template=t.getUri();
      t.setUri(new URI(template.getScheme(),template.getUserInfo(),template.getHost(),Integer.valueOf("" + properties.get(portKey)),template.getPath(),template.getQuery(),template.getFragment()));
    }
  }
  server.getBroker().start();
  info("Broker %s has started.",name);
  server.getBroker().waitUntilStarted();
  server.getBroker().addShutdownHook(new Runnable(){
    @Override public void run(){
      if (started.get() && server != null && server.getBroker().isRestartAllowed() && server.getBroker().isRestartRequested()) {
        info("Restarting broker '%s' after shutdown on restart request",name);
        discoveryAgent.setServices(new String[0]);
        start();
      }
 else {
        info("Broker '%s' shut down, giving up being master",name);
        try {
          updateCurator(curator);
        }
 catch (        Exception e) {
          throw new RuntimeException(e.getMessage(),e);
        }
      }
    }
  }
);
  if (replicating) {
    discoveryAgent.start();
  }
  List<String> services=new LinkedList<String>();
  if (!standalone || replicating) {
    for (    String name : connectors) {
      TransportConnector connector=server.getBroker().getConnectorByName(name);
      if (connector == null) {
        warn("ActiveMQ broker '%s' does not have a connector called '%s'",name,name);
      }
 else {
        services.add(connector.getConnectUri().getScheme() + "://${zk:" + System.getProperty("karaf.name")+ "/ip}:"+ connector.getPublishableConnectURI().getPort());
      }
    }
    discoveryAgent.setServices(services.toArray(new String[services.size()]));
  }
  if (registerService) {
    osgiRegister(server.getBroker());
  }
}
