{
  ClassLoader cl=Thread.currentThread().getContextClassLoader();
  try {
    Thread.currentThread().setContextClassLoader(Auditor.class.getClassLoader());
    String eventType=event.getClass().getSimpleName();
    eventType=eventType.substring("Exchange".length());
    eventType=eventType.substring(0,eventType.length() - "Event".length());
    CompiledTemplate template=getTemplate(eventType,event.getExchange());
    Map<String,Object> vars=new HashMap<String,Object>();
    vars.put("event",eventType);
    vars.put("host",System.getProperty("karaf.name"));
    vars.put("timestamp",new Date());
    vars.put("exchange",event.getExchange());
    return TemplateRuntime.execute(template,context,vars).toString();
  }
  finally {
    Thread.currentThread().setContextClassLoader(cl);
  }
}
