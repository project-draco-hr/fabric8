{
  ServiceRegistration newRegistration=null;
  try {
    if (properties != null) {
      Properties props=new Properties();
      for (Enumeration e=properties.keys(); e.hasMoreElements(); ) {
        Object key=e.nextElement();
        Object val=properties.get(key);
        props.put(key,val);
      }
      String url=(String)properties.get(URL);
      try {
        Connect connect=new Connect(url,false);
        newRegistration=bundleContext.registerService(Connect.class.getName(),connect,properties);
      }
 catch (      LibvirtException e) {
        LOG.error("Error creating libvirt connection",e);
      }
    }
  }
  finally {
    ServiceRegistration oldRegistration=(newRegistration == null) ? registrations.remove(pid) : registrations.put(pid,newRegistration);
    if (oldRegistration != null) {
      System.out.println("Unregistering libvirt connection " + pid);
      oldRegistration.unregister();
    }
  }
}
