{
  final Set<CreateJCloudsContainerMetadata> result=new LinkedHashSet<CreateJCloudsContainerMetadata>();
  ComputeService computeService=getOrCreateComputeService(options);
  TemplateBuilder builder=computeService.templateBuilder();
  builder.any();
switch (options.getInstanceType()) {
case Smallest:
    builder.smallest();
  break;
case Biggest:
builder.biggest();
break;
case Fastest:
builder.fastest();
}
if (options.getLocationId() != null) {
builder.locationId(options.getLocationId());
}
if (options.getImageId() != null) {
builder.imageId(options.getImageId());
}
if (options.getHardwareId() != null) {
builder.hardwareId(options.getHardwareId());
}
Set<? extends NodeMetadata> metadatas=null;
metadatas=computeService.createNodesInGroup(options.getGroup(),options.getNumber(),builder.build());
Thread.sleep(5000);
int suffix=1;
StringBuilder buffer=new StringBuilder();
boolean first=true;
if (metadatas != null) {
String originalName=new String(options.getName());
for (NodeMetadata nodeMetadata : metadatas) {
Credentials credentials=null;
if (options.getUser() != null) {
credentials=new Credentials(options.getUser(),nodeMetadata.getCredentials().credential);
}
 else {
credentials=nodeMetadata.getCredentials();
}
String id=nodeMetadata.getId();
Set<String> publicAddresses=nodeMetadata.getPublicAddresses();
String containerName;
if (options.getNumber() > 1) {
containerName=originalName + (suffix++);
}
 else {
containerName=originalName;
}
CreateJCloudsContainerMetadata jCloudsContainerMetadata=new CreateJCloudsContainerMetadata();
jCloudsContainerMetadata.setCreateOptions(options);
jCloudsContainerMetadata.setNodeId(nodeMetadata.getId());
jCloudsContainerMetadata.setContainerName(containerName);
jCloudsContainerMetadata.setPublicAddresses(publicAddresses);
jCloudsContainerMetadata.setHostname(nodeMetadata.getHostname());
jCloudsContainerMetadata.setIdentity(credentials.identity);
jCloudsContainerMetadata.setCredential(credentials.credential);
Properties addresses=new Properties();
if (publicAddresses != null && !publicAddresses.isEmpty()) {
String publicAddress=publicAddresses.toArray(new String[publicAddresses.size()])[0];
addresses.put("publicip",publicAddress);
}
options.getSystemProperties().put(ContainerProviderUtils.ADDRESSES_PROPERTY_KEY,addresses);
try {
String script=buildInstallAndStartScript(options.name(containerName));
ExecResponse response=null;
if (credentials != null) {
response=computeService.runScriptOnNode(id,script,RunScriptOptions.Builder.overrideCredentialsWith(credentials).runAsRoot(false));
}
 else {
response=computeService.runScriptOnNode(id,script);
}
if (response == null) {
jCloudsContainerMetadata.setFailure(new Exception("No response received for fabric install script."));
}
 else if (response.getOutput() != null && response.getOutput().contains("Command failed")) {
jCloudsContainerMetadata.setFailure(new Exception(response.getError()));
}
}
 catch (Throwable t) {
jCloudsContainerMetadata.setFailure(t);
}
options.getSystemProperties().clear();
result.add(jCloudsContainerMetadata);
}
}
return result;
}
