{
  if (value == null) {
    return TypeRegistry.NULL_FORMAT_CODE;
  }
  if (value.keySet().size() + value.values().size() > 255) {
    return AMQPMap.MAP_MAP32_CODE;
  }
  int size=0;
  for (  Object key : value.keySet()) {
    size+=((AmqpType)key).size();
    size+=((AmqpType)value.get(key)).size();
    if (size > (255 - AMQPMap.MAP_MAP8_WIDTH)) {
      return AMQPMap.MAP_MAP32_CODE;
    }
  }
  return AMQPMap.MAP_MAP8_CODE;
}
