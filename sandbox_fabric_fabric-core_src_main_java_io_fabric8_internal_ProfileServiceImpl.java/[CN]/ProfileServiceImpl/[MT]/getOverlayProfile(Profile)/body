{
  assertValid();
  Profile overlayProfile;
synchronized (this) {
    if (profile.isOverlay()) {
      LOGGER.debug("getOverlayProfile, given profile is already an overlay: " + profile);
      overlayProfile=profile;
    }
 else {
      String profileId=profile.getId();
      String environment=runtimeProperties.get().getProperty(SystemProperties.FABRIC_ENVIRONMENT);
      if (environment == null) {
        environment=System.getProperty(SystemProperties.FABRIC_PROFILE_ENVIRONMENT);
      }
      Version version=getRequiredVersion(profile.getVersion());
      ProfileBuilder builder=ProfileBuilder.Factory.create(profile.getVersion(),profileId);
      builder.addOptions(new OverlayOptionsProvider(version,profile,environment));
      overlayProfile=builder.getProfile();
      if (LOGGER.isInfoEnabled()) {
        OverlayAudit audit=getOverlayAudit();
synchronized (audit) {
          Profile lastOverlay=audit.overlayProfiles.get(profileId);
          if (lastOverlay == null) {
            LOGGER.info("Overlay" + Profiles.getProfileInfo(overlayProfile));
            audit.overlayProfiles.put(profileId,overlayProfile);
          }
 else           if (!lastOverlay.equals(overlayProfile)) {
            LOGGER.info("Overlay" + Profiles.getProfileDifference(lastOverlay,overlayProfile));
            audit.overlayProfiles.put(profileId,overlayProfile);
          }
        }
      }
    }
  }
  return overlayProfile;
}
