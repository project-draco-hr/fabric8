{
  String versionId=options.getVersion();
  int minimumPort=options.getMinimumPort();
  int maximumPort=options.getMaximumPort();
  String zooKeeperServerHost=options.getBindAddress();
  int zooKeeperServerPort=options.getZooKeeperServerPort();
  int zooKeeperServerConnectionPort=options.getZooKeeperServerConnectionPort();
  int mappedPort=mapPortToRange(zooKeeperServerPort,minimumPort,maximumPort);
  CuratorFramework curator=null;
  try {
    curator=createCuratorFramework(connectionUrl,options);
    curator.start();
    curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
    File importPath=new File(options.getImportPath());
    if (!importPath.isAbsolute()) {
      importPath=new File(homeDir,options.getImportPath());
    }
    if (options.isAutoImportEnabled()) {
      profileRegistry.importFromFileSystem(importPath.getAbsolutePath());
    }
    setData(curator,ZkPath.CONFIG_DEFAULT_VERSION.getPath(),versionId);
    String defaultProfileId=profileRegistry.getProfile(versionId,"default",true);
    setData(curator,ZkPath.CONFIG_ENSEMBLE_URL.getPath(),"${zk:" + name + "/ip}:"+ zooKeeperServerConnectionPort);
    setData(curator,ZkPath.CONFIG_ENSEMBLE_PASSWORD.getPath(),PasswordEncoder.encode(options.getZookeeperPassword()));
    Properties zkProps=new Properties();
    zkProps.setProperty("zookeeper.url","${zk:" + ZkPath.CONFIG_ENSEMBLE_URL.getPath() + "}");
    zkProps.setProperty("zookeeper.password","${zk:" + ZkPath.CONFIG_ENSEMBLE_PASSWORD.getPath() + "}");
    profileRegistry.setFileConfiguration(versionId,defaultProfileId,"io.fabric8.zookeeper.properties",DataStoreUtils.toBytes(zkProps));
    String profileId="fabric-ensemble-0000";
    IllegalStateAssertion.assertFalse(profileRegistry.hasProfile(versionId,profileId),"Profile already exists: " + versionId + "/"+ profileId);
    String ensembleProfileId=profileRegistry.getProfile(versionId,profileId,true);
    profileRegistry.setProfileAttribute(versionId,ensembleProfileId,"abstract","true");
    profileRegistry.setProfileAttribute(versionId,ensembleProfileId,"hidden","true");
    Properties ensembleProps=new Properties();
    ensembleProps.put("tickTime",String.valueOf(options.getZooKeeperServerTickTime()));
    ensembleProps.put("initLimit",String.valueOf(options.getZooKeeperServerInitLimit()));
    ensembleProps.put("syncLimit",String.valueOf(options.getZooKeeperServerSyncLimit()));
    ensembleProps.put("dataDir",options.getZooKeeperServerDataDir() + File.separator + "0000");
    loadPropertiesFrom(ensembleProps,importPath + "/fabric/profiles/default.profile/io.fabric8.zookeeper.server.properties");
    profileRegistry.setFileConfiguration(versionId,ensembleProfileId,"io.fabric8.zookeeper.server-0000.properties",DataStoreUtils.toBytes(ensembleProps));
    profileId="fabric-ensemble-0000-1";
    IllegalStateAssertion.assertFalse(profileRegistry.hasProfile(versionId,profileId),"Profile already exists: " + versionId + "/"+ profileId);
    String ensembleServerProfileId=profileRegistry.getProfile(versionId,profileId,true);
    profileRegistry.setProfileAttribute(versionId,ensembleServerProfileId,"hidden","true");
    profileRegistry.setProfileAttribute(versionId,ensembleServerProfileId,"parents",ensembleProfileId);
    Properties serverProps=new Properties();
    serverProps.put("clientPort",String.valueOf(mappedPort));
    serverProps.put("clientPortAddress",zooKeeperServerHost);
    profileRegistry.setFileConfiguration(versionId,ensembleServerProfileId,"io.fabric8.zookeeper.server-0000.properties",DataStoreUtils.toBytes(serverProps));
    setData(curator,ZkPath.CONFIG_ENSEMBLES.getPath(),"0000");
    setData(curator,ZkPath.CONFIG_ENSEMBLE.getPath("0000"),name);
    String fabricProfile=profileRegistry.getProfile(versionId,"fabric",true);
    Properties agentProps=DataStoreUtils.toProperties(profileRegistry.getFileConfiguration(versionId,fabricProfile,"io.fabric8.agent.properties"));
    agentProps.put("feature.fabric-commands","fabric-commands");
    profileRegistry.setFileConfiguration(versionId,"fabric","io.fabric8.agent.properties",DataStoreUtils.toBytes(agentProps));
    createDefault(curator,ZkPath.CONFIG_CONTAINER.getPath(name),versionId);
    StringBuilder profilesBuilder=new StringBuilder();
    Set<String> profiles=options.getProfiles();
    profilesBuilder.append("fabric").append(" ").append("fabric-ensemble-0000-1");
    for (    String p : profiles) {
      profilesBuilder.append(" ").append(p);
    }
    if (!options.isAgentEnabled()) {
      profilesBuilder.append(" ").append("unmanaged");
    }
    createDefault(curator,ZkPath.CONFIG_VERSIONS_CONTAINER.getPath(versionId,name),profilesBuilder.toString());
    Map<String,String> configs=new HashMap<String,String>();
    configs.put("encryption.enabled","${zk:/fabric/authentication/encryption.enabled}");
    profileRegistry.setConfiguration(versionId,defaultProfileId,"io.fabric8.jaas",configs);
    EncryptionSupport encryption=addUsersToZookeeper(curator,options.getUsers());
    createDefault(curator,"/fabric/authentication/encryption.enabled",Boolean.valueOf(encryption != null).toString());
    createDefault(curator,"/fabric/authentication/domain","karaf");
    createDefault(curator,ZkPath.AUTHENTICATION_CRYPT_ALGORITHM.getPath(),"PBEWithMD5AndDES");
    createDefault(curator,ZkPath.AUTHENTICATION_CRYPT_PASSWORD.getPath(),PasswordEncoder.encode(options.getZookeeperPassword()));
    aclManager.fixAcl(curator,"/fabric",true);
  }
 catch (  Exception ex) {
    throw new FabricException("Unable to create bootstrap configuration",ex);
  }
 finally {
    curator.close();
  }
}
