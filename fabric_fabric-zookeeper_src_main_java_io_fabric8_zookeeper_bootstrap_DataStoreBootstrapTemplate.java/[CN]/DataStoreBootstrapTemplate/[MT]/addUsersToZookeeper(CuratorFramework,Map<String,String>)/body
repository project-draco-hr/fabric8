{
  Pattern p=Pattern.compile("([^,]+),(.+)");
  Map<String,Object> options=new HashMap<String,Object>();
  options.put("encryption.prefix","{CRYPT}");
  options.put("encryption.suffix","{CRYPT}");
  options.put("encryption.enabled","true");
  options.put("encryption.algorithm","MD5");
  options.put("encryption.encoding","hexadecimal");
  Encryption encryption=null;
  EncryptionSupport encryptionSupport=null;
  Bundle bundle=FrameworkUtil.getBundle(getClass());
  if (bundle != null) {
    options.put(BundleContext.class.getName(),bundle.getBundleContext());
    try {
      encryptionSupport=new EncryptionSupport(options);
      encryption=encryptionSupport.getEncryption();
    }
 catch (    Exception e) {
    }
  }
  StringBuilder sb=new StringBuilder();
  for (  Map.Entry<String,String> entry : users.entrySet()) {
    String user=entry.getKey();
    Matcher m=p.matcher(entry.getValue());
    if (m.matches() && m.groupCount() >= 2) {
      String password=m.group(1).trim();
      if (encryptionSupport != null && encryption != null) {
        if (!password.startsWith(encryptionSupport.getEncryptionPrefix()) || !password.endsWith(encryptionSupport.getEncryptionSuffix())) {
          password=encryptionSupport.getEncryptionPrefix() + encryption.encryptPassword(m.group(1)).trim() + encryptionSupport.getEncryptionSuffix();
        }
      }
      String roles=m.group(2).trim();
      sb.append(user).append("=").append(password).append(",").append(roles).append("\n");
    }
  }
  String allUsers=sb.toString();
  createDefault(curator,"/fabric/authentication/users",allUsers);
  return encryptionSupport;
}
