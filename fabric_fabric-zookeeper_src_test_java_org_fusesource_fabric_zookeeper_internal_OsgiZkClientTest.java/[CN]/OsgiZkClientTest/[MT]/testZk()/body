{
  reset(bundleContext,serverStatsRegistration,managedServiceRegistration,zkClientRegistration);
  expect(bundleContext.registerService(eq(IZKClient.class.getName()),same(client),(Dictionary)anyObject())).andReturn(zkClientRegistration);
  expect(bundleContext.registerService(eq(ManagedService.class.getName()),same(client),(Dictionary)anyObject())).andReturn(managedServiceRegistration);
  replay(bundleContext,serverStatsRegistration,managedServiceRegistration,zkClientRegistration);
  client.init();
  verify(bundleContext,serverStatsRegistration,managedServiceRegistration,zkClientRegistration);
  assertFalse(client.isConfigured());
  assertFalse(client.isConnected());
  try {
    client.getChildren("/");
  }
 catch (  KeeperException.OperationTimeoutException e) {
  }
  reset(bundleContext,serverStatsRegistration,managedServiceRegistration,zkClientRegistration);
  zkClientRegistration.setProperties((Dictionary)anyObject());
  replay(bundleContext,serverStatsRegistration,managedServiceRegistration,zkClientRegistration);
  Hashtable properties=new Hashtable();
  properties.put("zookeeper.url","localhost:" + port);
  client.updated(properties);
  verify(bundleContext,serverStatsRegistration,managedServiceRegistration,zkClientRegistration);
  assertTrue(client.isConfigured());
  assertFalse(client.isConnected());
  try {
    client.waitForConnected(Timespan.parse("2s"));
    fail("Expected a timeout exception");
  }
 catch (  TimeoutException e) {
  }
  createServer();
  try {
    client.waitForConnected(Timespan.parse("10s"));
  }
 catch (  TimeoutException e) {
    fail("Did not expect a timeout exception");
  }
  assertTrue(client.isConfigured());
  assertTrue(client.isConnected());
}
