{
  Profile profile=getFabricService().getVersion(versionId).getProfile(profileId);
  Profile overlay=profile.getOverlay(true);
  Map<String,Boolean> isParentFeature=new HashMap<String,Boolean>();
  for (  String feature : profile.getFeatures()) {
    isParentFeature.put(feature,Boolean.FALSE);
  }
  for (  String feature : overlay.getFeatures()) {
    if (isParentFeature.get(feature) == null) {
      isParentFeature.put(feature,Boolean.TRUE);
    }
  }
  Map<String,Object> rc=new HashMap<String,Object>();
  List<Map<String,Object>> featureDefs=new ArrayList<Map<String,Object>>();
  for (  String feature : isParentFeature.keySet()) {
    Map<String,Object> featureDef=new HashMap<String,Object>();
    featureDef.put("id",feature);
    featureDef.put("isParentFeature",isParentFeature.get(feature));
    featureDefs.add(featureDef);
  }
  rc.put("featureDefinitions",featureDefs);
  List<Map<String,Object>> repositoryDefs=new ArrayList<Map<String,Object>>();
  for (  String repo : overlay.getRepositories()) {
    Map<String,Object> repoDef=new HashMap<String,Object>();
    repoDef.put("id",repo);
    InputStream is=null;
    try {
      URL url=new URL(repo);
      is=new BufferedInputStream(url.openStream());
      char[] buffer=new char[8192];
      StringBuilder data=new StringBuilder();
      Reader in=new InputStreamReader(is,"UTF-8");
      for (; ; ) {
        int stat=in.read(buffer,0,buffer.length);
        if (stat < 0) {
          break;
        }
        data.append(buffer,0,stat);
      }
      repoDef.put("data",data.toString());
    }
 catch (    Throwable t) {
      repoDef.put("error",t.getMessage());
    }
 finally {
      try {
        if (is != null) {
          is.close();
        }
      }
 catch (      Throwable t) {
      }
    }
    repositoryDefs.add(repoDef);
  }
  rc.put("repositoryDefinitions",repositoryDefs);
  return rc;
}
