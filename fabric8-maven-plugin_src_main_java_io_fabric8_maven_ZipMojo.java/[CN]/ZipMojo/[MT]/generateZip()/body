{
  File appBuildDir=buildDir;
  if (Strings.isNotBlank(pathInZip)) {
    appBuildDir=new File(buildDir,pathInZip);
  }
  appBuildDir.mkdirs();
  if (hasConfigDir()) {
    copyAppConfigFiles(appBuildDir,appConfigDir);
  }
 else {
    getLog().info("The app configuration files directory " + appConfigDir + " doesn't exist, so not copying any additional project documentation or configuration files");
  }
  MavenProject project=getProject();
  if (!ignoreProject) {
    File kubernetesJson=getKubernetesJson();
    if (kubernetesJson != null && kubernetesJson.isFile() && kubernetesJson.exists()) {
      File jsonFile=new File(appBuildDir,"kubernetes.json");
      jsonFile.getParentFile().mkdirs();
      Files.copy(kubernetesJson,jsonFile);
    }
    if (Strings.isNotBlank(iconRef)) {
      File[] icons=appBuildDir.listFiles(new FilenameFilter(){
        @Override public boolean accept(        File dir,        String name){
          if (name == null) {
            return false;
          }
          String lower=name.toLowerCase();
          if (lower.startsWith("icon.")) {
            for (            String ext : ICON_EXTENSIONS) {
              if (lower.endsWith(ext)) {
                return true;
              }
            }
          }
          return false;
        }
      }
);
      if (icons == null || icons.length == 0) {
        InputStream in=loadPluginResource(iconRef);
        if (in == null) {
          for (          String ext : ICON_EXTENSIONS) {
            String name=iconRef + ext;
            in=loadPluginResource(name);
            if (in != null) {
              iconRef=name;
              break;
            }
          }
        }
        if (in == null) {
          getLog().warn("Could not find icon: " + iconRef + " on the ClassPath!");
        }
 else {
          String fileName="icon." + Files.getFileExtension(iconRef);
          File outFile=new File(appBuildDir,fileName);
          Files.copy(in,new FileOutputStream(outFile));
          getLog().info("Generated icon file " + outFile + " from icon reference: "+ iconRef);
        }
      }
    }
  }
  if (hasConfigDir() || !ignoreProject) {
    if (includeReadMe) {
      copyReadMe(project.getFile().getParentFile(),appBuildDir);
    }
    if (generateSummaryFile) {
      String description=project.getDescription();
      if (Strings.isNotBlank(description)) {
        File summaryMd=new File(appBuildDir,"Summary.md");
        summaryMd.getParentFile().mkdirs();
        if (!summaryMd.exists()) {
          byte[] bytes=description.getBytes();
          Files.copy(new ByteArrayInputStream(bytes),new FileOutputStream(summaryMd));
        }
      }
    }
    if (generateAppPropertiesFile) {
      String name=project.getName();
      if (Strings.isNullOrBlank(name)) {
        name=project.getArtifactId();
      }
      String description=project.getDescription();
      Properties appProperties=new Properties();
      appProperties.put("name",name);
      if (Strings.isNotBlank(description)) {
        appProperties.put("description",description);
      }
      appProperties.put("groupId",project.getGroupId());
      appProperties.put("artifactId",project.getArtifactId());
      appProperties.put("version",project.getVersion());
      File appPropertiesFile=new File(appBuildDir,"fabric8.properties");
      appPropertiesFile.getParentFile().mkdirs();
      if (!appPropertiesFile.exists()) {
        appProperties.store(new FileWriter(appPropertiesFile),"Fabric8 Properties");
      }
    }
    File outputZipFile=getZipFile();
    File legalDir=null;
    if (includeLegal) {
      legalDir=new File(project.getBuild().getOutputDirectory(),"META-INF");
    }
    Zips.createZipFile(getLog(),buildDir,outputZipFile,legalDir);
    projectHelper.attachArtifact(project,artifactType,artifactClassifier,outputZipFile);
    getLog().info("Created app zip file: " + outputZipFile);
  }
}
