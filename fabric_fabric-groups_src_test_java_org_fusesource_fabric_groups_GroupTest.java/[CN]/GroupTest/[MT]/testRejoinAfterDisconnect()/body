{
  int port=findFreePort();
  CuratorFramework curator=CuratorFrameworkFactory.builder().connectString("localhost:" + port).retryPolicy(new RetryNTimes(10,100)).build();
  curator.start();
  NIOServerCnxnFactory cnxnFactory=startZooKeeper(port);
  Group<NodeState> group=new ZooKeeperGroup<NodeState>(curator,"/singletons/test" + System.currentTimeMillis(),NodeState.class);
  group.add(listener);
  group.update(new NodeState("foo"));
  group.start();
  curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
  Thread.sleep(1000);
  assertTrue(group.isConnected());
  assertTrue(group.isMaster());
  cnxnFactory.shutdown();
  cnxnFactory.join();
  Thread.sleep(1000);
  assertFalse(group.isConnected());
  assertFalse(group.isMaster());
  cnxnFactory=startZooKeeper(port);
  curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
  Thread.sleep(1000);
  assertTrue(group.isConnected());
  assertTrue(group.isMaster());
  group.close();
  curator.close();
  cnxnFactory.shutdown();
  cnxnFactory.join();
}
