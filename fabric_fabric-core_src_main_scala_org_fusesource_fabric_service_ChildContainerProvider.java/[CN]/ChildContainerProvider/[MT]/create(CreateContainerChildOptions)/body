{
  final Set<CreateContainerChildMetadata> result=new LinkedHashSet<CreateContainerChildMetadata>();
  final String parentName=options.getParent();
  final Container parent=service.getContainer(parentName);
  ContainerTemplate containerTemplate=service.getContainerTemplate(parent,options.getJmxUser(),options.getJmxPassword());
  containerTemplate.execute(new ContainerTemplate.AdminServiceCallback<Object>(){
    public Object doWithAdminService(    AdminServiceMBean adminService) throws Exception {
      StringBuilder jvmOptsBuilder=new StringBuilder();
      jvmOptsBuilder.append("-server -Dcom.sun.management.jmxremote").append(options.getZookeeperUrl() != null ? " -Dzookeeper.url=\"" + options.getZookeeperUrl() + "\"" : "").append(options.getZookeeperPassword() != null ? " -Dzookeeper.password=\"" + options.getZookeeperPassword() + "\"" : "");
      if (options.getJvmOpts() == null || !options.getJvmOpts().contains("-Xmx")) {
        jvmOptsBuilder.append(" -Xmx512m");
      }
      if (options.isEnsembleServer()) {
        jvmOptsBuilder.append(" ").append(ENSEMBLE_SERVER_CONTAINER);
      }
      if (options.getJvmOpts() != null && !options.getJvmOpts().isEmpty()) {
        jvmOptsBuilder.append(" ").append(options.getJvmOpts());
      }
      if (options.getJvmOpts() != null && !options.getJvmOpts().contains("-XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass")) {
        jvmOptsBuilder.append(" -XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass");
      }
      if (options.getBindAddress() != null && !options.getBindAddress().isEmpty()) {
        jvmOptsBuilder.append(" -D" + ZkDefs.BIND_ADDRESS + "="+ options.getBindAddress());
      }
      if (options.getResolver() != null && !options.getResolver().isEmpty()) {
        jvmOptsBuilder.append(" -D" + ZkDefs.LOCAL_RESOLVER_PROPERTY + "="+ options.getResolver());
      }
      if (options.getManualIp() != null && !options.getManualIp().isEmpty()) {
        jvmOptsBuilder.append(" -D" + ZkDefs.MANUAL_IP + "="+ options.getManualIp());
      }
      Profile defaultProfile=parent.getVersion().getProfile("default");
      String featuresUrls=collectionAsString(defaultProfile.getRepositories());
      Set<String> features=new LinkedHashSet<String>();
      features.add("war");
      features.addAll(defaultProfile.getFeatures());
      String originalName=options.getName();
      PortService portService=service.getPortService();
      Set<Integer> usedPorts=portService.findUsedPortByHost(parent);
      for (int i=1; i <= options.getNumber(); i++) {
        String containerName;
        if (options.getNumber() > 1) {
          containerName=originalName + i;
        }
 else {
          containerName=originalName;
        }
        CreateContainerChildMetadata metadata=new CreateContainerChildMetadata();
        metadata.setCreateOptions(options);
        metadata.setContainerName(containerName);
        int minimumPort=parent.getMinimumPort();
        int maximumPort=parent.getMaximumPort();
        setData(service.getCurator(),ZkPath.CONTAINER_PORT_MIN.getPath(containerName),String.valueOf(minimumPort));
        setData(service.getCurator(),ZkPath.CONTAINER_PORT_MAX.getPath(containerName),String.valueOf(maximumPort));
        inheritAddresses(service.getCurator(),parentName,containerName,options);
        Container child=new ContainerImpl(parent,containerName,service){
          @Override public String getIp(){
            return parent.getIp();
          }
        }
;
        int sshFrom=mapPortToRange(Ports.DEFAULT_KARAF_SSH_PORT,minimumPort,maximumPort);
        int sshTo=mapPortToRange(Ports.DEFAULT_KARAF_SSH_PORT + 100,minimumPort,maximumPort);
        int sshPort=portService.registerPort(child,"org.apache.karaf.shell","sshPort",sshFrom,sshTo,usedPorts);
        int httpFrom=mapPortToRange(Ports.DEFAULT_HTTP_PORT,minimumPort,maximumPort);
        int httpTo=mapPortToRange(Ports.DEFAULT_HTTP_PORT + 100,minimumPort,maximumPort);
        portService.registerPort(child,"org.ops4j.pax.web","org.osgi.service.http.port",httpFrom,httpTo,usedPorts);
        int rmiServerFrom=mapPortToRange(Ports.DEFAULT_RMI_SERVER_PORT,minimumPort,maximumPort);
        int rmiServerTo=mapPortToRange(Ports.DEFAULT_RMI_SERVER_PORT + 100,minimumPort,maximumPort);
        int rmiServerPort=portService.registerPort(child,"org.apache.karaf.management","rmiServerPort",rmiServerFrom,rmiServerTo,usedPorts);
        int rmiRegistryFrom=mapPortToRange(Ports.DEFAULT_RMI_REGISTRY_PORT,minimumPort,maximumPort);
        int rmiRegistryTo=mapPortToRange(Ports.DEFAULT_RMI_REGISTRY_PORT + 100,minimumPort,maximumPort);
        int rmiRegistryPort=portService.registerPort(child,"org.apache.karaf.management","rmiRegistryPort",rmiRegistryFrom,rmiRegistryTo,usedPorts);
        try {
          adminService.createInstance(containerName,sshPort,rmiRegistryPort,rmiServerPort,null,jvmOptsBuilder.toString(),collectionAsString(features),featuresUrls);
          adminService.startInstance(containerName,null);
        }
 catch (        Throwable t) {
          metadata.setFailure(t);
        }
        result.add(metadata);
      }
      return null;
    }
  }
);
  return result;
}
