{
  CommandSupport.executeCommand("fabric:create --force --clean -n");
  ModuleContext moduleContext=RuntimeLocator.getRequiredRuntime().getModuleContext();
  ServiceProxy<FabricService> fabricProxy=ServiceProxy.createServiceProxy(moduleContext,FabricService.class);
  try {
    FabricService fabricService=fabricProxy.getService();
    Set<Container> containers=ContainerBuilder.create().withName("smoke.camel").withProfiles("feature-camel").assertProvisioningResult().build(fabricService);
    try {
      CommandSupport.executeCommand("fabric:version-create --parent 1.0 1.1");
      CountDownLatch latch=WaitForConfigurationChange.on(fabricService);
      CommandSupport.executeCommand("fabric:profile-edit --features camel-script --features camel-hazelcast feature-camel 1.1");
      Assert.assertTrue(latch.await(5,TimeUnit.SECONDS));
      CommandSupport.executeCommand("fabric:profile-display --version 1.1 feature-camel");
      CommandSupport.executeCommand("fabric:container-upgrade --all 1.1");
      ProvisionSupport.provisioningSuccess(containers,ProvisionSupport.PROVISION_TIMEOUT);
      CommandSupport.executeCommand("fabric:container-list");
      for (      Container container : containers) {
        Assert.assertEquals("Container should have version 1.1","1.1",container.getVersion().getId());
        String bundles=CommandSupport.executeCommand("fabric:container-connect -u admin -p admin " + container.getId() + " osgi:list -s | grep camel-hazelcast");
        Assert.assertNotNull(bundles);
        System.out.println(bundles);
        Assert.assertFalse("Expected camel-hazelcast installed on container: " + container.getId(),bundles.isEmpty());
      }
      CommandSupport.executeCommand("fabric:container-rollback --all 1.0");
      ProvisionSupport.provisioningSuccess(containers,ProvisionSupport.PROVISION_TIMEOUT);
      CommandSupport.executeCommand("fabric:container-list");
      for (      Container container : containers) {
        Assert.assertEquals("Container should have version 1.0","1.0",container.getVersion().getId());
        String bundles=CommandSupport.executeCommand("fabric:container-connect -u admin -p admin " + container.getId() + " osgi:list -s | grep camel-hazelcast");
        Assert.assertNotNull(bundles);
        System.out.println(bundles);
        Assert.assertTrue("Expected no camel-hazelcast installed on container: " + container.getId(),bundles.isEmpty());
      }
    }
  finally {
      ContainerBuilder.stop(fabricService,containers);
    }
  }
  finally {
    fabricProxy.close();
  }
}
