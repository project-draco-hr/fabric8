{
  final int max=1000000;
  final AtomicLong i=new AtomicLong(0);
  final CountDownLatch latch=new CountDownLatch(1);
  Executors.newSingleThreadExecutor().execute(new Runnable(){
    public void run(){
      while (i.incrementAndGet() < max) {
        AmqpTransfer in=createAmqpTransfer();
        in.setDeliveryTag(createAmqpDeliveryTag(new Buffer(UUID.randomUUID().toString().getBytes())));
        in.setTransferId(i.get() + 1);
        in.setHandle(0);
        in.setFragments(createMultiple());
        in.setMessageFormat(0);
        AmqpFragment fragment=createAmqpFragment();
        fragment.setFirst(true);
        fragment.setLast(true);
        fragment.setSectionNumber(0);
        fragment.setSectionCode(3);
        fragment.setPayload(new Buffer(("Message : " + i).getBytes()));
        in.getFragments().setValue(fragment);
        try {
          AmqpTransfer out=marshalUnmarshal(in);
          in.equals(out);
        }
 catch (        Exception e) {
          latch.countDown();
          e.printStackTrace();
          return;
        }
      }
      latch.countDown();
    }
  }
);
  int last=0;
  while (latch.await(5,TimeUnit.SECONDS) == false) {
    int sample=i.intValue() - last;
    last=last + sample;
    System.out.println("msgs/s : " + (sample / 5));
  }
  Assert.assertTrue(i.get() == max);
}
