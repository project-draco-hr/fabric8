{
  updateStatus("installing",null,null);
  Set<String> bundles=new LinkedHashSet<String>();
  Set<Feature> features=new LinkedHashSet<Feature>();
  bundles.addAll(profile.getBundles());
  DownloadManager downloadManager=DownloadManagers.createDownloadManager(fabric,downloadExecutor);
  AgentUtils.addFeatures(features,fabric,downloadManager,profile);
  ResourceInstaller resourceInstaller=provisionService.getResourceInstaller();
  Map<ResourceIdentity,Resource> installedResources=getInstalledResources(provisionService);
  Map<Requirement,Resource> requirements=new HashMap<Requirement,Resource>();
  Map<String,File> files=AgentUtils.downloadBundles(downloadManager,features,bundles,Collections.<String>emptySet());
  Set<Map.Entry<String,File>> entries=files.entrySet();
  List<Resource> resourcesToInstall=new ArrayList<Resource>();
  List<String> resourceUrisInstalled=new ArrayList<String>();
  for (  Map.Entry<String,File> entry : entries) {
    String name=entry.getKey();
    File file=entry.getValue();
    String coords=name;
    int idx=coords.lastIndexOf(':');
    if (idx > 0) {
      coords=name.substring(idx + 1);
    }
    coords=coords.replace('/',':');
    MavenCoordinates mvnCoords=MavenCoordinates.parse(coords);
    URL url=file.toURI().toURL();
    if (url == null) {
      LOGGER.warn("Could not find URL for file " + file);
      continue;
    }
    boolean isWar=name.startsWith("war:") || name.contains("/war/") || file.getName().toLowerCase().endsWith(".war");
    boolean isShared=!isWar;
    Resource resource=findMavenResource(mvnCoords,url,isShared);
    if (resource == null) {
      LOGGER.warn("Could not find resource for " + mvnCoords + " and "+ url);
    }
 else {
      ResourceIdentity identity=resource.getIdentity();
      Resource oldResource=installedResources.remove(identity);
      if (oldResource == null && !resourcehandleMap.containsKey(identity)) {
        if (isShared) {
          LOGGER.warn("TODO not installing " + (isShared ? "shared" : "non-shared") + " resource: "+ identity);
        }
 else {
          LOGGER.info("Installing " + (isShared ? "shared" : "non-shared") + " resource: "+ identity);
          resourcesToInstall.add(resource);
          resourceUrisInstalled.add(name);
        }
      }
    }
  }
  for (  Resource installedResource : installedResources.values()) {
    ResourceIdentity identity=installedResource.getIdentity();
    ResourceHandle resourceHandle=resourcehandleMap.get(identity);
    if (resourceHandle == null) {
      LOGGER.warn("TODO: Cannot uninstall " + installedResource + " as we have no handle!");
    }
 else {
      LOGGER.info("Uninstalling " + installedResource);
      resourceHandle.uninstall();
      resourcehandleMap.remove(identity);
      LOGGER.info("Uninstalled " + installedResource);
    }
  }
  if (resourcesToInstall.size() > 0) {
    LOGGER.info("Installing " + resourcesToInstall.size() + " resource(s)");
    Set<ResourceHandle> resourceHandles=resourceInstaller.installResources(resourcesToInstall,requirements);
    LOGGER.info("Got " + resourceHandles.size() + " resource handle(s)");
    for (    ResourceHandle resourceHandle : resourceHandles) {
      resourcehandleMap.put(resourceHandle.getResource().getIdentity(),resourceHandle);
    }
  }
  return resourceUrisInstalled;
}
