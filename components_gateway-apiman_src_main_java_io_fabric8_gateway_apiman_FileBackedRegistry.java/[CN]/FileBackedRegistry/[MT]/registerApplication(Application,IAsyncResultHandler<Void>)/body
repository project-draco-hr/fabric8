{
  try {
    for (    Contract contract : application.getContracts()) {
      if (contracts.containsKey(contract.getApiKey())) {
        throw new RegistrationException(Messages.i18n.format("InMemoryRegistry.ContractAlreadyPublished",contract.getApiKey()));
      }
      String svcKey=getServiceKey(contract.getServiceOrgId(),contract.getServiceId(),contract.getServiceVersion());
      if (!services.containsKey(svcKey)) {
        throw new RegistrationException(Messages.i18n.format("InMemoryRegistry.ServiceNotFoundInOrg",contract.getServiceId(),contract.getServiceOrgId()));
      }
    }
    String applicationKey=getApplicationKey(application);
    if (applications.containsKey(applicationKey)) {
      throw new RegistrationException(Messages.i18n.format("InMemoryRegistry.AppAlreadyRegistered"));
    }
    applications.put(applicationKey,application);
    for (    Contract contract : application.getContracts()) {
      String svcKey=getServiceKey(contract.getServiceOrgId(),contract.getServiceId(),contract.getServiceVersion());
      ServiceContract sc=new ServiceContract(contract.getApiKey(),services.get(svcKey),application,contract.getPolicies());
      contracts.put(contract.getApiKey(),sc);
    }
    save();
    handler.handle(AsyncResultImpl.create((Void)null));
  }
 catch (  Throwable t) {
    handler.handle(AsyncResultImpl.create(t,Void.class));
  }
}
