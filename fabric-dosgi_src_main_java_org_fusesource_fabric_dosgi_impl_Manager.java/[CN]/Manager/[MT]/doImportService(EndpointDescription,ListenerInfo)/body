{
  Map<Long,ImportRegistration> registrations=importedServices.get(endpoint);
  if (registrations == null) {
    registrations=new HashMap<Long,ImportRegistration>();
    importedServices.put(endpoint,registrations);
  }
  ImportRegistration reg=registrations.get(listener.getBundleContext().getBundle().getBundleId());
  if (reg == null) {
    Bundle bundle=bundleContext.getBundle(listener.getBundleContext().getBundle().getBundleId());
    ServiceRegistration registration=bundle.getBundleContext().registerService(endpoint.getInterfaces().toArray(new String[endpoint.getInterfaces().size()]),new Factory(endpoint),new Hashtable<String,Object>(endpoint.getProperties()));
    reg=new ImportRegistration(registration,endpoint);
    registrations.put(listener.getBundleContext().getBundle().getBundleId(),reg);
  }
  reg.addReference(listener);
  return reg;
}
