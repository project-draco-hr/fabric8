{
  if (registry == null) {
    final Logger log=LoggerFactory.getLogger("Test Registry");
    System.setProperty("org.osgi.framework.storage","target/osgi/" + System.currentTimeMillis());
    System.setProperty("karaf.name","root");
    List<BundleDescriptor> bundles=new ClasspathScanner().scanForBundles();
    log.info("Located following bundles on classpath : ");
    for (    BundleDescriptor desc : bundles) {
      log.info("Bundle : {}",desc);
    }
    Map config=new HashMap();
    config.put(PojoServiceRegistryFactory.BUNDLE_DESCRIPTORS,bundles);
    ServiceLoader<PojoServiceRegistryFactory> loader=ServiceLoader.load(PojoServiceRegistryFactory.class);
    registry=loader.iterator().next().newPojoServiceRegistry(config);
    registry.addServiceListener(new ServiceListener(){
      @Override public void serviceChanged(      ServiceEvent event){
        log.info("Service changed : " + event.toString());
      }
    }
);
    Thread.sleep(5000);
  }
  return registry;
}
