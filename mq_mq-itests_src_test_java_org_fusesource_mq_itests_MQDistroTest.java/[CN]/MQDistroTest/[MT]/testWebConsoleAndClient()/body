{
  final HttpClient client=new HttpClient();
  client.getParams().setAuthenticationPreemptive(true);
  client.getState().setCredentials(new AuthScope(AuthScope.ANY_HOST,AuthScope.ANY_PORT),new UsernamePasswordCredentials(USER_NAME_ND_PASSWORD,USER_NAME_ND_PASSWORD));
  GetMethod get=new GetMethod(JOLOKIA_URL + "exec/" + BROKER_MBEAN+ "/addQueue/FOO");
  get.setDoAuthentication(true);
  client.executeMethod(get);
  assertEquals("destination created",200,get.getStatusCode());
  get=new GetMethod(JOLOKIA_URL + "exec/" + BROKER_MBEAN+ ",destinationType=Queue,destinationName=FOO/sendTextMessage(java.lang.String,java.lang.String,java.lang.String)/Hello/admin/admin");
  client.executeMethod(get);
  assertEquals("message sent",200,get.getStatusCode());
  ActiveMQConnection connection=(ActiveMQConnection)new ActiveMQConnectionFactory().createConnection(USER_NAME_ND_PASSWORD,USER_NAME_ND_PASSWORD);
  connection.start();
  try {
    Session session=connection.createSession(false,Session.AUTO_ACKNOWLEDGE);
    TextMessage textMessage=(TextMessage)session.createConsumer(new ActiveMQQueue("FOO")).receive(10 * 1000);
    assertNotNull("got a message",textMessage);
    assertEquals("it is ours","Hello",textMessage.getText());
  }
  finally {
    connection.close();
  }
  ConnectionFactory connectionFactory=getOsgiService(ConnectionFactory.class);
  assertTrue(connectionFactory instanceof ActiveMQConnectionFactory);
  ActiveMQConnection connectionFromOsgiFactory=(ActiveMQConnection)connectionFactory.createConnection(USER_NAME_ND_PASSWORD,USER_NAME_ND_PASSWORD);
  connectionFromOsgiFactory.start();
  try {
    assertEquals("same broker",connection.getBrokerName(),connectionFromOsgiFactory.getBrokerName());
  }
  finally {
    connectionFromOsgiFactory.close();
  }
  Process process=Runtime.getRuntime().exec("java -jar extras" + File.separator + "mq-client.jar producer --count 1 --user "+ USER_NAME_ND_PASSWORD+ " --password "+ USER_NAME_ND_PASSWORD,null,new File(System.getProperty("user.dir")));
  process.waitFor();
  assertEquals("producer worked, exit(0)?",0,process.exitValue());
  process=Runtime.getRuntime().exec("java -jar extras" + File.separator + "mq-client.jar consumer --count 1 --user "+ USER_NAME_ND_PASSWORD+ " --password "+ USER_NAME_ND_PASSWORD,null,new File(System.getProperty("user.dir")));
  process.waitFor();
  assertEquals("consumer worked, exit(0)?",0,process.exitValue());
  System.out.println(executeCommand("activemq:bstat"));
}
