{
  final CountDownLatch countDownLatch=new CountDownLatch(TEST_NUM_BATCHES);
  final ConcurrentLinkedQueue<Integer> blockingQueue=new ConcurrentLinkedQueue<Integer>();
  listenerContainer.setBatchTimeout(TEST_BATCH_TIMEOUT);
  listenerContainer.setBatchSize(TEST_PSEUDO_DISABLE);
  listenerContainer.setBatchMessageListener(new SessionAwareBatchMessageListener<Message>(){
    public void onMessages(    List<Message> messages,    Session session) throws JMSException {
      countDownLatch.countDown();
      final int nMsgs=messages.size();
      int batchDuration=(int)(messages.get(nMsgs - 1).getJMSTimestamp() - messages.get(0).getJMSTimestamp());
      blockingQueue.add(batchDuration);
      logBatch("Batch duration [",batchDuration,session);
    }
  }
);
  listenerContainer.afterPropertiesSet();
  listenerContainer.start();
  sendMessages(TEST_LOCAL_BROKER_URL,TEST_QUEUE,TEST_NUM_MESSAGES,null);
  try {
    assertTrue("Test timed out",countDownLatch.await(TEST_TIMEOUT,TimeUnit.SECONDS));
  }
 catch (  InterruptedException e) {
    fail("Batch test interrupted");
  }
  int nResults=blockingQueue.size();
  for (int i=0; i < nResults; i++) {
    assertTrue("Batch exceeded timeout",blockingQueue.poll() <= TEST_BATCH_TIMEOUT);
  }
}
