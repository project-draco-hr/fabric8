{
  try {
    FabricDiscoveryAgent rc;
    boolean osgi=false;
    try {
      if (OsgiUtil.isOsgi()) {
        LOG.info("OSGi environment detected!");
        osgi=true;
      }
    }
 catch (    Throwable ignore) {
      LOG.debug("OSGi not detected due " + ignore.getMessage() + ". This exception is ignored.",ignore);
    }
    if (osgi) {
      rc=OsgiUtil.createOsgiDiscoveryAgent();
    }
 else {
      rc=new FabricDiscoveryAgent();
    }
    if (uri.getSchemeSpecificPart() != null && uri.getSchemeSpecificPart().length() > 0) {
      String ssp=stripPrefix(uri.getSchemeSpecificPart(),"//");
      Map<String,String> query=parseQuery(ssp);
      String groupName=ssp.split("\\?")[0];
      if (query.get("id") != null) {
        rc.setId(query.get("id"));
      }
      rc.setGroupName(groupName);
    }
    return rc;
  }
 catch (  Throwable e) {
    throw IOExceptionSupport.create("Could not create discovery agent: " + uri,e);
  }
}
