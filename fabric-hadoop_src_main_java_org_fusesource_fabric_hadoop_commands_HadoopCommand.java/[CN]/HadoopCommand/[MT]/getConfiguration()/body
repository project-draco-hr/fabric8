{
  BundleContext bc=FrameworkUtil.getBundle(getClass()).getBundleContext();
  ServiceReference ref=bc.getServiceReference(ConfigurationAdmin.class.getName());
  try {
    ConfigurationAdmin admin=ref != null ? (ConfigurationAdmin)bc.getService(ref) : null;
    org.osgi.service.cm.Configuration config=admin != null ? admin.getConfiguration(HadoopFactory.CONFIG_PID) : null;
    Dictionary dictionary=config != null ? config.getProperties() : null;
    if (dictionary == null) {
      throw new IllegalStateException("No configuration found for pid " + HadoopFactory.CONFIG_PID);
    }
    Configuration conf=new Configuration();
    for (Enumeration e=dictionary.keys(); e.hasMoreElements(); ) {
      Object key=e.nextElement();
      Object val=dictionary.get(key);
      conf.set(key.toString(),val.toString());
    }
    return conf;
  }
  finally {
    if (ref != null) {
      bc.ungetService(ref);
    }
  }
}
