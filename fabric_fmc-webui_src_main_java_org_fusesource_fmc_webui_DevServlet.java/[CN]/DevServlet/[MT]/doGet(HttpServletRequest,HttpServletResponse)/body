{
  String requested=req.getPathInfo();
  LOG.debug("Requested file : " + requested);
  if (requested == null) {
    LOG.debug("Requested path is null");
    resp.sendError(HttpServletResponse.SC_NOT_FOUND);
    return;
  }
  InputStream in=null;
  String type=null;
  if (Config.getInstance() != null) {
    String contentDir=Config.getInstance().getContentDirectory();
    if (contentDir != null && !contentDir.equals("")) {
      File file=new File(contentDir,URLDecoder.decode(requested,"UTF-8"));
      if (!file.exists()) {
        LOG.debug("File " + file.getPath() + " does not exist");
        resp.sendError(HttpServletResponse.SC_NOT_FOUND);
        return;
      }
      LOG.info("Serving file: " + file.getAbsolutePath() + " of type "+ type);
      in=new FileInputStream(file);
    }
  }
  if (in == null) {
    ClassLoader classLoader=Thread.currentThread().getContextClassLoader();
    LOG.debug("Serving resource: " + requested);
    in=classLoader.getResourceAsStream(requested);
  }
  if (in == null) {
    LOG.debug("Resource " + requested + " does not exist");
    resp.sendError(HttpServletResponse.SC_NOT_FOUND);
    return;
  }
  type=getServletContext().getMimeType(requested);
  if (type == null) {
    type="application/octet-stream";
  }
  resp.reset();
  resp.setBufferSize(DEFAULT_BUFFER_SIZE);
  resp.setContentType(type);
  resp.setHeader("Content-Length",String.valueOf(in.available()));
  BufferedInputStream input=null;
  BufferedOutputStream output=null;
  try {
    input=new BufferedInputStream(in,DEFAULT_BUFFER_SIZE);
    output=new BufferedOutputStream(resp.getOutputStream(),DEFAULT_BUFFER_SIZE);
    byte[] buffer=new byte[DEFAULT_BUFFER_SIZE];
    int length;
    while ((length=input.read(buffer)) > 0) {
      output.write(buffer,0,length);
    }
  }
  finally {
    close(output);
    close(input);
    close(in);
  }
}
