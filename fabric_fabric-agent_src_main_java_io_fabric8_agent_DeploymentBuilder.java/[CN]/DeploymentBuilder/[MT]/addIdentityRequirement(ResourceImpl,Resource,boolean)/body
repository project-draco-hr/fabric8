{
  for (  Capability cap : required.getCapabilities(null)) {
    if (cap.getNamespace().equals(IDENTITY_NAMESPACE)) {
      Map<String,Object> attributes=cap.getAttributes();
      Map<String,String> dirs=new HashMap<>();
      dirs.put(REQUIREMENT_RESOLUTION_DIRECTIVE,mandatory ? RESOLUTION_MANDATORY : RESOLUTION_OPTIONAL);
      Map<String,Object> attrs=new HashMap<>();
      attrs.put(IDENTITY_NAMESPACE,attributes.get(IDENTITY_NAMESPACE));
      attrs.put(CAPABILITY_TYPE_ATTRIBUTE,attributes.get(CAPABILITY_TYPE_ATTRIBUTE));
      Version version=(Version)attributes.get(CAPABILITY_VERSION_ATTRIBUTE);
      if (version != null) {
        attrs.put(CAPABILITY_VERSION_ATTRIBUTE,new VersionRange(version,true));
      }
      resource.addRequirement(new RequirementImpl(resource,IDENTITY_NAMESPACE,dirs,attrs));
    }
  }
}
