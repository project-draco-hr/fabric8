{
  if (location.startsWith(FAB_PROTOCOL)) {
    String url=location.substring(FAB_PROTOCOL.length());
    downloader.download(url,new AgentUtils.DownloadCallback(){
      @Override public void downloaded(      File file) throws Exception {
        FabResolver resolver=fabResolverFactory.getResolver(file.toURI().toURL());
        FabBundleInfo fabInfo=resolver.getInfo();
        ResourceImpl resource=(ResourceImpl)manageResource(location,fabInfo.getManifest(),new StreamProvider.Fab(fabInfo));
        for (        String name : fabInfo.getFeatures()) {
          registerMatchingFeatures(name);
          requireFeature(name,resource);
        }
        for (        DependencyTree dep : fabInfo.getBundles()) {
          File depFile=dep.getJarFile();
          Attributes attrs=getAttributes(dep.getJarURL().toString(),depFile);
          if (attrs.getValue(Constants.BUNDLE_SYMBOLICNAME) != null) {
            manageResource(getMvnUrl(dep),attrs,new StreamProvider.File(depFile));
          }
        }
      }
    }
);
  }
 else   if (location.startsWith(REQ_PROTOCOL)) {
    try {
      ResourceImpl resource=new ResourceImpl(location,"dummy",Version.emptyVersion);
      for (      Requirement req : ResourceBuilder.parseRequirement(resource,location.substring(REQ_PROTOCOL.length()))) {
        resource.addRequirement(req);
      }
      resources.put(location,resource);
    }
 catch (    BundleException e) {
      throw new IOException("Error parsing requirement",e);
    }
  }
 else {
    downloader.download(location,new AgentUtils.DownloadCallback(){
      @Override public void downloaded(      File file) throws Exception {
        manageResource(location,file);
      }
    }
);
  }
}
