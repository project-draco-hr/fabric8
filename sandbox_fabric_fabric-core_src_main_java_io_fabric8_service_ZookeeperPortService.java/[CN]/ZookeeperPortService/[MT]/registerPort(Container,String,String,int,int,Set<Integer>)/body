{
  assertValid();
  try {
    if (interProcessLock.acquire(60,TimeUnit.SECONDS)) {
      int port=lookupPort(container,pid,key);
      if (port > 0) {
        return port;
      }
      Set<Integer> boundPorts=findUsedPortByHost(container);
      boundPorts.addAll(excludes);
      for (port=fromPort; port <= toPort; port++) {
        if (!boundPorts.contains(port)) {
          registerPort(container,pid,key,port);
          return port;
        }
      }
    }
 else {
      throw new FabricException("Could not acquire port lock");
    }
    throw new FabricException("Could not find port within range [" + fromPort + ","+ toPort+ "]");
  }
 catch (  Exception ex) {
    throw FabricException.launderThrowable(ex);
  }
 finally {
    releaseLock();
  }
}
