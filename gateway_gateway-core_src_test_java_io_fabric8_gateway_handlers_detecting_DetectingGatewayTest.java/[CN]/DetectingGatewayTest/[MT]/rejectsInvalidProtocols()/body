{
  final DetectingGateway gateway=createGateway();
  final Socket socket=new Socket("localhost",gateway.getBoundPort());
  final OutputStream outputStream=socket.getOutputStream();
  within(2,TimeUnit.SECONDS,new Callable<Object>(){
    @Override public Object call() throws Exception {
      assertEquals(1,gateway.getConnectingClients().length);
      return null;
    }
  }
);
  within(2,TimeUnit.SECONDS,new Callable<Object>(){
    @Override public Object call() throws Exception {
      try {
        outputStream.write("Hello World!\n".getBytes());
        fail("Expected exception.");
      }
 catch (      IOException e) {
      }
      return null;
    }
  }
);
  socket.close();
  assertEquals(1,gateway.getReceivedConnectionAttempts());
  assertEquals(1,gateway.getFailedConnectionAttempts());
  assertEquals(0,gateway.getSuccessfulConnectionAttempts());
  assertEquals(0,gateway.getConnectingClients().length);
  assertEquals(0,gateway.getConnectedClients().length);
}
