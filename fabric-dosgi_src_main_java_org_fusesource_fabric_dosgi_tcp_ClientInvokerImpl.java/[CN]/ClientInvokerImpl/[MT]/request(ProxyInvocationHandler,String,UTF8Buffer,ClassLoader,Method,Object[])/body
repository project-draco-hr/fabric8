{
  final long correlation=correlationGenerator.incrementAndGet();
  DataByteArrayOutputStream baos=new DataByteArrayOutputStream((int)(handler.lastRequestSize * 1.10));
  baos.writeInt(0);
  baos.writeVarLong(correlation);
  baos.writeVarInt(service.length);
  baos.write(service);
  int p1=baos.position();
  ObjectOutputStream oos=new ObjectOutputStream(baos);
  oos.writeUTF(method.getName());
  oos.writeObject(method.getParameterTypes());
  int p2=baos.position();
  oos.writeObject(args);
  final Buffer command=baos.toBuffer();
  BufferEditor editor=command.buffer().bigEndianEditor();
  editor.writeInt(command.length);
  handler.lastRequestSize=command.length;
  final ResponseFuture future=new ResponseFuture(classLoader);
  queue.execute(new Runnable(){
    public void run(){
      try {
        TransportPool pool=transports.get(address);
        if (pool == null) {
          pool=new InvokerTransportPool(address,queue);
          transports.put(address,pool);
          pool.start();
        }
        requests.put(correlation,future);
        pool.offer(command);
      }
 catch (      Exception e) {
        LOGGER.info("Error while sending request",e);
      }
    }
  }
);
  return future.get(5,TimeUnit.SECONDS);
}
