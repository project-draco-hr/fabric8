{
  Version version=fabricService.getVersion(versionId);
  String parentProfileName=replicated ? MQ_PROFILE_REPLICATED : MQ_PROFILE_BASE;
  if (configs != null && configs.containsKey("parent")) {
    parentProfileName=configs.remove("parent");
  }
  Profile parentProfile=version.getProfile(parentProfileName);
  String pidName=getBrokerPID(brokerName);
  Profile result=parentProfile;
  if (brokerName != null && profile != null) {
    Map config=null;
    if (!version.hasProfile(profile)) {
      result=version.createProfile(profile);
      result.setParents(new Profile[]{parentProfile});
    }
 else {
      result=version.getProfile(profile);
      config=result.getConfiguration(pidName);
    }
    Map<String,String> parentProfileConfig=parentProfile.getConfiguration(MQ_PID_TEMPLATE);
    if (config == null) {
      config=parentProfileConfig;
    }
    config.put("broker-name",brokerName);
    if (configs != null) {
      config.putAll(configs);
    }
    String[] propertiesToDefault={CONFIG_URL,STANDBY_POOL,CONNECTORS};
    for (    String key : propertiesToDefault) {
      if (config.get(key) == null) {
        String defaultValue=parentProfileConfig.get(key);
        if (Strings.isNotBlank(defaultValue)) {
          config.put(key,defaultValue);
        }
      }
    }
    result.setConfiguration(pidName,config);
  }
  return result;
}
