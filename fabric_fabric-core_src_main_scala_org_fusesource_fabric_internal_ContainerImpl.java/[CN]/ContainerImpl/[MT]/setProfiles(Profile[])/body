{
  String versionId=service.getDataStore().getContainerVersion(id);
  List<String> currentProfileIds=service.getDataStore().getContainerProfiles(id);
  List<String> profileIds=new ArrayList<String>();
  for (  Profile profile : profiles) {
    if (!versionId.equals(profile.getVersion())) {
      throw new IllegalArgumentException("Version mismatch setting profile " + profile.getId() + " with version "+ profile.getVersion()+ " expected version "+ versionId);
    }
 else     if (profile.isAbstract()) {
      throw new IllegalArgumentException("The profile " + profile.getId() + " is abstract and can not "+ "be associated to containers");
    }
 else     if (profile.getId().matches(ENSEMBLE_PROFILE_PATTERN) && !currentProfileIds.contains(profile.getId())) {
      throw new IllegalArgumentException("The profile " + profile.getId() + " is not assignable.");
    }
    profileIds.add(profile.getId());
  }
  if (profileIds.isEmpty()) {
    profileIds.add(ZkDefs.DEFAULT_PROFILE);
  }
  service.getDataStore().setContainerProfiles(id,profileIds);
}
