{
  URL artifactUrl=parameters.getUrl();
  File libDir=new File(installDir,"lib");
  libDir.mkdirs();
  Map<File,File> copyFiles=new HashMap<File,File>();
  if (artifactUrl != null) {
    copyArtifactAndDependencies(config,id,installDir,parameters,libDir,copyFiles);
  }
  copyJarFiles(id,installDir,parameters,libDir,copyFiles);
  Set<Map.Entry<File,File>> entries=copyFiles.entrySet();
  Map<File,Long> checksums=ChecksumUtils.loadInstalledChecksumCache(libDir);
  Set<File> filesToRemove=new HashSet<File>();
  filesToRemove.addAll(checksums.keySet());
  for (  Map.Entry<File,File> entry : entries) {
    File source=entry.getKey();
    File dest=entry.getValue();
    long checksum=ChecksumUtils.checksumFile(source);
    filesToRemove.remove(dest);
    checksums.put(source,checksum);
  }
  for (  File fileToRemove : filesToRemove) {
    LOG.info("Removing: " + fileToRemove);
    checksums.remove(fileToRemove);
    installContext.addRestartReason(fileToRemove);
    fileToRemove.delete();
  }
  ChecksumUtils.saveInstalledChecksumCache(libDir,checksums);
  for (  Map.Entry<File,File> entry : entries) {
    File sourceFile=entry.getKey();
    File destFile=entry.getValue();
    FileChangeInfo changeInfo=installContext.createChangeInfo(destFile);
    Files.copy(sourceFile,destFile);
    installContext.onFileWrite(destFile,changeInfo);
  }
}
