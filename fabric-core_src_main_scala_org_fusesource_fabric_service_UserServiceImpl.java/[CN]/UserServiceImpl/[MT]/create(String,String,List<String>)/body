{
  try {
    Properties props=ZooKeeperUtils.getProperties(service.getZooKeeper(),UserService.USERS_NODE,null);
    if (props.containsKey(username)) {
      throw new FabricException("User " + username + " already exists");
    }
    props.put(username,encryptPassword(password));
    ZooKeeperUtils.setProperties(service.getZooKeeper(),UserService.USERS_NODE,props);
    if (groups != null) {
      Properties groupProps=ZooKeeperUtils.getProperties(service.getZooKeeper(),UserService.GROUPS_NODE,null);
      for (      String group : groups) {
        if (groupProps.containsKey(group)) {
          String users=groupProps.getProperty(group);
          List groupUsers=new ArrayList(Arrays.asList(users.split(",")));
          if (!groupUsers.contains(username)) {
            groupUsers.add(username);
            groupProps.setProperty(group,join(groupUsers));
          }
        }
 else {
          groupProps.setProperty(group,username);
        }
      }
      ZooKeeperUtils.setProperties(service.getZooKeeper(),UserService.GROUPS_NODE,groupProps);
    }
    return null;
  }
 catch (  Exception e) {
    throw new FabricException(e);
  }
}
