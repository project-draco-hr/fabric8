{
  Configuration configuration=null;
  if (configurationAdmin != null) {
    try {
      Configuration[] configurations=configurationAdmin.listConfigurations(String.format(FACTORY_FILTER,factoryPid));
      if (configurations != null) {
        for (        Configuration conf : configurations) {
          Dictionary dictionary=conf.getProperties();
          if (dictionary != null && id != null) {
            if (id.equals(dictionary.get(Constants.JCLOUDS_SERVICE_ID))) {
              return conf;
            }
          }
 else {
            if (dictionary != null && provider != null && provider.equals(dictionary.get("provider"))) {
              return conf;
            }
            if (dictionary != null && api != null && api.equals(dictionary.get("api"))) {
              return conf;
            }
          }
        }
      }
    }
 catch (    Exception e) {
      LOGGER.warn("Failed to lookup configuration admin for existing cloud providers.",e);
    }
    LOGGER.debug("No configuration found with factoryPid org.jclouds.compute. Creating new one.");
    configuration=configurationAdmin.createFactoryConfiguration(factoryPid,null);
  }
  return configuration;
}
