{
  Callback[] callbacks=new Callback[2];
  callbacks[0]=new NameCallback("Username: ");
  callbacks[1]=new PasswordCallback("Password: ",false);
  try {
    callbackHandler.handle(callbacks);
  }
 catch (  IOException ioe) {
    throw new LoginException(ioe.getMessage());
  }
catch (  UnsupportedCallbackException uce) {
    throw new LoginException(uce.getMessage() + " not available to obtain information from user");
  }
  user=((NameCallback)callbacks[0]).getName();
  char[] tmpPassword=((PasswordCallback)callbacks[1]).getPassword();
  if (tmpPassword == null) {
    tmpPassword=new char[0];
  }
  if (user == null) {
    throw new FailedLoginException("user name is null");
  }
  String userInfos=users.getProperty(user);
  if (userInfos == null) {
    throw new FailedLoginException("User doesn't exist");
  }
  String[] infos=userInfos.split(",");
  String password=infos[0];
  if (!checkPassword(new String(tmpPassword),password)) {
    throw new FailedLoginException("Password does not match");
  }
  principals=new HashSet<Principal>();
  principals.add(new org.apache.karaf.jaas.modules.UserPrincipal(user));
  for (int i=1; i < infos.length; i++) {
    principals.add(new RolePrincipal(infos[i]));
  }
  if (debug) {
    LOG.debug("Successfully logged in {}",user);
  }
  return true;
}
