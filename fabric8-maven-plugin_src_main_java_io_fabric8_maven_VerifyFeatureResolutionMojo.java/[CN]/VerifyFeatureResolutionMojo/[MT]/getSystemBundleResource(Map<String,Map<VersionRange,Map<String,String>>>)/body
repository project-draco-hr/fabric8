{
  Artifact karafDistro=pluginDescriptor.getArtifactMap().get(distribution);
  String dir=distDir;
  if (dir == null) {
    dir=karafDistro.getArtifactId() + "-" + karafDistro.getBaseVersion();
  }
  URL configPropURL=new URL("jar:file:" + karafDistro.getFile() + "!/"+ dir+ "/etc/config.properties");
  org.apache.felix.utils.properties.Properties configProps=PropertiesLoader.loadPropertiesFile(configPropURL,true);
  if (javase == null) {
    configProps.put("java.specification.version",System.getProperty("java.specification.version"));
  }
 else {
    configProps.put("java.specification.version",javase);
  }
  configProps.substitute();
  Attributes attributes=new Attributes();
  attributes.putValue(Constants.BUNDLE_MANIFESTVERSION,"2");
  attributes.putValue(Constants.BUNDLE_SYMBOLICNAME,"system-bundle");
  attributes.putValue(Constants.BUNDLE_VERSION,"0.0.0");
  String exportPackages=configProps.getProperty("org.osgi.framework.system.packages");
  if (configProps.containsKey("org.osgi.framework.system.packages.extra")) {
    exportPackages+="," + configProps.getProperty("org.osgi.framework.system.packages.extra");
  }
  attributes.putValue(Constants.EXPORT_PACKAGE,exportPackages);
  String systemCaps=configProps.getProperty("org.osgi.framework.system.capabilities");
  attributes.putValue(Constants.PROVIDE_CAPABILITY,systemCaps);
  attributes=DeploymentBuilder.overrideAttributes(attributes,metadata);
  Map<String,String> headers=new HashMap<String,String>();
  for (  Map.Entry attr : attributes.entrySet()) {
    headers.put(attr.getKey().toString(),attr.getValue().toString());
  }
  Resource resource=ResourceBuilder.build("system-bundle",headers);
  return resource;
}
