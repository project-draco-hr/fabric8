{
  int size=1;
  byte formatCode=TypeRegistry.instance().picker().chooseMapEncoding(value);
switch (formatCode) {
case NULL_FORMAT_CODE:
    return size;
case MAP_MAP8_CODE:
  size+=MAP_MAP8_WIDTH * 2;
break;
case MAP_MAP32_CODE:
size+=MAP_MAP32_WIDTH * 2;
break;
default :
throw new RuntimeException("Unknown format code 0x" + String.format("%x",formatCode));
}
for (Object key : value.keySet()) {
size+=((AMQPType)key).size();
Object obj=value.get(key);
if (obj == null) {
size+=1;
}
 else {
size+=((AMQPType)obj).size();
}
}
return size;
}
