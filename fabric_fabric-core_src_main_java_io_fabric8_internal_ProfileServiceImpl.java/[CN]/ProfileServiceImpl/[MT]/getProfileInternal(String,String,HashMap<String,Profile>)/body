{
  Profile profile=profiles.get(profileId);
  if (profile == null) {
    profile=profileRegistry.get().getProfile(versionId,profileId);
    if (profile != null) {
      ProfileBuilder builder=ProfileBuilder.Factory.createFrom(profile);
      String parentsAttr=profile.getAttributes().get(Profile.PARENTS);
      if (parentsAttr != null && !parentsAttr.isEmpty()) {
        for (        String parentId : parentsAttr.trim().split(" ")) {
          Profile parent=getProfileInternal(versionId,parentId,profiles);
          IllegalStateAssertion.assertNotNull(parent,"Cannot obtain parent profile: " + parentId);
          builder.addParent(parent);
        }
      }
      profile=builder.getProfile();
      profiles.put(profile.getId(),profile);
    }
  }
  return profile;
}
