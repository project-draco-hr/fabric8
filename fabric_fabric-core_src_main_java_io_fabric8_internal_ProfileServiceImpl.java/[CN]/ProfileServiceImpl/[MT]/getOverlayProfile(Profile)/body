{
  assertValid();
  Profile overlayProfile;
  if (profile.isOverlay()) {
    LOGGER.debug("getOverlayProfile, given profile is already an overlay: " + profile);
    overlayProfile=profile;
  }
 else {
    String profileId=profile.getId();
    String environment=runtimeProperties.get().getProperty(SystemProperties.FABRIC_ENVIRONMENT);
    ProfileBuilder builder=ProfileBuilder.Factory.create(profile.getVersion(),profileId);
    builder.addOptions(new OverlayOptionsProvider(profile,environment));
    overlayProfile=builder.getProfile();
    if (LOGGER.isDebugEnabled()) {
synchronized (lastOverlayProfiles) {
        Profile lastOverlay=lastOverlayProfiles.get(profileId);
        String longString=Profiles.getProfileInfo(overlayProfile,true);
        String lastString=lastOverlay != null ? Profiles.getProfileInfo(lastOverlay,true) : null;
        if (lastOverlay == null || !longString.equals(lastString)) {
          LOGGER.debug("Changed Overlay" + longString);
          if (lastOverlay != null) {
            LOGGER.debug("Overlay" + Profiles.getProfileDifference(lastOverlay,overlayProfile));
          }
          LOGGER.debug("Called from ",new RuntimeException());
          lastOverlayProfiles.put(profileId,overlayProfile);
        }
      }
    }
  }
  return overlayProfile;
}
