{
  Profile overlayProfile;
  if (profile.isOverlay()) {
    overlayProfile=profile;
  }
 else {
    String environment=runtimeProperties.get().getProperty(SystemProperties.FABRIC_ENVIRONMENT);
    ProfileBuilder builder=ProfileBuilder.Factory.create(profile.getVersion(),profile.getId());
    builder.addOptions(new OverlayOptionsProvider(profile,environment));
    overlayProfile=builder.getProfile();
synchronized (this) {
      String longString=overlayProfile.toLongString();
      if (!longString.equals(lastOverlayProfile)) {
        LOGGER.info("Changed Overlay" + longString);
        LOGGER.info("Called from ",new RuntimeException());
        lastOverlayProfile=longString;
      }
    }
  }
  return overlayProfile;
}
