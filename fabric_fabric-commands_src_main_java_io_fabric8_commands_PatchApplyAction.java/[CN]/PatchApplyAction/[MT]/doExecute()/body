{
  List<Version> versions;
  ProfileService profileService=fabricService.adapt(ProfileService.class);
  if (versionId != null && !versionId.isEmpty()) {
    Version version=profileService.getRequiredVersion(versionId);
    versions=Collections.singletonList(version);
  }
 else   if (allVersions) {
    versions=new ArrayList<>();
    for (    String versionId : profileService.getVersions()) {
      versions.add(profileService.getRequiredVersion(versionId));
    }
  }
 else {
    versions=Collections.singletonList(fabricService.getDefaultVersion());
  }
  username=username != null && !username.isEmpty() ? username : ShellUtils.retrieveFabricUser(session);
  password=password != null ? password : ShellUtils.retrieveFabricUserPassword(session);
  for (  Version version : versions) {
    fabricService.getPatchService().applyPatch(version,patch,username,password);
  }
  return null;
}
