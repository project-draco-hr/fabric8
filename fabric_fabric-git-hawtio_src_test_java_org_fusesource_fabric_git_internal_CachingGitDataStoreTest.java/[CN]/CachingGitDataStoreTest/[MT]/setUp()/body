{
  sfb=new ZKServerFactoryBean();
  delete(sfb.getDataDir());
  delete(sfb.getDataLogDir());
  sfb.afterPropertiesSet();
  CuratorFrameworkFactory.Builder builder=CuratorFrameworkFactory.builder().connectString("localhost:" + sfb.getClientPortAddress().getPort()).retryPolicy(new RetryOneTime(1000)).connectionTimeoutMs(360000);
  curator=builder.build();
  curator.start();
  curator.getZookeeperClient().blockUntilConnectedOrTimedOut();
  basedir=System.getProperty("basedir",".");
  File root=new File(basedir + "/target/git").getCanonicalFile();
  delete(root);
  new File(root,"remote").mkdirs();
  remote=Git.init().setDirectory(new File(root,"remote")).call();
  remote.commit().setMessage("First Commit").setCommitter("fabric","user@fabric").call();
  String remoteUrl="file://" + new File(root,"remote").getCanonicalPath();
  new File(root,"local").mkdirs();
  git=Git.init().setDirectory(new File(root,"local")).call();
  git.commit().setMessage("First Commit").setCommitter("fabric","user@fabric").call();
  StoredConfig config=git.getRepository().getConfig();
  config.setString("remote","origin","url",remoteUrl);
  config.setString("remote","origin","fetch","+refs/heads/*:refs/remotes/origin/*");
  config.save();
  FabricGitServiceImpl gitService=new FabricGitServiceImpl();
  gitService.activate();
  gitService.setGitForTesting(git);
  DataStoreTemplateRegistry registrationHandler=new DataStoreTemplateRegistry();
  registrationHandler.activateComponent();
  dataStore=new CachingGitDataStore();
  dataStore.bindCurator(curator);
  dataStore.bindGitService(gitService);
  dataStore.bindRegistrationHandler(registrationHandler);
  Map<String,String> datastoreProperties=new HashMap<String,String>();
  datastoreProperties.put(GitDataStore.GIT_REMOTE_URL,remoteUrl);
  dataStore.activate(datastoreProperties);
}
