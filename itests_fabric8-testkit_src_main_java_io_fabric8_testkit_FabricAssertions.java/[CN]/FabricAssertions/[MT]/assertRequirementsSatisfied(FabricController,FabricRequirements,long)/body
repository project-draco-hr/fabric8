{
  assertNotNull("FabricController",controller);
  assertNotNull("FabricRequirements",requirements);
  assertNotNull("Should have some FabricRequirements",requirements);
  waitForValidValue(timeout,new Callable<Boolean>(){
    boolean hasUpdatedRequirements=false;
    @Override public Boolean call() throws Exception {
      controller.setRequirements(requirements);
      FabricRequirements actual=controller.getRequirements();
      String actualVersion=actual.getVersion();
      actual.setVersion(requirements.getVersion());
      requirements.sortProfilesRequirements();
      actual.sortProfilesRequirements();
      boolean valid=RequirementsJson.equal(requirements,actual);
      if (!valid) {
        System.out.println("Expected: " + RequirementsJson.toJSON(requirements));
        System.out.println("Actual:   " + RequirementsJson.toJSON(actual));
        System.out.println();
        return false;
      }
      if (!hasUpdatedRequirements) {
        hasUpdatedRequirements=true;
        System.out.println("Updated the requirements to: " + RequirementsJson.toJSON(requirements));
      }
      List<ProfileRequirements> profileRequirements=requirements.getProfileRequirements();
      assertNotNull("Should have some profileRequirements",profileRequirements);
      String version=requirementOrDefaultVersion(controller,requirements);
      for (      ProfileRequirements profileRequirement : profileRequirements) {
        Integer minimumInstances=profileRequirement.getMinimumInstances();
        Integer maximumInstances=profileRequirement.getMaximumInstances();
        if (minimumInstances != null) {
          String profile=profileRequirement.getProfile();
          List<String> containerIds=controller.containerIdsForProfile(version,profile);
          int current=containerIds.size();
          if (current < minimumInstances) {
            System.out.println("Still waiting for " + minimumInstances + " instance(s) of profile "+ profile+ " currently has: "+ containerIds);
            valid=false;
            break;
          }
 else {
            if (checkMinimumInstancesSuccessful(controller,profile,minimumInstances,containerIds)) {
              if (minimumInstances > 0) {
                System.out.println("Valid profile " + profile + " requires "+ minimumInstances+ " instance(s) and has: "+ containerIds);
              }
            }
 else {
              valid=false;
            }
          }
        }
        if (maximumInstances != null) {
          String profile=profileRequirement.getProfile();
          List<ContainerDTO> containers=controller.containersForProfile(version,profile);
          List<ContainerDTO> aliveContainers=Containers.aliveAndSuccessfulContainers(containers);
          int current=aliveContainers.size();
          if (current > maximumInstances) {
            System.out.println("Still waiting for a maximum of " + maximumInstances + " instance(s) of profile "+ profile+ " currently has: "+ current+ " containers alive which need stopping");
            valid=false;
            break;
          }
 else {
            System.out.println("Profile scaled down: now running a maximum of " + maximumInstances + " instance(s) of profile "+ profile+ " currently has: "+ current+ " container(s)");
          }
        }
      }
      if (valid) {
        System.out.println("Fabric requirements are all satisfied!");
      }
      return valid;
    }
  }
);
}
