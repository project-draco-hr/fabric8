{
  String defaultVersion=dataStore.getDefaultVersion();
  assertEquals("defaultVersion","1.0",defaultVersion);
  String importPath=basedir + "/../fabric8-karaf/src/main/resources/distro/fabric/import";
  if (useOldImportFormat) {
    assertFolderExists(importPath);
    dataStore.importFromFileSystem(importPath);
    assertHasVersion(defaultVersion);
  }
 else {
    String prefix=importPath + "/fabric";
    String profileImport=prefix + "/configs/versions/1.0/profiles";
    assertFolderExists(profileImport);
    dataStore.importFromFileSystem(new File(profileImport),"fabric","1.0",true);
    assertHasVersion(defaultVersion);
  }
  remote.checkout().setName("1.0").call();
  String importedProfile="example-dozer";
  String profile=importedProfile;
  assertProfileExists(defaultVersion,profile);
  String version="1.1";
  assertCreateVersion("1.0",version);
  assertProfileConfiguration(version,importedProfile,Constants.AGENT_PID,"attribute.parents","feature-camel");
  assertProfileTextFileConfigurationContains(version,"example-camel-mq","camel.xml","http://camel.apache.org/schema/blueprint");
  List<String> fileNames=dataStore.getConfigurationFileNames(version,"example-camel-mq");
  assertNotNull("Should have some file names",fileNames);
  assertTrue("Should have some file names",fileNames.size() > 0);
  assertTrue("Should contain 'came",fileNames.size() > 0);
  assertCollectionContains("configurationFileNames",fileNames,"camel.xml");
  Map<String,String> profileAttributes=dataStore.getProfileAttributes(version,importedProfile);
  String parent=profileAttributes.get("parents");
  assertEquals(importedProfile + ".profileAttributes[parent]","feature-camel",parent);
  System.out.println("Profile attributes: " + profileAttributes);
  String profileAttributeKey="myKey";
  String expectedProfileAttributeValue="myValue";
  dataStore.setProfileAttribute(version,importedProfile,profileAttributeKey,expectedProfileAttributeValue);
  profileAttributes=dataStore.getProfileAttributes(version,importedProfile);
  System.out.println("Profile attributes: " + profileAttributes);
  assertMapContains("Profile attribute[" + profileAttributeKey + "]",profileAttributes,profileAttributeKey,expectedProfileAttributeValue);
  String hawtioRepoKey="repository.hawtio";
  Map<String,String> hawtioAttrbutes=dataStore.getConfiguration(version,"hawtio",Constants.AGENT_PID);
  String currentHawtRepo=hawtioAttrbutes.get(hawtioRepoKey);
  System.out.println("Current repository.hawtio: " + currentHawtRepo);
  FabricGitFacade hawtio=new FabricGitFacade();
  hawtio.bindGitDataStoreForTesting(dataStore);
  hawtio.activateForTesting();
  String hawtioPropertyFile="/fabric/profiles/" + dataStore.convertProfileIdToDirectory("hawtio") + "/"+ Constants.AGENT_PID+ ".properties";
  hawtio.write(version,hawtioPropertyFile,"My commit message","me","me@apache.org","# new file\n" + hawtioRepoKey + " = "+ "mvn\\:io.hawt/hawtio-karaf/myNewVersion/xml/features"+ "\n");
  hawtioAttrbutes=dataStore.getConfiguration(version,"hawtio",Constants.AGENT_PID);
  String actual=hawtioAttrbutes.get(hawtioRepoKey);
  assertEquals("should have found the updated hawtio repo key","mvn:io.hawt/hawtio-karaf/myNewVersion/xml/features",actual);
  Map<String,byte[]> tomcatFileConfigurations=dataStore.getFileConfigurations("1.0","controller-tomcat");
  assertHasFileConfiguration(tomcatFileConfigurations,"tomcat/conf/server.xml.mvel");
  Collection<String> schemas=dataStore.listFiles("1.0",Arrays.asList("example-dozer"),"schemas");
  assertNotNull(schemas);
  assertContainerEquals("schemas for example-dozer",Arrays.asList("invoice.xsd"),new ArrayList<String>(schemas));
  String profileNotCreated="shouldNotBeCreated";
  assertEquals("Should not create profile: " + profileNotCreated,null,dataStore.getProfile(version,profileNotCreated,false));
  assertProfileNotExists(defaultVersion,profileNotCreated);
  assertFolderNotExists(getLocalGitFile("fabric/profiles/" + dataStore.convertProfileIdToDirectory(profileNotCreated)));
  String newProfile="myNewProfile";
  dataStore.createProfile(version,newProfile);
  assertProfileExists(version,newProfile);
  String anotherNewProfile="anotherNewProfile";
  dataStore.getProfile(version,anotherNewProfile,true);
  assertProfileExists(version,anotherNewProfile);
  version="1.2";
  assertCreateVersion("1.1",version);
  assertProfileExists(version,newProfile);
  assertProfileExists(version,profile);
  dataStore.deleteProfile(version,newProfile);
  assertProfileNotExists(version,newProfile);
  remote.checkout().setName("1.1").call();
  assertProfileExists("1.1",profile);
  assertProfileExists("1.1",newProfile);
  assertFolderExists(getRemoteGitFile("fabric/profiles/" + dataStore.convertProfileIdToDirectory(profile)));
  assertFolderExists(getRemoteGitFile("fabric/profiles/" + dataStore.convertProfileIdToDirectory(newProfile)));
  remote.checkout().setName("1.2").call();
  assertProfileExists("1.2",profile);
  assertProfileNotExists("1.2",newProfile);
  assertFolderExists(getRemoteGitFile("fabric/profiles/" + dataStore.convertProfileIdToDirectory(profile)));
  assertFolderNotExists(getRemoteGitFile("fabric/profiles/" + dataStore.convertProfileIdToDirectory(newProfile)));
  remote.checkout().setName("1.0").call();
  assertFolderExists(getRemoteGitFile("fabric/profiles/" + dataStore.convertProfileIdToDirectory(profile)));
  assertFolderNotExists(getRemoteGitFile("fabric/profiles/" + dataStore.convertProfileIdToDirectory(newProfile)));
  assertHasVersion("1.1");
  assertHasVersion("1.2");
  dataStore.removeVersion("1.2");
  assertHasVersion("1.1");
  assertHasNotVersion("1.2");
  Collection<String> remoteBranches=RepositoryUtils.getBranches(remote.getRepository());
  System.out.println("Remote branches after delete: " + remoteBranches);
}
