{
  if (context.isRequirePull() || context.isRequireCommit()) {
    assertWriteLock();
  }
 else {
    assertReadLock();
  }
  ClassLoader tccl=Thread.currentThread().getContextClassLoader();
  try {
    ClassLoader gitcl=GitDataStoreImpl.class.getClassLoader();
    Thread.currentThread().setContextClassLoader(gitcl);
    LOGGER.trace("Setting ThreadContextClassLoader to {} instead of {}",gitcl,tccl);
    Git git=getGit();
    Repository repository=git.getRepository();
    if (personIdent == null) {
      personIdent=new PersonIdent(repository);
    }
    if (context.isRequirePull()) {
      if (doPullInternal(git,context,getCredentialsProvider(),false)) {
        versionCache.invalidateAll();
        notificationRequired=true;
      }
    }
    T result=operation.call(git,context);
    if (context.isRequireCommit()) {
      doCommit(git,context);
      versionCache.invalidateAll();
      notificationRequired=true;
    }
    if (context.isRequirePush()) {
      doPushInternal(git,context,getCredentialsProvider(),null);
    }
    return result;
  }
 catch (  Exception e) {
    throw FabricException.launderThrowable(e);
  }
 finally {
    LOGGER.trace("Restoring ThreadContextClassLoader to {}",tccl);
    Thread.currentThread().setContextClassLoader(tccl);
  }
}
