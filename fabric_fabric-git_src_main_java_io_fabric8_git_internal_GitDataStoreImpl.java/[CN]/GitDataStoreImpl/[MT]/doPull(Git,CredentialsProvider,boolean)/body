{
  try {
    Repository repository=git.getRepository();
    StoredConfig config=repository.getConfig();
    String url=config.getString("remote",remoteRef.get(),"url");
    if (Strings.isNullOrBlank(url)) {
      if (LOGGER.isDebugEnabled()) {
        LOGGER.debug("No remote repository defined for the git repository at " + GitHelpers.getRootGitDirectory(git) + " so not doing a pull");
      }
      return;
    }
    doResetHard(git);
    boolean hasChanged=false;
    try {
      LOGGER.debug("Performing a fetch in git repository {} on remote URL: {}",GitHelpers.getRootGitDirectory(git),url);
      FetchResult result=git.fetch().setTimeout(gitTimeout).setCredentialsProvider(credentialsProvider).setRemote(remoteRef.get()).call();
      LOGGER.debug("Git fetch result: {}",result.getMessages());
      lastFetchWarning=null;
    }
 catch (    Exception ex) {
      String fetchWarning=ex.getMessage();
      if (!fetchWarning.equals(lastFetchWarning)) {
        LOGGER.warn("Fetch failed because of: " + fetchWarning);
        LOGGER.debug("Fetch failed - the error will be ignored",ex);
        lastFetchWarning=fetchWarning;
      }
      return;
    }
    Map<String,Ref> localBranches=new HashMap<String,Ref>();
    Map<String,Ref> remoteBranches=new HashMap<String,Ref>();
    Set<String> gitVersions=new HashSet<String>();
    for (    Ref ref : git.branchList().setListMode(ListBranchCommand.ListMode.ALL).call()) {
      if (ref.getName().startsWith("refs/remotes/" + remoteRef.get() + "/")) {
        String name=ref.getName().substring(("refs/remotes/" + remoteRef.get() + "/").length());
        remoteBranches.put(name,ref);
        gitVersions.add(name);
      }
 else       if (ref.getName().startsWith("refs/heads/")) {
        String name=ref.getName().substring(("refs/heads/").length());
        localBranches.put(name,ref);
        gitVersions.add(name);
      }
    }
    for (    String version : gitVersions) {
      if (remoteBranches.isEmpty()) {
      }
 else       if (!remoteBranches.containsKey(version)) {
        if (doDeleteBranches && !version.equals(MASTER_BRANCH)) {
          try {
            git.branchDelete().setBranchNames(localBranches.get(version).getName()).setForce(true).call();
          }
 catch (          CannotDeleteCurrentBranchException ex) {
            git.checkout().setName(MASTER_BRANCH).setForce(true).call();
            git.branchDelete().setBranchNames(localBranches.get(version).getName()).setForce(true).call();
          }
          removeVersionFromCaches(version);
          hasChanged=true;
        }
      }
 else       if (!localBranches.containsKey(version)) {
        addVersion(version);
        git.checkout().setCreateBranch(true).setName(version).setStartPoint(remoteRef.get() + "/" + version).setUpstreamMode(CreateBranchCommand.SetupUpstreamMode.TRACK).setForce(true).call();
        hasChanged=true;
      }
 else {
        String localCommit=localBranches.get(version).getObjectId().getName();
        String remoteCommit=remoteBranches.get(version).getObjectId().getName();
        if (!localCommit.equals(remoteCommit)) {
          git.clean().setCleanDirectories(true).call();
          git.checkout().setName("HEAD").setForce(true).call();
          git.checkout().setName(version).setForce(true).call();
          MergeResult result=git.merge().setStrategy(MergeStrategy.THEIRS).include(remoteBranches.get(version).getObjectId()).call();
          if (result.getMergeStatus() != MergeResult.MergeStatus.ALREADY_UP_TO_DATE && hasChanged(git,localCommit,remoteCommit)) {
            hasChanged=true;
          }
        }
      }
    }
    if (hasChanged) {
      LOGGER.debug("Changed after pull!");
      if (credentialsProvider != null) {
        GitHelpers.getProfilesDirectory(git);
      }
      dataStore.get().fireChangeNotifications();
    }
  }
 catch (  Throwable ex) {
    LOGGER.debug("Failed to pull from the remote git repo " + GitHelpers.getRootGitDirectory(git),ex);
    LOGGER.warn("Failed to pull from the remote git repo " + GitHelpers.getRootGitDirectory(git) + " due "+ ex.getMessage()+ ". This exception is ignored.");
  }
}
