{
  assertWriteLock();
  String versionId=profile.getVersion();
  String profileId=profile.getId();
  if (!profiles.contains(profileId)) {
    List<Profile> parents=profile.getParents();
    for (    Profile parent : parents) {
      Profile lastParent=getProfileFromCache(parent.getVersion(),parent.getId());
      createOrUpdateProfile(context,lastParent,parent,profiles);
    }
    if (lastProfile == null) {
      LOGGER.debug("Create {}",Profiles.getProfileInfo(profile,false));
    }
 else {
      LOGGER.debug("Update {}",profile);
      LOGGER.debug("Update {}",Profiles.getProfileDifference(lastProfile,profile));
    }
    if (lastProfile == null) {
      createProfileDirectoryAfterCheckout(context,versionId,profileId);
    }
    Map<String,byte[]> fileConfigurations=profile.getFileConfigurations();
    setFileConfigurations(context,versionId,profileId,fileConfigurations);
    if (context.getCommitMessage().length() == 0) {
      context.commitMessage("WARNING - Profile with no content: " + versionId + "/"+ profileId);
    }
    profiles.add(profileId);
  }
  return profileId;
}
