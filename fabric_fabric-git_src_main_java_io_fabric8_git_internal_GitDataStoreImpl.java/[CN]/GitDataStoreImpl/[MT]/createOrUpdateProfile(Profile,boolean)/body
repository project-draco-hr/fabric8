{
  assertWriteLock();
  final String versionId=profile.getVersion();
  final String profileId=profile.getId();
  GitContext context=new GitContext().requirePull();
  getOrCreateProfileInternal(context,versionId,profileId,allowCreate);
  context.setRequirePull(false);
  for (  Entry<String,String> entry : profile.getAttributes().entrySet()) {
    setProfileAttributeInternal(context,versionId,profileId,entry.getKey(),entry.getValue());
  }
  List<Profile> parents=profile.getParents();
  if (parents.size() > 0) {
    StringBuilder sb=new StringBuilder();
    for (    Profile parent : parents) {
      if (sb.length() > 0) {
        sb.append(" ");
      }
      sb.append(parent.getId());
    }
    setProfileAttributeInternal(context,versionId,profileId,Profile.PARENTS,sb.toString());
  }
  Map<String,byte[]> fileConfigurations=profile.getFileConfigurations();
  if (!fileConfigurations.isEmpty()) {
    setFileConfigurationsInternal(context,versionId,profileId,fileConfigurations);
  }
  Map<String,Map<String,String>> configurations=profile.getConfigurations();
  if (!configurations.isEmpty()) {
    setConfigurationsInternal(context,versionId,profileId,configurations);
  }
  doCommit(getGit(),context.requireCommit().requirePush());
  return profileId;
}
