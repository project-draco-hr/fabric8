{
  final String messageConverterRef=dispatchPolicy.getMessageConverterRef();
  if (StringUtils.hasText(messageConverterRef)) {
    final String filter="(" + Constants.SERVICE_PID + "="+ messageConverterRef+ ")";
    ServiceReference[] serviceReferences;
    try {
      serviceReferences=bundleContext.getServiceReferences(MESSAGE_CONVERTER_CLASS_NAME,filter);
    }
 catch (    InvalidSyntaxException e1) {
      String msg="Error looking up " + messageConverterRef + " with filter ["+ filter+ "]";
      LOG.error(msg);
      throw new ConfigurationException(messageConverterRef,msg);
    }
    if (serviceReferences != null) {
      dispatchPolicy.setMessageConverter((MessageConverter)bundleContext.getService(serviceReferences[0]));
      addServiceReference(pid,serviceReferences[0]);
    }
 else {
      String msg="No service found for " + messageConverterRef + " with filter ["+ filter+ "]";
      LOG.error(msg);
      throw new ConfigurationException(messageConverterRef,msg);
    }
  }
}
