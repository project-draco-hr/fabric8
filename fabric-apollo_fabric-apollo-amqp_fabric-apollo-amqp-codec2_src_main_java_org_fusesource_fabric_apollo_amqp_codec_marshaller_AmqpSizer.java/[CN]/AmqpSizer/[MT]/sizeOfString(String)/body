{
  byte formatCode=TypeRegistry.instance().picker().chooseStringEncoding(value);
  try {
switch (formatCode) {
case TypeRegistry.NULL_FORMAT_CODE:
      return 1;
case AMQPString.STRING_STR8_UTF8_CODE:
    return 1 + AMQPString.STRING_STR8_UTF8_WIDTH + value.getBytes("UTF-8").length;
case AMQPString.STRING_STR32_UTF8_CODE:
  return 1 + AMQPString.STRING_STR32_UTF8_WIDTH + value.getBytes("UTF-8").length;
default :
throw new RuntimeException("Unknown format code 0x" + String.format("%x",formatCode));
}
}
 catch (UnsupportedEncodingException e) {
throw new RuntimeException("UTF-8 encoding not available : " + e.getMessage());
}
}
