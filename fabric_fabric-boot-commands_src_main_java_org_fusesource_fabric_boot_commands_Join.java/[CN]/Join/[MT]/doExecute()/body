{
  org.osgi.service.cm.Configuration config=configurationAdmin.getConfiguration("org.fusesource.fabric.zookeeper");
  Properties properties=new Properties();
  properties.put("zookeeper.url",zookeeperUrl);
  config.setBundleLocation(null);
  config.update(properties);
  ServiceTracker tracker=new ServiceTracker(bundleContext,org.fusesource.fabric.zookeeper.IZKClient.class.getName(),null);
  tracker.open();
  zooKeeper=(org.fusesource.fabric.zookeeper.IZKClient)tracker.waitForService(5000);
  if (zooKeeper == null) {
    throw new IllegalStateException("Timeout waiting for ZooKeeper client to be registered");
  }
  tracker.close();
  zooKeeper.waitForConnected();
  String karafName=System.getProperty("karaf.name");
  ZkPath.createContainerPaths(zooKeeper,karafName,version);
  Bundle bundleFabricJaas=BundleUtils.findOrInstallBundle(bundleContext,"org.fusesource.fabric.fabric-jaas","mvn:org.fusesource.fabric/fabric-jaas/" + FabricConstants.FABRIC_VERSION);
  Bundle bundleFabricCommands=BundleUtils.findOrInstallBundle(bundleContext,"org.fusesource.fabric.fabric-commands","mvn:org.fusesource.fabric/fabric-commands/" + FabricConstants.FABRIC_VERSION);
  bundleFabricJaas.start();
  bundleFabricCommands.start();
  if (!nonManaged) {
    Bundle bundleFabricConfigAdmin=BundleUtils.findOrInstallBundle(bundleContext,"org.fusesource.fabric.fabric-configadmin","mvn:org.fusesource.fabric/fabric-configadmin/" + FabricConstants.FABRIC_VERSION);
    Bundle bundleFabricAgent=BundleUtils.findOrInstallBundle(bundleContext,"org.fusesource.fabric.fabric-agent","mvn:org.fusesource.fabric/fabric-agent/" + FabricConstants.FABRIC_VERSION);
    bundleFabricConfigAdmin.start();
    bundleFabricAgent.start();
  }
  return null;
}
