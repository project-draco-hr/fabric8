{
  for (  ListenerInfo listenerInfo : (Collection<ListenerInfo>)listenerInfos) {
    if (listenerInfo.getBundleContext() == bundleContext || listenerInfo.getFilter() == null) {
      continue;
    }
    SimpleFilter exFilter=listeners.remove(listenerInfo);
    Set<EndpointDescription> matches=remoteEndpoints.match(exFilter);
    for (    EndpointDescription endpoint : matches) {
      Map<Long,ImportRegistration> registrations=importedServices.get(endpoint);
      if (registrations != null) {
        ImportRegistration registration=registrations.get(listenerInfo.getBundleContext().getBundle().getBundleId());
        if (registration != null) {
          registration.removeReference(listenerInfo);
          if (!registration.hasReferences()) {
            registration.getImportedService().unregister();
            registrations.remove(listenerInfo.getBundleContext().getBundle().getBundleId());
          }
        }
      }
    }
  }
}
