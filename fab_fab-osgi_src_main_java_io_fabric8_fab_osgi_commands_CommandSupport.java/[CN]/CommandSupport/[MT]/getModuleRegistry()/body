{
  if (registry == null) {
    ServiceReference ref=getBundleContext().getServiceReference(OsgiModuleRegistry.class.getName());
    if (ref == null) {
      throw new IllegalStateException("ModuleRegistry service is unavailable.");
    }
    registry=getService(OsgiModuleRegistry.class,ref);
  }
  return registry;
}
