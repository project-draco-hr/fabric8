{
  if (responded.compareAndSet(false,true)) {
    Class resultType=getResultType(method);
    try {
      serializationStrategy.encodeResponse(loader,resultType,value,error,responseStream);
    }
 catch (    Exception e) {
      try {
        responseStream.position(pos);
        serializationStrategy.encodeResponse(loader,resultType,value,new RemoteException(e.toString()),responseStream);
      }
 catch (      Exception unexpected) {
        unexpected.printStackTrace();
      }
    }
 finally {
      onComplete.run();
    }
  }
}
