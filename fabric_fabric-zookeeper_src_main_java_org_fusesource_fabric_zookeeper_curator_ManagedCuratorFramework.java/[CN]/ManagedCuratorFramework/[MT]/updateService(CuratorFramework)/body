{
  if (registration != null) {
    registration.unregister();
    try {
      Closeables.close(curatorFramework,true);
    }
 catch (    IOException ex) {
    }
    registration=null;
  }
  ConnectionStateListener listener=new ConnectionStateListener(){
    @Override public void stateChanged(    CuratorFramework client,    ConnectionState newState){
      if (newState == ConnectionState.CONNECTED) {
        ServiceRegistration<CuratorFramework> oldReg;
        ServiceRegistration<CuratorFramework> newReg;
synchronized (ManagedCuratorFramework.this) {
          oldReg=registration;
        }
        if (oldReg == null) {
          newReg=bundleContext.registerService(CuratorFramework.class,curatorFramework,null);
synchronized (ManagedCuratorFramework.this) {
            oldReg=registration;
            if (oldReg == null) {
              registration=newReg;
            }
          }
          if (oldReg == null) {
            client.getConnectionStateListenable().removeListener(this);
          }
 else {
            newReg.unregister();
          }
        }
      }
    }
  }
;
  framework.getConnectionStateListenable().addListener(listener);
  this.curatorFramework=framework;
  if (framework.getZookeeperClient().isConnected()) {
    listener.stateChanged(framework,ConnectionState.CONNECTED);
  }
}
