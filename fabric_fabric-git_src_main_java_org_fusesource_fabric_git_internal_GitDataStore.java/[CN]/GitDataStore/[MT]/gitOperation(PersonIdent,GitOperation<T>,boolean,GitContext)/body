{
synchronized (gitOperationMonitor) {
    assertValid();
    try {
      Git git=getGit();
      Repository repository=git.getRepository();
      CredentialsProvider credentialsProvider=getCredentialsProvider();
      if (personIdent == null) {
        personIdent=new PersonIdent(repository);
      }
      if (GitHelpers.hasGitHead(git)) {
        git.stashCreate().setPerson(personIdent).setWorkingDirectoryMessage("Stash before a write").call();
      }
      String originalBranch=repository.getBranch();
      RevCommit statusBefore=CommitUtils.getHead(repository);
      if (pullFirst) {
        doPull(git,credentialsProvider);
      }
      T answer=operation.call(git,context);
      boolean requirePush=context.isRequirePush();
      if (context.isRequireCommit()) {
        requirePush=true;
        String message=context.getCommitMessage().toString();
        if (message.length() == 0) {
          LOG.warn("No commit message from " + operation + ". Please add one! :)");
        }
        git.commit().setMessage(message).call();
      }
      git.checkout().setName(originalBranch).call();
      if (requirePush || hasChanged(statusBefore,CommitUtils.getHead(repository))) {
        clearCaches();
        doPush(git,context,credentialsProvider);
        fireChangeNotifications();
      }
      return answer;
    }
 catch (    Exception e) {
      throw FabricException.launderThrowable(e);
    }
  }
}
