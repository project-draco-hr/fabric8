{
  LogStreamer streamer=null;
  try {
    PipedInputStream in=new PipedInputStream();
    out=new PrintStream(new PipedOutputStream(in));
    Producer p=new Producer();
    p.setBatchSize(batchSize);
    p.setBatchTimeout(batchTimeout);
    p.setCompress(compress);
    String broker=brokers.get(id % brokers.size());
    p.setBroker(broker);
    String destination=destinations.get(id % destinations.size());
    p.setDestination(destination);
    p.setIs(in);
    streamer=p.configure();
    streamer.start();
    System.out.println(format("Started HTTP log event simulator #" + id + " generating %,.2f events/sec",randomEntriesPerSec));
    startedLatch.countDown();
    long nextMealTime=System.currentTimeMillis() + nextFeedDelay();
    while (!done.get()) {
      long now=System.currentTimeMillis();
      if (now >= nextMealTime) {
        feedTheCamel(now);
        nextMealTime=now + nextFeedDelay();
      }
      long remaining=nextMealTime - now;
      sleep(remaining);
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
 finally {
    try {
      streamer.stop();
    }
 catch (    Throwable e) {
    }
  }
}
