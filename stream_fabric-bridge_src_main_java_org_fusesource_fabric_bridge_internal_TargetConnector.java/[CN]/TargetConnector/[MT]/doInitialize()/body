{
  localConnectionFactory=getConnectionFactory(localBrokerConfig);
  LOG.debug("Using local connection factory " + localConnectionFactory);
  if (remoteBrokerConfig == null && inboundDestinations.isDefaultStagingLocation()) {
    remoteConnectionFactory=localConnectionFactory;
    reuseSession=true;
  }
 else {
    remoteConnectionFactory=getConnectionFactory(remoteBrokerConfig);
    LOG.debug("Using remote connection factory " + remoteConnectionFactory);
    inboundDestinations.setDefaultStagingLocation(false);
    reuseSession=false;
  }
  reuseMessage=false;
  Connection remoteConnection=null;
  Connection localConnection=null;
  try {
    remoteConnection=remoteConnectionFactory.createConnection();
    Session remoteSession=remoteConnection.createSession(false,Session.AUTO_ACKNOWLEDGE);
    Message remoteMessage=remoteSession.createMessage();
    localConnection=localConnectionFactory.createConnection();
    Session localSession=localConnection.createSession(false,Session.AUTO_ACKNOWLEDGE);
    Message localMessage=localSession.createMessage();
    if (remoteMessage.getClass().isInstance(localMessage)) {
      reuseMessage=true;
    }
  }
 catch (  JMSException e) {
    String msg="Error checking whether remote and local broker providers are the same: " + e.getMessage();
    LOG.error(msg,e);
    throw new IllegalStateException(msg,e);
  }
 finally {
    if (remoteConnection != null) {
      try {
        remoteConnection.close();
      }
 catch (      JMSException e) {
      }
    }
    if (localConnection != null) {
      try {
        localConnection.close();
      }
 catch (      JMSException e) {
      }
    }
  }
  createListenerContainer();
  LOG.info("Initialized");
}
