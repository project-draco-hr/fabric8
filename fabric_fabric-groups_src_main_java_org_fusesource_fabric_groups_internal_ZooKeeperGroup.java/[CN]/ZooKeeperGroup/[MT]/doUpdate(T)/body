{
  if (isConnected()) {
    if (state == null) {
      if (id != null) {
        try {
          client.delete().guaranteed().forPath(id);
        }
 catch (        KeeperException.NoNodeException e) {
        }
 finally {
          id=null;
        }
      }
    }
 else {
      if (id == null) {
        refresh(RefreshMode.FORCE_GET_DATA_AND_STAT);
        Map<String,T> members=members();
        for (        Map.Entry<String,T> entry : members.entrySet()) {
          T v=entry.getValue();
          if (session.equals(v.getSession()) && state.getContainer().equals(v.getContainer())) {
            id=entry.getKey();
            return;
          }
        }
      }
      if (id == null) {
        id=client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL_SEQUENTIAL).forPath(path + "/0",encode(state));
      }
 else {
        try {
          client.setData().forPath(id,encode(state));
        }
 catch (        KeeperException.NoNodeException e) {
          id=client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL_SEQUENTIAL).forPath(path + "/0",encode(state));
        }
      }
    }
  }
}
