{
  socket.readStream().dataHandler(new Handler<Buffer>(){
    Buffer received=new Buffer();
    @Override public void handle(    Buffer event){
      received.appendBuffer(event);
      for (      final Protocol protocol : protocols) {
        if (protocol.matches(received)) {
          if ("http".equals(protocol.getProtocolName())) {
            InetSocketAddress target=getHttpGateway();
            if (target != null) {
              try {
                URI url=new URI("http://" + target.getHostString() + ":"+ target.getPort());
                LOG.info(String.format("Connecting '%s' to '%s:%d' using the http protocol",socket.remoteAddress(),url.getHost(),url.getPort()));
                createClient(socket,url,received);
                return;
              }
 catch (              URISyntaxException e) {
                LOG.warn("Could not build valid connect URI.",e);
                socket.close();
                return;
              }
            }
 else {
              LOG.info("No http gateway available for the http protocol");
              socket.close();
              return;
            }
          }
 else {
            protocol.snoopConnectionParameters(socket,received,new Handler<ConnectionParameters>(){
              @Override public void handle(              ConnectionParameters connectionParameters){
                if (connectionParameters.protocol == null)                 connectionParameters.protocol=protocol.getProtocolName();
                if (connectionParameters.protocolSchemes == null)                 connectionParameters.protocolSchemes=protocol.getProtocolSchemes();
                route(socket,connectionParameters,received);
              }
            }
);
            return;
          }
        }
      }
      if (received.length() >= maxProtocolIdentificationLength) {
        LOG.info("Connection did not use one of the enabled protocols " + getProtocolNames());
        socket.close();
      }
    }
  }
);
}
