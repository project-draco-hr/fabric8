{
  ZkGatewayConnector gatewayConnector=new ZkGatewayConnector();
  gatewayConnector.setCurator(getZooKeeper());
  gatewayConnector.setFabricService(getFabricService());
  gatewayConnector.setId(pid);
  if (StringUtils.hasText(properties.get("versionName"))) {
    gatewayConnector.setVersionName(properties.get("versionName"));
  }
  if (StringUtils.hasText(properties.get("profileName"))) {
    gatewayConnector.setProfileName(properties.get("profileName"));
  }
  if (StringUtils.hasText(properties.get("inboundDestinationsRef"))) {
    gatewayConnector.setInboundDestinations(createDestinationsConfig(pid,properties.get("inboundDestinationsRef")));
  }
  if (StringUtils.hasText(properties.get("outboundDestinationsRef"))) {
    gatewayConnector.setOutboundDestinations(createDestinationsConfig(pid,properties.get("outboundDestinationsRef")));
  }
  gatewayConnector.setLocalBrokerConfig(createBrokerConfig(pid,"localBroker",properties));
  gatewayConnector.setExportedBrokerConfig(createBrokerConfig(pid,"exportedBroker",properties));
  gatewayConnector.setApplicationContext(createApplicationContext(pid));
  try {
    gatewayConnector.afterPropertiesSet();
    gatewayConnector.start();
  }
 catch (  Exception e) {
    String msg="Error starting gateway " + pid + " : "+ e.getMessage();
    LOG.error(msg);
    throw new ConfigurationException("Start",msg,e);
  }
  return gatewayConnector;
}
