{
  System.err.println(executeCommand("fabric:create -n"));
  ServiceProxy<FabricService> fabricProxy=ServiceProxy.createServiceProxy(bundleContext,FabricService.class);
  try {
    FabricService fabricService=fabricProxy.getService();
    CuratorFramework curator=fabricService.adapt(CuratorFramework.class);
    Set<ContainerProxy> containers=ContainerBuilder.create(fabricProxy,2).withName("cnt").withProfiles("default").assertProvisioningResult().build();
    try {
      LinkedList<Container> containerList=new LinkedList<Container>(containers);
      Container broker=containerList.removeLast();
      setData(curator,ZkPath.CONTAINER_PROVISION_RESULT.getPath(broker.getId()),"changing");
      System.err.println(executeCommand("fabric:container-change-profile " + broker.getId() + " mq-default"));
      Provision.provisioningSuccess(Arrays.asList(new Container[]{broker}),PROVISION_TIMEOUT);
      System.err.println(executeCommand("fabric:cluster-list"));
      for (      Container c : containerList) {
        setData(curator,ZkPath.CONTAINER_PROVISION_RESULT.getPath(c.getId()),"changing");
        System.err.println(executeCommand("fabric:container-change-profile " + c.getId() + " example-mq"));
      }
      Provision.provisioningSuccess(containerList,PROVISION_TIMEOUT);
      System.err.println(executeCommand("fabric:cluster-list"));
      Assert.assertTrue(Provision.waitForCondition(Arrays.asList(new Container[]{broker}),new ContainerCondition(){
        @Override public Boolean checkConditionOnContainer(        final Container c){
          System.err.println(executeCommand("fabric:container-connect -u admin -p admin " + c.getId() + " activemq:bstat"));
          String output=executeCommand("fabric:container-connect -u admin -p admin " + c.getId() + " activemq:query -QQueue=FABRIC.DEMO");
          return output.contains("DequeueCount = ") && !output.contains("DequeueCount = 0");
        }
      }
,10000L));
    }
  finally {
      ContainerBuilder.destroy(containers);
    }
  }
  finally {
    fabricProxy.close();
  }
}
