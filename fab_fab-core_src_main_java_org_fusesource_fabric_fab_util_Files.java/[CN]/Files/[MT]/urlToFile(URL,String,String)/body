{
  HashSet<DownloadKey> original=ACTIVE_DOWNLOADS.get();
  HashSet<DownloadKey> downloads=original;
  if (downloads == null) {
    downloads=new HashSet<DownloadKey>();
    ACTIVE_DOWNLOADS.set(downloads);
  }
  try {
    DownloadKey key=new DownloadKey(url,tempFilePrefix,tempFilePostfix);
    if (downloads.contains(key)) {
      throw new IOException("The URL is being recursively downloaded: " + url);
    }
    downloads.add(key);
    try {
      String fileName=url.getFile();
      File file=new File(fileName);
      if (!file.exists()) {
        file=File.createTempFile(tempFilePrefix,tempFilePostfix);
        InputStream in=url.openStream();
        IOHelpers.writeTo(file,in);
      }
      return file;
    }
  finally {
      downloads.remove(key);
    }
  }
  finally {
    if (original == null) {
      ACTIVE_DOWNLOADS.remove();
    }
  }
}
