{
  while (true) {
    if (read_buffer.remaining() != 0) {
      int count=read_channel.read(read_buffer);
      if (count == -1) {
        throw new EOFException("Peer disconnected");
      }
 else       if (count == 0) {
        return null;
      }
      read_counter+=count;
    }
 else {
      read_buffer.flip();
      if (read_buffer.capacity() == 4) {
        int size=read_buffer.getInt(0);
        if (size < 4) {
          throw new ProtocolException("Expecting a size greater than 3");
        }
        if (size == 4) {
          Buffer rc=new Buffer(read_buffer);
          read_buffer=ByteBuffer.allocate(4);
          return rc;
        }
 else {
          ByteBuffer next=ByteBuffer.allocate(size);
          next.putInt(size);
          read_buffer=next;
        }
      }
 else {
        Buffer rc=new Buffer(read_buffer);
        read_buffer=ByteBuffer.allocate(4);
        return rc;
      }
    }
  }
}
