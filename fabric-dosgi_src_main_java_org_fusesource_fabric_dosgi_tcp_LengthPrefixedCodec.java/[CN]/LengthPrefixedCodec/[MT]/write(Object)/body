{
  if (isFull()) {
    return BufferState.FULL;
  }
 else {
    boolean wasEmpty=isEmpty();
    byte[] bytes=(byte[])value;
    if (next_write_buffer.remaining() < 4 + bytes.length) {
      int new_capacity=next_write_buffer.capacity() << 1;
      ByteBuffer new_buffer=ByteBuffer.allocate(new_capacity);
      new_buffer.put(next_write_buffer.array(),0,next_write_buffer.position());
      next_write_buffer=new_buffer;
    }
    next_write_buffer.putInt(bytes.length);
    next_write_buffer.put(bytes);
    return wasEmpty ? BufferState.WAS_EMPTY : BufferState.NOT_EMPTY;
  }
}
