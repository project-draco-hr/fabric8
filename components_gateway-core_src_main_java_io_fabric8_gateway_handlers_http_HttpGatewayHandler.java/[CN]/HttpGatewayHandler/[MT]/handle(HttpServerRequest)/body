{
  long callStart=System.nanoTime();
  String uri=request.uri();
  String uri2=null;
  if (!uri.endsWith("/")) {
    uri2=uri + "/";
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Proxying request: " + uri);
  }
  String remaining=null;
  String prefix=null;
  String proxyServiceUrl=null;
  String reverseServiceUrl=null;
  Map<String,MappedServices> mappingRules=httpGateway.getMappedServices();
  try {
    if (isMappingIndexRequest(request)) {
      String json=mappingRulesToJson(mappingRules);
      HttpServerResponse response=request.response();
      response.headers().set("ContentType","application/json");
      response.end(json);
      response.setStatusCode(200);
    }
 else {
      MappedServices mappedServices=null;
      URL clientURL=null;
      Set<Map.Entry<String,MappedServices>> entries=mappingRules.entrySet();
      for (      Map.Entry<String,MappedServices> entry : entries) {
        String path=entry.getKey();
        mappedServices=entry.getValue();
        String pathPrefix=path;
        if (uri.startsWith(pathPrefix) || (uri2 != null && uri2.startsWith(pathPrefix))) {
          int pathPrefixLength=pathPrefix.length();
          if (pathPrefixLength < uri.length()) {
            remaining=uri.substring(pathPrefixLength + 1);
          }
 else {
            remaining=null;
          }
          proxyServiceUrl=mappedServices.chooseService(request);
          if (proxyServiceUrl != null) {
            try {
              clientURL=new URL(proxyServiceUrl);
              if (client == null) {
                client=createClient(clientURL);
              }
              prefix=clientURL.getPath();
              reverseServiceUrl=request.absoluteURI().resolve(pathPrefix).toString();
              if (reverseServiceUrl.endsWith("/")) {
                reverseServiceUrl=reverseServiceUrl.substring(0,reverseServiceUrl.length() - 1);
              }
              break;
            }
 catch (            MalformedURLException e) {
              LOG.warn("Failed to parse URL: " + proxyServiceUrl + ". "+ e,e);
            }
          }
        }
      }
      if (client != null) {
        String servicePath=prefix != null ? prefix : "";
        if (servicePath.length() > 0 && !servicePath.endsWith("/")) {
          servicePath+="/";
        }
        if (remaining != null) {
          servicePath+=remaining;
        }
        LOG.info("Proxying request " + uri + " to service path: "+ servicePath+ " on service: "+ proxyServiceUrl+ " reverseServiceUrl: "+ reverseServiceUrl);
        final HttpClient finalClient=client;
        Handler<HttpClientResponse> responseHandler=new Handler<HttpClientResponse>(){
          public void handle(          HttpClientResponse clientResponse){
            if (LOG.isDebugEnabled()) {
              LOG.debug("Proxying response: " + clientResponse.statusCode());
            }
            request.response().setStatusCode(clientResponse.statusCode());
            request.response().headers().set(clientResponse.headers());
            request.response().setChunked(true);
            clientResponse.dataHandler(new Handler<Buffer>(){
              public void handle(              Buffer data){
                if (LOG.isDebugEnabled()) {
                  LOG.debug("3. Proxying response body:" + data);
                }
                request.response().write(data);
              }
            }
);
            clientResponse.endHandler(new VoidHandler(){
              public void handle(){
                request.response().end();
                if (LOG.isDebugEnabled()) {
                  LOG.debug("4. Response end");
                }
              }
            }
);
          }
        }
;
        if (mappedServices != null) {
          ProxyMappingDetails proxyMappingDetails=new ProxyMappingDetails(proxyServiceUrl,reverseServiceUrl,servicePath);
          responseHandler=mappedServices.wrapResponseHandlerInPolicies(request,responseHandler,proxyMappingDetails);
        }
        final HttpClientRequest clientRequest=client.request(request.method(),servicePath,responseHandler);
        clientRequest.headers().set(request.headers());
        clientRequest.setChunked(true);
        request.dataHandler(new Handler<Buffer>(){
          public void handle(          Buffer data){
            if (LOG.isDebugEnabled()) {
              LOG.debug("1. Proxying request body:" + data);
            }
            clientRequest.write(data);
          }
        }
);
        request.endHandler(new VoidHandler(){
          public void handle(){
            if (LOG.isDebugEnabled()) {
              LOG.debug("2. end of the request");
            }
            clientRequest.end();
          }
        }
);
      }
 else {
        LOG.info("Could not find matching proxy path for " + uri + " from paths: "+ mappingRules.keySet());
        request.response().setStatusCode(404);
        request.response().end();
      }
    }
    CallDetailRecord cdr=new CallDetailRecord(System.nanoTime() - callStart,null);
    httpGateway.addCallDetailRecord(cdr);
  }
 catch (  Throwable e) {
    LOG.error("Caught: " + e,e);
    CallDetailRecord cdr=new CallDetailRecord(System.nanoTime() - callStart,new Date() + ":" + e.getMessage());
    httpGateway.addCallDetailRecord(cdr);
    request.response().setStatusCode(404);
    StringWriter buffer=new StringWriter();
    e.printStackTrace(new PrintWriter(buffer));
    request.response().setStatusMessage("Error: " + e + "\nStack Trace: "+ buffer);
    request.response().close();
  }
}
