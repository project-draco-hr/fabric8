{
  executeCommand("fabric:create -n");
  FabricService service=getFabricService();
  CuratorFramework curator=getCurator();
  final ZooKeeperMultiGroup group=new ZooKeeperMultiGroup<FabricDiscoveryAgent.ActiveMQNode>(curator,"/fabric/registry/clusters/fusemq/default",FabricDiscoveryAgent.ActiveMQNode.class);
  group.start();
  FabricDiscoveryAgent.ActiveMQNode master=null;
  Provision.waitForCondition(new Callable<Boolean>(){
    @Override public Boolean call() throws Exception {
      while ((FabricDiscoveryAgent.ActiveMQNode)group.master() == null) {
        Thread.sleep(1000);
      }
      return true;
    }
  }
,30000L);
  master=(FabricDiscoveryAgent.ActiveMQNode)group.master();
  String masterContainer=master.getContainer();
  assertEquals("root",masterContainer);
  for (int i=0; i < 10; i++) {
    Thread.sleep(5000);
    executeCommand("container-remove-profile root jboss-fuse-full");
    Provision.waitForCondition(new Callable<Boolean>(){
      @Override public Boolean call() throws Exception {
        while ((FabricDiscoveryAgent.ActiveMQNode)group.master() != null) {
          Thread.sleep(1000);
        }
        return true;
      }
    }
,30000L);
    master=(FabricDiscoveryAgent.ActiveMQNode)group.master();
    assertNull(master);
    Thread.sleep(5000);
    executeCommand("container-add-profile root jboss-fuse-full");
    Provision.waitForCondition(new Callable<Boolean>(){
      @Override public Boolean call() throws Exception {
        while ((FabricDiscoveryAgent.ActiveMQNode)group.master() == null) {
          Thread.sleep(1000);
        }
        return true;
      }
    }
,30000L);
    master=(FabricDiscoveryAgent.ActiveMQNode)group.master();
    masterContainer=master.getContainer();
    assertEquals("root",masterContainer);
  }
}
