{
  BundleContext bundleContext=getBundleContext();
  ServiceTracker tracker=null;
  try {
    String flt;
    if (filter != null) {
      if (filter.startsWith("(")) {
        flt="(&(" + org.osgi.framework.Constants.OBJECTCLASS + "="+ type.getName()+ ")"+ filter+ ")";
      }
 else {
        flt="(&(" + org.osgi.framework.Constants.OBJECTCLASS + "="+ type.getName()+ ")("+ filter+ "))";
      }
    }
 else {
      flt="(" + org.osgi.framework.Constants.OBJECTCLASS + "="+ type.getName()+ ")";
    }
    Filter osgiFilter=FrameworkUtil.createFilter(flt);
    tracker=new ServiceTracker(bundleContext,osgiFilter,null);
    tracker.open(true);
    if (tracker.waitForService(timeout) == null) {
      throw new RuntimeException("Gave up waiting for service " + flt);
    }
  }
 catch (  InvalidSyntaxException e) {
    throw new IllegalArgumentException("Invalid filter",e);
  }
catch (  InterruptedException e) {
    throw new RuntimeException(e);
  }
 finally {
    tracker.close();
  }
}
