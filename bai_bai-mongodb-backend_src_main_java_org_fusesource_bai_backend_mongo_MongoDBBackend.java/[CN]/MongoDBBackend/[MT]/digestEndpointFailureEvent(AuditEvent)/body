{
  DBObject filter=new BasicDBObject("_id",ev.breadCrumbId);
  DBObject toUpdate=BasicDBObjectBuilder.start().push("$push").push("endpointFailures").append("endpointUri",ev.endpointURI).append("exception",ev.exception.toString()).append("timestamp",ev.timestamp).get();
  collectionFor(ev).update(filter,toUpdate);
  addCurrentRouteIdIfNeeded(ev,(DBObject)((DBObject)toUpdate.get("$push")).get("endpointFailures"));
  filter.put("exchanges.endpointUri",ev.endpointURI);
  filter.put("exchanges.exchangeId",ev.event.getExchange().getExchangeId());
  filter.put("exchanges.dispatchId",ev.event.getExchange().getProperty(AuditConstants.DISPATCH_ID,String.class));
  toUpdate=BasicDBObjectBuilder.start().push("$set").append("exchanges.$.status","failed").append("exchanges.$.failTimestamp",ev.timestamp).get();
  if (ev.exception != null) {
    ((BasicDBObject)toUpdate.get("$set")).put("exchanges.$.exception",ev.exception.toString());
  }
  collectionFor(ev).update(filter,toUpdate);
  filter.put("in.endpointUri",ev.endpointURI);
  filter.put("in.exchangeId",ev.event.getExchange().getExchangeId());
  filter.put("in.dispatchId",ev.event.getExchange().getProperty(AuditConstants.DISPATCH_ID,String.class));
  toUpdate=BasicDBObjectBuilder.start().push("$set").append("in.$.status","failed").append("in.$.failTimestamp",ev.timestamp).get();
  if (ev.exception != null) {
    ((BasicDBObject)toUpdate.get("$set")).put("in.$.exception",ev.exception.toString());
  }
  collectionFor(ev).update(filter,toUpdate);
}
