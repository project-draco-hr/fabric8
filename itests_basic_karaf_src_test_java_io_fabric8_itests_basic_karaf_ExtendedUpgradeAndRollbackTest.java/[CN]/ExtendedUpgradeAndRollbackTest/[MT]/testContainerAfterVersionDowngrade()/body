{
  System.out.println(CommandSupport.executeCommand("fabric:create --force --clean -n"));
  ModuleContext moduleContext=RuntimeLocator.getRequiredRuntime().getModuleContext();
  ServiceProxy<FabricService> fabricProxy=ServiceProxy.createServiceProxy(moduleContext,FabricService.class);
  try {
    FabricService fabricService=fabricProxy.getService();
    System.out.println(CommandSupport.executeCommand("fabric:version-create --parent 1.0 1.1"));
    System.out.println(CommandSupport.executeCommand("fabric:container-upgrade --all 1.1"));
    Set<Container> containers=ContainerBuilder.create().withName("basic.camelB").withProfiles("feature-camel").assertProvisioningResult().build(fabricService);
    try {
      System.out.println(CommandSupport.executeCommand("fabric:container-rollback --all 1.0"));
      ProvisionSupport.provisioningSuccess(containers,ProvisionSupport.PROVISION_TIMEOUT);
      for (      Container container : containers) {
        Assert.assertEquals("Container should have version 1.0","1.0",container.getVersion().getId());
        Assert.assertNotNull(ZooKeeperUtils.exists(ServiceLocator.awaitService(CuratorFramework.class),"/fabric/configs/versions/1.0/containers/" + container.getId()));
      }
    }
  finally {
      ContainerBuilder.stop(fabricService,containers);
    }
  }
  finally {
    fabricProxy.close();
  }
}
