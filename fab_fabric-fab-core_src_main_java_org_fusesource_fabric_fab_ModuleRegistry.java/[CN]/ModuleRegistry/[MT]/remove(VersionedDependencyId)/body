{
  VersionedModule versionedModule=moduleVersions.remove(id);
  if (versionedModule != null) {
    ModuleDescriptor descriptor=versionedModule.descriptor;
    for (    VersionedDependencyId key : descriptor.getExtendsModules()) {
      TreeMap<String,VersionedModule> map=extensions.get(key);
      if (map != null) {
        map.remove(versionedModule.getName());
        if (map.isEmpty()) {
          extensions.remove(key);
        }
      }
    }
    setEnabledExtensions(id,null);
    DependencyId dependencyId=id.toDependencyId();
    Module module=modules.get(dependencyId);
    if (module != null) {
      module.versions.remove(id.getVersion());
      if (module.versions.isEmpty()) {
        modules.remove(dependencyId);
      }
    }
  }
  return versionedModule;
}
