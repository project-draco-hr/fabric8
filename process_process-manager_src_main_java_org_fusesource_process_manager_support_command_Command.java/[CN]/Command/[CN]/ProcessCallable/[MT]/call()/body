{
  ProcessBuilder processBuilder=new ProcessBuilder(command.getCommand());
  processBuilder.directory(command.getDirectory());
  processBuilder.redirectErrorStream(true);
  Set<Map.Entry<String,String>> entries=command.getEnvironment().entrySet();
  for (  Map.Entry<String,String> entry : entries) {
    String name=entry.getKey();
    String value=entry.getValue();
    if (value != null && value.startsWith("$")) {
      String envVar=value.substring(1);
      value=System.getenv(envVar);
      if (value == null && name.equals("USER")) {
        value=System.getProperty("user.name","");
      }
    }
    processBuilder.environment().put(name,value);
  }
  final Process process;
  try {
    process=processBuilder.start();
  }
 catch (  IOException e) {
    throw new CommandFailedException(command,"failed to start",e);
  }
  OutputProcessor outputProcessor=null;
  try {
    outputProcessor=new OutputProcessor(process,executor);
    outputProcessor.start();
    int exitCode=process.waitFor();
    if (!command.getSuccessfulExitCodes().contains(exitCode)) {
      String out=outputProcessor.getOutput();
      throw new CommandFailedException(command,exitCode,out);
    }
    return exitCode;
  }
  finally {
    try {
      process.destroy();
    }
  finally {
      if (outputProcessor != null) {
        outputProcessor.destroy();
      }
    }
  }
}
