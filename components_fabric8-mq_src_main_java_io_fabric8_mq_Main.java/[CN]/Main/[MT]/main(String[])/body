{
  try {
    BrokerService brokerService=new BrokerService();
    brokerService.setBrokerName(brokerName);
    brokerService.setDataDirectory(dataDirectory);
    MBeanServer server=ManagementFactory.getPlatformMBeanServer();
    ManagementContext managementContext=new ManagementContext(server);
    managementContext.setCreateConnector(false);
    brokerService.setManagementContext(managementContext);
    List<BrokerPlugin> list=new ArrayList<>();
    list.add(new StatisticsBrokerPlugin());
    BrokerPlugin[] plugins=new BrokerPlugin[list.size()];
    list.toArray(plugins);
    brokerService.setPlugins(plugins);
    LevelDBStoreFactory persistenceFactory=new LevelDBStoreFactory();
    persistenceFactory.setDirectory(new File(getDataDirectory()));
    persistenceFactory.setSync(false);
    brokerService.setPersistenceFactory(persistenceFactory);
    long maxMemory=Runtime.getRuntime().maxMemory();
    long brokerMemory=(long)(maxMemory * 0.7);
    brokerService.getSystemUsage().getMemoryUsage().setLimit(brokerMemory);
    brokerService.addConnector("tcp://localhost:" + port);
    brokerService.start();
  }
 catch (  Throwable e) {
    LOG.error("Failed to Start Fabric8MQ",e);
  }
}
