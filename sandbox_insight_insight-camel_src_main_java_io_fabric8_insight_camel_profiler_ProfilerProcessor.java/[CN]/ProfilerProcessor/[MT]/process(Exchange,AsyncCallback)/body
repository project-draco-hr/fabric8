{
  if (!profiler.isEnabled(exchange)) {
    return processor.process(exchange,callback);
  }
  ExchangeData data=exchanges.get(exchange.getExchangeId());
  if (data == null) {
    data=new ExchangeData();
    exchanges.put(exchange.getExchangeId(),data);
    exchange.addOnCompletion(data);
  }
  final ExchangeData ed=data;
  ed.start(stats);
  try {
    return processor.process(exchange,new AsyncCallback(){
      @Override public void done(      boolean doneSync){
        ed.start(stats);
        try {
          callback.done(doneSync);
        }
  finally {
          if (ed.stop(stats)) {
            exchanges.remove(exchange.getExchangeId());
          }
        }
      }
    }
);
  }
  finally {
    if (ed.stop(stats)) {
      exchanges.remove(exchange.getExchangeId());
    }
  }
}
