{
  for (  Bundle bundle : systemBundleContext.getBundles()) {
    try {
      if (isUpdateable(bundle)) {
        org.fusesource.fabric.agent.mvn.Parser parser=new org.fusesource.fabric.agent.mvn.Parser(bundle.getLocation());
        String systemPath=SYSTEM_PATH + File.separator + parser.getArtifactPath().substring(4);
        String agentDownloadsPath=AGENT_DOWNLOAD_PATH + File.separator + parser.getArtifactPath().substring(4);
        long systemChecksum=0;
        long agentChecksum=0;
        try {
          systemChecksum=ChecksumUtils.checksum(new FileInputStream(systemPath));
        }
 catch (        Exception e) {
          LOGGER.debug("Error calculating checksum for file: %s",systemPath,e);
        }
        try {
          agentChecksum=ChecksumUtils.checksum(new FileInputStream(agentDownloadsPath));
        }
 catch (        Exception e) {
          LOGGER.debug("Error calculating checksum for file: %s",agentDownloadsPath,e);
        }
        long checksum=agentChecksum > 0 ? agentChecksum : systemChecksum;
        bundleChecksums.put(bundle.getLocation(),Long.toString(checksum));
      }
    }
 catch (    Exception e) {
      LOGGER.debug("Error creating checksum map.",e);
    }
  }
  bundleChecksums.save();
}
