{
  if (props == null) {
    return;
  }
  addMavenProxies(props);
  updateStatus("analyzing",null);
  final MavenConfigurationImpl config=new MavenConfigurationImpl(new DictionaryPropertyResolver(props,new PropertiesPropertyResolver(System.getProperties())),"org.ops4j.pax.url.mvn");
  config.setSettings(new MavenSettingsImpl(config.getSettingsFileUrl(),config.useFallbackRepositories()));
  manager=new DownloadManager(config,getDownloadExecutor());
  Map<String,String> properties=new HashMap<String,String>();
  for (Enumeration e=props.keys(); e.hasMoreElements(); ) {
    Object key=e.nextElement();
    Object val=props.get(key);
    if (!"service.pid".equals(key) && !FABRIC_ZOOKEEPER_PID.equals(key)) {
      properties.put(key.toString(),val.toString());
    }
  }
  boolean restart=false;
  Properties configProps=new Properties(new File(System.getProperty("karaf.base") + File.separator + "etc"+ File.separator+ "config.properties"));
  Properties systemProps=new Properties(new File(System.getProperty("karaf.base") + File.separator + "etc"+ File.separator+ "system.properties"));
  for (  String key : properties.keySet()) {
    if (key.equals("framework")) {
      String url=properties.get(key);
      restart|=updateFramework(configProps,url);
    }
 else     if (key.startsWith("config.")) {
      String k=key.substring("config.".length());
      String v=properties.get(key);
      if (!v.equals(configProps.get(k))) {
        configProps.put(k,v);
        restart=true;
      }
    }
 else     if (key.startsWith("system.")) {
      String k=key.substring("system.".length());
      String v=properties.get(key);
      if (!v.equals(systemProps.get(k))) {
        systemProps.put(k,v);
        restart=true;
      }
    }
  }
  if (restart) {
    updateStatus("restarting",null);
    configProps.save();
    systemProps.save();
    System.setProperty("karaf.restart","true");
    bundleContext.getBundle(0).stop();
    return;
  }
  Map<URI,Repository> repositories=new HashMap<URI,Repository>();
  for (  String key : properties.keySet()) {
    if (key.startsWith("repository.")) {
      String url=properties.get(key);
      if (url == null || url.length() == 0) {
        url=key.substring("repository.".length());
      }
      if (url != null && url.length() > 0) {
        URI uri=URI.create(url);
        addRepository(repositories,uri);
      }
    }
  }
  Set<Feature> features=new HashSet<Feature>();
  for (  String key : properties.keySet()) {
    if (key.startsWith("feature.")) {
      String name=properties.get(key);
      if (name == null || name.length() == 0) {
        name=key.substring("feature.".length());
      }
      Feature feature=search(name,repositories.values());
      if (feature == null) {
        throw new IllegalArgumentException("Unable to find feature " + name);
      }
      features.add(feature);
    }
  }
  Set<String> bundles=new HashSet<String>();
  for (  String key : properties.keySet()) {
    if (key.startsWith("bundle.")) {
      String url=properties.get(key);
      if (url == null || url.length() == 0) {
        url=key.substring("bundle.".length());
      }
      if (url != null && url.length() > 0) {
        bundles.add(url);
      }
    }
  }
  updateDeployment(repositories,features,bundles);
}
