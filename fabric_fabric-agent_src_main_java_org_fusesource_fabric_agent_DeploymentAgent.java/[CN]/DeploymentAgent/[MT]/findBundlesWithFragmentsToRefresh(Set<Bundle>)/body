{
  if (toRefresh.isEmpty()) {
    return;
  }
  Set<Bundle> bundles=new HashSet<Bundle>(Arrays.asList(systemBundleContext.getBundles()));
  bundles.removeAll(toRefresh);
  if (bundles.isEmpty()) {
    return;
  }
  for (  Bundle bundle : new ArrayList<Bundle>(toRefresh)) {
    BundleRevision rev=bundle.adapt(BundleRevision.class);
    if (rev != null) {
      for (      BundleRequirement req : rev.getDeclaredRequirements(null)) {
        if (BundleRevision.HOST_NAMESPACE.equals(req.getNamespace())) {
          for (          Bundle hostBundle : bundles) {
            if (!toRefresh.contains(hostBundle)) {
              BundleRevision hostRev=hostBundle.adapt(BundleRevision.class);
              if (hostRev != null) {
                for (                BundleCapability cap : hostRev.getDeclaredCapabilities(null)) {
                  if (req.matches(cap)) {
                    toRefresh.add(hostBundle);
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
