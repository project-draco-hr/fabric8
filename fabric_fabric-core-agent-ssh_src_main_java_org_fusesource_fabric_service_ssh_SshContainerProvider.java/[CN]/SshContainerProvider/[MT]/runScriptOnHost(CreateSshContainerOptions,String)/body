{
  Session session=null;
  Exception connectException=null;
  for (int i=0; i <= options.getSshRetries(); i++) {
    if (i > 0) {
      long delayMs=(long)(200L * Math.pow(i,2));
      Thread.sleep(delayMs);
    }
    try {
      JSch jsch=new JSch();
      byte[] privateKey=readFile(options.getPrivateKeyFile());
      byte[] passPhrase=options.getPassPhrase() != null ? options.getPassPhrase().getBytes() : null;
      if (privateKey != null && options.getPassword() == null) {
        jsch.addIdentity(options.getUsername(),privateKey,null,passPhrase);
        session=jsch.getSession(options.getUsername(),options.getHost(),options.getPort());
      }
 else {
        session=jsch.getSession(options.getUsername(),options.getHost(),options.getPort());
        session.setPassword(options.getPassword());
      }
      session.setTimeout(60000);
      java.util.Properties config=new java.util.Properties();
      config.put("StrictHostKeyChecking","no");
      config.put("PreferredAuthentications","publickey,password");
      session.setConfig(config);
      session.connect();
      connectException=null;
      break;
    }
 catch (    Exception from) {
      connectException=from;
      if (session != null && session.isConnected()) {
        session.disconnect();
      }
      session=null;
    }
  }
  if (connectException != null) {
    throw connectException;
  }
  ChannelExec executor=null;
  ByteArrayOutputStream output=new ByteArrayOutputStream();
  ByteArrayOutputStream error=new ByteArrayOutputStream();
  try {
    executor=(ChannelExec)session.openChannel("exec");
    executor.setPty(true);
    executor.setCommand(script);
    executor.setOutputStream(output);
    executor.setErrStream(error);
    executor.connect();
    int errorStatus=-1;
    for (int i=0; !executor.isClosed(); i++) {
      if (i > 0) {
        long delayMs=(long)(200L * Math.pow(i,2));
        Thread.sleep(delayMs);
      }
      if ((errorStatus=executor.getExitStatus()) != -1) {
        break;
      }
    }
    logger.debug("Output: {}",output.toString());
    logger.debug("Error:  {}",error.toString());
    if (verbose) {
      System.out.println("Output : " + output.toString());
      System.out.println("Error : " + error.toString());
    }
    if (errorStatus != 0) {
      throw new Exception(String.format("%s@%s:%d: received exit status %d executing \n--- command ---\n%s\n--- output ---\n%s\n--- error ---\n%s\n------\n",options.getUsername(),options.getHost(),options.getPort(),executor.getExitStatus(),script,output.toString(),error.toString()));
    }
  }
  finally {
    if (executor != null) {
      executor.disconnect();
    }
    session.disconnect();
  }
}
