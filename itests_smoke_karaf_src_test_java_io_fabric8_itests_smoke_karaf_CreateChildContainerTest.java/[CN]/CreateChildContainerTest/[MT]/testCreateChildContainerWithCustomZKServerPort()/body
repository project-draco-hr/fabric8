{
  System.err.println(CommandSupport.executeCommand("fabric:create --force --clean -n --zookeeper-server-port 2345"));
  System.err.println(CommandSupport.executeCommand("fabric:profile-create --parents default p1"));
  System.err.println(CommandSupport.executeCommand("fabric:profile-edit --features fabric-zookeeper-commands p1"));
  ModuleContext moduleContext=RuntimeLocator.getRequiredRuntime().getModuleContext();
  ServiceProxy<FabricService> fabricProxy=ServiceProxy.createServiceProxy(moduleContext,FabricService.class);
  try {
    FabricService fabricService=fabricProxy.getService();
    Set<Container> containers=ContainerBuilder.child(1).withName("smoke.childB").withProfiles("p1").build(fabricService);
    ProvisionSupport.provisioningSuccess(containers,ProvisionSupport.PROVISION_TIMEOUT);
    try {
      Container child=containers.iterator().next();
      String ensembleUrl=CommandSupport.executeCommand("fabric:container-connect -u admin -p admin " + child.getId() + " zk:get /fabric/configs/ensemble/url");
      Assert.assertTrue("Child should use custom ZK server port, but was: " + ensembleUrl,ensembleUrl.contains("${zk:root/ip}:2345"));
    }
  finally {
      ContainerBuilder.stop(fabricService,containers);
    }
  }
  finally {
    fabricProxy.close();
  }
}
