{
  DispatchPolicy resolvedPolicy=getResolvedPolicy(destination.getDispatchPolicy(),outboundDestinations.getDispatchPolicy());
  if (LOG.isDebugEnabled()) {
    LOG.debug("Resolved policy for destination " + destination + " is : "+ resolvedPolicy);
  }
  DefaultMessageListenerContainer listenerContainer;
  AbstractDeliveryHandler deliveryHandler=createDeliveryHandler(resolvedPolicy,(destination.getTargetName() != null) ? destination.getTargetName() : destination.getName(),destination.isPubSubDomain());
  if (resolvedPolicy.getBatchSize() <= 0 || resolvedPolicy.getBatchTimeout() <= 0) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Creating default message listener container for " + destination.getName());
    }
    listenerContainer=new DefaultMessageListenerContainer();
    configureListenerContainer(listenerContainer,resolvedPolicy,true,localBrokerConfig.getDestinationResolver());
    listenerContainer.setMessageListener(deliveryHandler);
  }
 else {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Creating batch message listener container for " + destination.getName());
    }
    listenerContainer=new BatchMessageListenerContainer();
    configureListenerContainer((BatchMessageListenerContainer)listenerContainer,resolvedPolicy,true,localBrokerConfig.getDestinationResolver());
    ((BatchMessageListenerContainer)listenerContainer).setBatchMessageListener(deliveryHandler);
  }
  listenerContainer.setConnectionFactory(localConnectionFactory);
  listenerContainer.setDestinationName(destination.getName());
  listenerContainer.setPubSubDomain(destination.isPubSubDomain());
  listenerContainer.setClientId(localBrokerConfig.getClientId());
  listenerContainer.setDurableSubscriptionName(destination.getDurableSubscriptionName());
  listenerContainer.setSubscriptionDurable(destination.isSubscriptionDurable());
  listenerContainer.afterPropertiesSet();
  return listenerContainer;
}
