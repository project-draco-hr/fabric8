{
  NetClient client=null;
  if (params.protocolVirtualHost == null) {
    params.protocolVirtualHost=defaultVirtualHost;
  }
  HashSet<String> schemes=new HashSet<String>(Arrays.asList(params.protocolSchemes));
  if (params.protocolVirtualHost != null) {
    List<ServiceDetails> services=serviceMap.getServices(params.protocolVirtualHost);
    if (services.isEmpty() && !params.protocolVirtualHost.equals(defaultVirtualHost)) {
      params.protocolVirtualHost=defaultVirtualHost;
      services=serviceMap.getServices(params.protocolVirtualHost);
    }
    LOG.debug(String.format("%d services match the virtual host",services.size()));
    if (!services.isEmpty()) {
      ClientRequestFacade clientRequestFacade=clientRequestFacadeFactory.create(socket,params);
      ServiceDetails serviceDetails=serviceLoadBalancer.choose(services,clientRequestFacade);
      if (serviceDetails != null) {
        List<String> urlStrings=serviceDetails.getServices();
        LOG.debug("Selected service exposes the following URLS: {}",urlStrings);
        for (        String urlString : urlStrings) {
          if (Strings.notEmpty(urlString)) {
            try {
              URI uri=new URI(urlString);
              String urlProtocol=uri.getScheme();
              if (schemes.contains(urlProtocol)) {
                LOG.info(String.format("Connecting '%s' requesting virtual host '%s' with client key '%s' to '%s:%d' using the %s protocol",socket.remoteAddress(),params.protocolVirtualHost,clientRequestFacade.getClientRequestKey(),uri.getHost(),uri.getPort(),params.protocol));
                client=createClient(socket,uri,received);
                break;
              }
            }
 catch (            URISyntaxException e) {
              LOG.warn("Failed to parse URI: " + urlString + ". "+ e,e);
            }
          }
        }
      }
    }
  }
  if (client == null) {
    LOG.info(String.format("No endpoint available for virtual host '%s' and protocol %s",params.protocolVirtualHost,params.protocol));
    socket.close();
  }
}
