{
  queue().execute(new Runnable(){
    public void run(){
      if (_serviceState == STARTED) {
        final STOPPING state=new STOPPING();
        state.add(onCompleted);
        _serviceState=state;
        _stop(new Runnable(){
          public void run(){
            _serviceState=STOPPED;
            state.done();
          }
        }
);
      }
 else       if (_serviceState instanceof STOPPING) {
        ((STOPPING)_serviceState).add(onCompleted);
      }
 else       if (_serviceState == STOPPED) {
        if (onCompleted != null) {
          onCompleted.run();
        }
      }
 else {
        if (onCompleted != null) {
          onCompleted.run();
        }
        LOG.error("stop should not be called from state: " + _serviceState);
      }
    }
  }
);
}
