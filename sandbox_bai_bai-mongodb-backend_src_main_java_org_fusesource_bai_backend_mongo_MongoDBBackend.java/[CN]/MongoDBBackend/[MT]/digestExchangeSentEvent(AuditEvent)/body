{
  DBObject filter=BasicDBObjectBuilder.start().append("_id",ev.getBreadCrumbId()).append("exchanges.endpointUri",ev.getEndpointURI()).append("exchanges.exchangeId",ev.getExchange().getExchangeId()).append("exchanges.dispatchId",ev.getEvent().getExchange().getProperty(AuditConstants.DISPATCH_ID,String.class)).get();
  DBObject toApply=BasicDBObjectBuilder.start().push("$set").append("exchanges.$.endTimestamp",ev.getTimestamp()).append("exchanges.$.status","finished").get();
  if (ev.getEvent().getExchange().getPattern() == ExchangePattern.InOut) {
    Object outBody=null;
    try {
      outBody=ev.getExchange().hasOut() ? ev.getExchange().getOut().getBody() : ev.getExchange().getIn().getBody();
      ((BasicDBObject)toApply.get("$set")).put("exchanges.$.out",convertPayload(outBody,ev.getExchange()));
    }
 catch (    Exception e) {
    }
  }
  collectionFor(ev).update(filter,toApply);
}
