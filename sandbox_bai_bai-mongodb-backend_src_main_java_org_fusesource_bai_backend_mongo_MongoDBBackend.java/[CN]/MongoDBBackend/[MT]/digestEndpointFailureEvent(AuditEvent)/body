{
  DBObject filter=new BasicDBObject("_id",ev.getBreadCrumbId());
  DBObject toUpdate=BasicDBObjectBuilder.start().push("$push").push("endpointFailures").append("endpointUri",ev.getEndpointURI()).append("exception",ev.getException().toString()).append("timestamp",ev.getTimestamp()).get();
  collectionFor(ev).update(filter,toUpdate);
  addCurrentRouteIdIfNeeded(ev,(DBObject)((DBObject)toUpdate.get("$push")).get("endpointFailures"));
  filter.put("exchanges.endpointUri",ev.getEndpointURI());
  filter.put("exchanges.exchangeId",ev.getEvent().getExchange().getExchangeId());
  filter.put("exchanges.dispatchId",ev.getEvent().getExchange().getProperty(AuditConstants.DISPATCH_ID,String.class));
  toUpdate=BasicDBObjectBuilder.start().push("$set").append("exchanges.$.status","failed").append("exchanges.$.failTimestamp",ev.getTimestamp()).get();
  if (ev.getException() != null) {
    ((BasicDBObject)toUpdate.get("$set")).put("exchanges.$.exception",ev.getException().toString());
  }
  collectionFor(ev).update(filter,toUpdate);
  filter.put("in.endpointUri",ev.getEndpointURI());
  filter.put("in.exchangeId",ev.getEvent().getExchange().getExchangeId());
  filter.put("in.dispatchId",ev.getEvent().getExchange().getProperty(AuditConstants.DISPATCH_ID,String.class));
  toUpdate=BasicDBObjectBuilder.start().push("$set").append("in.$.status","failed").append("in.$.failTimestamp",ev.getTimestamp()).get();
  if (ev.getException() != null) {
    ((BasicDBObject)toUpdate.get("$set")).put("in.$.exception",ev.getException().toString());
  }
  collectionFor(ev).update(filter,toUpdate);
}
