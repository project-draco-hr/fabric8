{
  StringBuilder sb=new StringBuilder();
  sb.append("function run { echo \"Running: $*\" ; $* ; rc=$? ; if [ \"${rc}\" -ne 0 ]; then echo \"Command failed\" ; exit ${rc} ; fi ; }\n");
  sb.append("run mkdir -p ").append(name).append("\n");
  sb.append("run cd ").append(name).append("\n");
  extractTargzIntoDirectory(sb,proxy,"org.apache.karaf","apache-karaf","2.2.0-fuse-00-43");
  sb.append("run cd ").append("apache-karaf-2.2.0-fuse-00-43").append("\n");
  List<String> lines=new ArrayList<String>();
  lines.add(downloadAndStartMavenBundle(sb,proxy,"org.codehaus.jackson","jackson-core-asl","1.8.4","jar") + "=60");
  lines.add(downloadAndStartMavenBundle(sb,proxy,"org.codehaus.jackson","jackson-mapper-asl","1.8.4","jar") + "=60");
  lines.add(downloadAndStartMavenBundle(sb,proxy,"org.codehaus.jackson","jackson-mapper-asl","1.8.4","jar") + "=60");
  lines.add(downloadAndStartMavenBundle(sb,proxy,"org.fusesource.fabric","fabric-linkedin-zookeeper","1.1-SNAPSHOT","jar") + "=60");
  lines.add(downloadAndStartMavenBundle(sb,proxy,"org.fusesource.fabric","fabric-zookeeper","1.1-SNAPSHOT","jar") + "=60");
  lines.add(downloadAndStartMavenBundle(sb,proxy,"org.fusesource.fabric","fabric-configadmin","1.1-SNAPSHOT","jar") + "=60");
  lines.add(downloadAndStartMavenBundle(sb,proxy,"org.fusesource.fabric","fabric-agent","1.1-SNAPSHOT","jar") + "=60");
  appendFile(sb,"etc/startup.properties",lines);
  replaceLineInFile(sb,"etc/system.properties","karaf.name=root","karaf.name = " + name);
  replaceLineInFile(sb,"etc/org.apache.karaf.shell.cfg","sshPort=8101","sshPort=" + sshPort);
  appendFile(sb,"etc/system.properties",Arrays.asList("zookeeper.url = " + zooKeeperUrl));
  if (debugAgent) {
    sb.append("run export KARAF_DEBUG=true").append("\n");
  }
  sb.append("run nohup bin/start").append("\n");
  return sb.toString();
}
