{
  unregisterDataStore();
  DataStorePlugin pluginDataStore=dataStorePlugins.get(type);
  if (pluginDataStore != null) {
    dataStore=pluginDataStore.getDataStore();
    Map<String,String> dataStoreProperties=new HashMap<String,String>();
    dataStoreProperties.putAll(configuration);
    dataStore.setDataStoreProperties(dataStoreProperties);
    dataStore.start();
    for (    DataStoreTemplate callback : registrationCallbacks) {
      registrationCallbacks.remove(callback);
      try {
        callback.doWith(dataStore);
      }
 catch (      Exception e) {
        throw new FabricException(e);
      }
    }
    Dictionary<String,String> properties=new Hashtable<String,String>();
    properties.put(DATASTORE_TYPE_PROPERTY,type);
    registration=bundleContext.registerService(DataStore.class,dataStore,properties);
    LOG.info("Registered DataStore " + dataStore + " with "+ properties);
  }
}
